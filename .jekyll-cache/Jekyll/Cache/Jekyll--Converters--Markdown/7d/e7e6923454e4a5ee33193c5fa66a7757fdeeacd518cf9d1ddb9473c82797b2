I"‹n<h2 id="databricks-vector-search">Databricks Vector Search</h2>
<p>Databricksì—ëŠ” ë²¡í„° ê²€ìƒ‰ì„ ìœ„í•œ ë²¡í„° ê²€ìƒ‰ ì—”ë“œí¬ì¸íŠ¸ ë° ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Databricksì˜ Unity Catalogì— ë“±ë¡ë˜ì—ˆìœ¼ë©° ChangeDataFeedê°€ í™œì„±í™”ëœ í…Œì´ë¸”ì— ëŒ€í•´ì„œë§Œ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆê³  Syncë¥¼ í†µí•´ í…Œì´ë¸” ì—…ë°ì´íŠ¸ì‹œ ì¸ë±ìŠ¤ë„ ê°™ì´ ì—…ë°ì´íŠ¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p>Semantic ê²€ìƒ‰ì„ ì§€ì›í•˜ê³  ìˆì§€ë§Œ BM25ì™€ ê°™ì€ Lexical Searchë„ í•¨ê»˜ ì§€ì›í•˜ê³  ìˆë‹¤ëŠ” ì ë„ ê°•ì ì´ì§€ë§Œ ì˜ ì•Œë ¤ì§€ì§€ ì•ŠëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì´ ê¸€ì—ì„  Vector searchì— ëŒ€í•´ ì •ë¦¬í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤.</p>

<h2 id="vector-search-endpoint">Vector Search Endpoint</h2>
<p>ë²¡í„° ì„œì¹˜ ì—”ë“œí¬ì¸íŠ¸ëŠ” ì¸ë±ìŠ¤ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ì¸ìŠ¤í„´ìŠ¤ ê°™ì€ ê°œë…ì…ë‹ˆë‹¤. ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì™¼ìª½ í•­ëª©ì—ì„œ Computeì— Vector Search íƒ­ì´ ìˆê³  ì—¬ê¸°ì— ìƒì„±í•œ ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡ì´ ë³´ì´ê²Œ ë˜ê³  ê° ì—”ë“œí¬ì¸íŠ¸ì—ëŠ” ìƒì„±í•œ ì¸ë±ìŠ¤ ëª©ë¡ë„ í•¨ê»˜ ë³´ì´ê²Œ ë©ë‹ˆë‹¤.</p>

<h2 id="vector-search-index">Vector Search Index</h2>
<p>ë²¡í„° ì„œì¹˜ ì¸ë±ìŠ¤ëŠ” ì„ë² ë”© ë²¡í„°ê°€ í¬í•¨ëœ ì¸ë±ìŠ¤ë¥¼ ë§í•©ë‹ˆë‹¤. ê¸°ì¡´ í…Œì´ë¸”ì—ì„œ ì„ë² ë”© ëŒ€ìƒì´ ë˜ëŠ” ì»¬ëŸ¼ì— ëŒ€í•œ ì„ë² ë”© ë²¡í„°ë¥¼ ìƒì„±í•´ì„œ <code class="language-plaintext highlighter-rouge">__db_review_vector</code>ë¼ëŠ” ì´ë¦„ì˜ ì»¬ëŸ¼ì— ì‚½ì…ë©ë‹ˆë‹¤. ì¸ë±ìŠ¤ë„ Unity Catalogì˜ ê´€ë¦¬ë¥¼ ë°›ê²Œ ë˜ê³  í…Œì´ë¸” ëª©ë¡ê³¼ í•¨ê»˜ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>

<h3 id="databricks-vectorsearch">databricks-vectorsearch</h3>
<p>Databricksì—ì„  ì›Œí¬ìŠ¤í˜ì´ìŠ¤ í™˜ê²½ì—ì„œ ë²¡í„° ì„œì¹˜ë¥¼ ì´ìš©í•  ìˆ˜ ìˆëŠ” íŒŒì´ì¬ ê¸°ë°˜ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì œê³µ ì¤‘ì— ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì„¤ì¹˜í•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%pip install databricks-vectorsearch
</code></pre></div></div>

<p>ì‚¬ìš©ë²•ì€ ê°„ë‹¨í•©ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">databricks.vector_search.client</span> <span class="kn">import</span> <span class="n">VectorSearchClient</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">VectorSearchClient</span><span class="p">()</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">endpoint_name</span><span class="o">=</span><span class="s">"vector_search_endpoint"</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s">"{catalog}.{schema}.{index_name}"</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">similarity_search</span><span class="p">(</span>
    <span class="n">query_text</span><span class="o">=</span><span class="s">"Their Outback Oatmeal and Austin Almond Biscotti were dry and flavorless."</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"review"</span><span class="p">],</span>
    <span class="n">num_results</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Output
{
    'manifest': {'column_count': 2, 'columns': [{'name': 'review'}, {'name': 'score'}]},
    'result': {
        'row_count': 5,
        'data_array': [
            ["Bakehouse in Wynwood, Miami, has disappointed me. ... I expected more from a renowned cookie company.", 0.9040976460331299],
            ...
        ]
    }
}
</code></pre></div></div>
<p>similarity_searchì˜ ê¸°ë³¸ê°’ì€ ANNì´ê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">query_type</code>ì— ì•„ë¬´ëŸ° ê°’ì„ ì£¼ì§„ ì•Šì•˜ë‹¤ë©´ Semantic Searchê°€ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.</p>

<p>ì´ë¦„ì´ ë²¡í„° ì„œì¹˜ì´ê¸° ë•Œë¬¸ì— Semantic Searchë§Œ ì§€ì›í•˜ëŠ” ê±´ê°€ ì‹¶ì§€ë§Œ ì‚¬ì‹¤ ê·¸ë ‡ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. Lexical Searchë§Œ ì´ìš©í•  ìˆ˜ë„ ìˆê³  Semantic Searchì™€ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” Hybrid Searchë„ ì§€ì›í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">databricks.vector_search.client</span> <span class="kn">import</span> <span class="n">VectorSearchClient</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">VectorSearchClient</span><span class="p">()</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">endpoint_name</span><span class="o">=</span><span class="s">"vector_search_endpoint"</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s">"{catalog}.{schema}.{index_name}"</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">similarity_search</span><span class="p">(</span>
    <span class="n">query_text</span><span class="o">=</span><span class="s">"Their Outback Oatmeal and Austin Almond Biscotti were dry and flavorless."</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"review"</span><span class="p">],</span>
    <span class="n">num_results</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">query_type</span><span class="o">=</span><span class="s">"FULL_TEXT"</span><span class="p">,</span> <span class="c1"># bm25
</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">similarity_search</span><span class="p">(</span>
    <span class="n">query_text</span><span class="o">=</span><span class="s">"Their Outback Oatmeal and Austin Almond Biscotti were dry and flavorless."</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"review"</span><span class="p">],</span>
    <span class="n">num_results</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">query_type</span><span class="o">=</span><span class="s">"hybrid"</span><span class="p">,</span> <span class="c1"># hybrid
</span><span class="p">)</span>
</code></pre></div></div>
<p>ë‹¨, Hybrid Searchì˜ ê²½ìš° RRF(Reciprocal Rank Fusion) ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤. ë§Œì•½, CC(Convex Combination)ë¥¼ ì ìš©í•˜ê³  ì‹¶ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">query_type</code>ì„ <code class="language-plaintext highlighter-rouge">FULL_TEXT</code>ì™€ <code class="language-plaintext highlighter-rouge">ANN</code>ìœ¼ë¡œ ê°ê° ê²€ìƒ‰í•˜ì—¬ ìŠ¤ì½”ì–´ ì •ê·œí™”ë¥¼ ê±°ì³ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<p>CCëŠ” ê°„ë‹¨í•˜ê²Œ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_cc_ensemble_results</span><span class="p">(</span><span class="n">lexical</span><span class="p">,</span> <span class="n">semantic</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">max_scores</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">lexical_results</span><span class="p">[</span><span class="s">'result'</span><span class="p">][</span><span class="s">'data_array'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> 
        <span class="n">semantic_results</span><span class="p">[</span><span class="s">'result'</span><span class="p">][</span><span class="s">'data_array'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">lexical_search</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">lexical_results</span><span class="p">[</span><span class="s">'result'</span><span class="p">][</span><span class="s">'data_array'</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">semantic_search</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">semantic_results</span><span class="p">[</span><span class="s">'result'</span><span class="p">][</span><span class="s">'data_array'</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="k">assert</span> <span class="n">lexical_search</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">semantic_search</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span>

    <span class="n">ensemble_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lexical_doc</span><span class="p">,</span> <span class="n">semantic_doc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lexical</span><span class="p">,</span> <span class="n">semantic</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">lexical_doc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">semantic_doc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ensemble_results</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">lexical_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">score</span><span class="p">])</span>
    <span class="n">ensemble_results</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ensemble_results</span>

<span class="n">cc_ensemble_results</span> <span class="o">=</span> <span class="n">get_cc_ensemble_results</span><span class="p">(</span><span class="n">lexical_search</span><span class="p">,</span> <span class="n">semantic_search</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">cc_ensemble_results</span><span class="p">)</span>
</code></pre></div></div>

<p>ì¶”ê°€ì ìœ¼ë¡œ, debug_level=1ì„ ë„£ì–´ì£¼ë©´ debug_infoë¼ëŠ” í•„ë“œê°€ ì¶”ê°€ë˜ë©´ì„œ ì²˜ë¦¬ ì‹œê°„ì´ ë‚˜íƒ€ëŠ”ë° <code class="language-plaintext highlighter-rouge">query_type</code>ì— ë”°ë¼ ë‹¬ë¼ì§€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># query_type=ann
</span><span class="s">'debug_info'</span><span class="p">:</span> <span class="p">{</span><span class="s">'response_time'</span><span class="p">:</span> <span class="mf">321.0</span><span class="p">,</span> <span class="s">'ann_time'</span><span class="p">:</span> <span class="mf">98.0</span><span class="p">,</span> <span class="s">'embedding_gen_time'</span><span class="p">:</span> <span class="mf">215.0</span><span class="p">}</span>

<span class="c1"># query_type=FULL_TEXT
</span><span class="s">'debug_info'</span><span class="p">:</span> <span class="p">{</span><span class="s">'response_time'</span><span class="p">:</span> <span class="mf">22.0</span><span class="p">,</span> <span class="s">'ann_time'</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">}</span>

<span class="c1"># query_type=hybrid
</span><span class="s">'debug_info'</span><span class="p">:</span> <span class="p">{</span><span class="s">'response_time'</span><span class="p">:</span> <span class="mf">364.0</span><span class="p">,</span> <span class="s">'ann_time'</span><span class="p">:</span> <span class="mf">96.0</span><span class="p">,</span> <span class="s">'embedding_gen_time'</span><span class="p">:</span> <span class="mf">260.0</span><span class="p">}</span>
</code></pre></div></div>

<p>ì´ debug_infoë¥¼ ë³´ë©´ lexical searchì—ì„œ ann_timeì´ë¼ëŠ” í•„ë“œê°€ ë‚˜ì˜¤ëŠ” ê²ƒìœ¼ë¡œ ë´ì„œ bm25 ì•Œê³ ë¦¬ì¦˜ì´ ì•„ë‹ ìˆ˜ ìˆëƒëŠ” ì˜ë¬¸ì´ ë“¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë‚´ë¶€ ì²˜ë¦¬ ë¡œì§ì„ ë³¼ ìˆ˜ëŠ” ì—†ì–´ì„œ ìì„¸íˆëŠ” ì•Œ ìˆ˜ ì—†ì§€ë§Œ ì œ ìƒê°ìœ¼ë¡œëŠ” ì‘ë‹µ ì‹œê°„ ìì²´ê°€ ë§¤ìš° ì§§ì•„ì„œ bm25 ì•Œê³ ë¦¬ì¦˜ì€ ë§ê³  ì¶œë ¥ì— ê°™ì€ í•„ë“œë¥¼ ì‚¬ìš©í•´ì„œ ì €ëŸ° ê²°ê³¼ê°€ ë‚˜ì˜¨ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<h3 id="reranker">Reranker</h3>
<p>databricks-vectorsearchì—ì„  rerankerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì˜µì…˜ë„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. ë¬¸ì„œì—ë„ ì„¤ëª…ë˜ì–´ ìˆê³  ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì¤„ë¡œ ì•Œê³  ìˆëŠ”ë° Databricks Free-edition ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„  ì§€ì›í•˜ì§€ ì•Šì•„ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Private Previewë¼ë˜ê°€ í•˜ëŠ” ì•ˆë‚´ë„ ì—†ì–´ì„œ ì•„ë§ˆ ì—”í„°í”„ë¼ì´ì¦ˆ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„  ê°€ëŠ¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì‚¬ìš©ë²•ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">databricks.vector_search.client</span> <span class="kn">import</span> <span class="n">VectorSearchClient</span>
<span class="kn">from</span> <span class="nn">databricks.vector_search.reranker</span> <span class="kn">import</span> <span class="n">DatabricksReranker</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">VectorSearchClient</span><span class="p">()</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">endpoint_name</span><span class="o">=</span><span class="s">"vector_search_endpoint"</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s">"{catalog}.{schema}.{index_name}"</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">similarity_search</span><span class="p">(</span>
  <span class="n">query_text</span><span class="o">=</span><span class="s">"Their Outback Oatmeal and Austin Almond Biscotti were dry and flavorless."</span><span class="p">,</span>
  <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"review"</span><span class="p">],</span>
  <span class="n">num_results</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
  <span class="n">query_type</span><span class="o">=</span><span class="s">"full_text"</span><span class="p">,</span>
  <span class="n">reranker</span><span class="o">=</span><span class="n">DatabricksReranker</span><span class="p">(</span>
      <span class="n">columns_to_rerank</span><span class="o">=</span><span class="p">[</span><span class="s">"review"</span><span class="p">]</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>ë§Œì•½, ìœ„ì™€ ê°™ì€ ê¸°ëŠ¥ì„ ì—”í„°í”„ë¼ì´ì¦ˆ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œë„ ì‚¬ìš©ì´ ë¶ˆê°€í•˜ë‹¤ë©´ Reranker ëª¨ë¸ì„ ì§ì ‘ MLflow ëª¨ë¸ë¡œ ë“±ë¡í•˜ê³  Serving Endpointë¡œ ë°°í¬í•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì‚¬ìš©í•œ ëª¨ë¸ì€ â€˜cross-encoder/ms-marco-MiniLM-L6-v2â€™ì…ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.pyfunc</span>
<span class="kn">from</span> <span class="nn">mlflow.models.signature</span> <span class="kn">import</span> <span class="n">infer_signature</span>

<span class="kn">from</span> <span class="nn">sentence_transformers</span> <span class="kn">import</span> <span class="n">CrossEncoder</span>

<span class="k">def</span> <span class="nf">_patch_stream_isatty</span><span class="p">():</span> <span class="c1"># isatty ì—ëŸ¬ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš©í–ˆì§€ë§Œ í”¼í•˜ëŠ” ë²•ì„ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤
</span>    <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">"stdout"</span><span class="p">,</span> <span class="s">"stderr"</span><span class="p">):</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">"isatty"</span><span class="p">):</span>
            <span class="n">stream</span><span class="p">.</span><span class="n">isatty</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">CrossEncoderModel</span><span class="p">(</span><span class="n">mlflow</span><span class="p">.</span><span class="n">pyfunc</span><span class="p">.</span><span class="n">PythonModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>

    <span class="k">def</span> <span class="nf">load_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">_patch_stream_isatty</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">CrossEncoder</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">model_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">model_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model_input</span><span class="p">).</span><span class="n">tolist</span><span class="p">()</span>


<span class="n">input_example</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s">"How many people live in Berlin?"</span><span class="p">,</span> <span class="s">"Berlin had a population of 3,520,031 registered inhabitants in an area of 891.82 square kilometers."</span><span class="p">],</span>
    <span class="p">[</span><span class="s">"How many people live in Berlin?"</span><span class="p">,</span> <span class="s">"Berlin is well known for its museums."</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">output_example</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">8.1875</span><span class="p">,</span> <span class="mf">5.26171875</span><span class="p">]</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">infer_signature</span><span class="p">(</span><span class="n">input_example</span><span class="p">,</span> <span class="n">output_example</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="p">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="n">mlflow</span><span class="p">.</span><span class="n">pyfunc</span><span class="p">.</span><span class="n">log_model</span><span class="p">(</span> <span class="c1"># logì™€ ë™ì‹œì— registerê¹Œì§€ ìˆ˜í–‰
</span>        <span class="n">python_model</span><span class="o">=</span><span class="n">CrossEncoderModel</span><span class="p">(</span><span class="s">"cross-encoder/ms-marco-MiniLM-L6-v2"</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"ms-marco-MiniLM-L6-v2"</span><span class="p">,</span>
        <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
        <span class="n">input_example</span><span class="o">=</span><span class="n">input_example</span><span class="p">,</span>
        <span class="n">registered_model_name</span><span class="o">=</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">catalog</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s">.ms-marco-MiniLM-L6-v2"</span> <span class="p">,</span>
        <span class="n">pip_requirements</span><span class="o">=</span><span class="p">[</span>
            <span class="s">"sentence-transformers==5.2.2"</span><span class="p">,</span>
            <span class="s">"torch==2.10.0"</span><span class="p">,</span>
            <span class="s">"transformers==5.1.0"</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>MLflow Modelë¡œ ë“±ë¡í•œ ë’¤ Serving Endpointë¡œ ë“±ë¡í•˜ë©´ ìƒì„±ëœ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì…ë ¥ì„ ë³´ë‚´ Scoreë¥¼ ë°›ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">mlflow.deployments</span>
<span class="n">documents</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s">'result'</span><span class="p">][</span><span class="s">'data_array'</span><span class="p">]]</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">mlflow</span><span class="p">.</span><span class="n">deployments</span><span class="p">.</span><span class="n">get_deploy_client</span><span class="p">(</span><span class="s">"databricks"</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">endpoint</span><span class="o">=</span><span class="s">"ms-marco-MiniLM-L6-v2"</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s">"inputs"</span><span class="p">:</span> <span class="p">[[</span><span class="s">"Their Outback Oatmeal was dry and flavorless."</span><span class="p">,</span> <span class="n">doc</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]}</span>
<span class="p">)</span>

<span class="n">reranked</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([[</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s">'predictions'</span><span class="p">])],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">reranked</span><span class="p">)</span>
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ, DatabricksëŠ” Vector Searchë¼ëŠ” ê°•ë ¥í•œ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì œê³µí•˜ê³  ì‹¤ì œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, Search ê¸°ëŠ¥ì„ ì ìš©í•˜ë ¤ëŠ” ë„ë©”ì¸ì— ë”°ë¼ ê²€ìƒ‰ ë°©í–¥ì„ ë‹¤ë¥´ê²Œ ì¡ì•„ì•¼ ì›í•˜ëŠ” ì„±ëŠ¥ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<ul>
  <li>ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¡œ ê²€ìƒ‰ ì¿¼ë¦¬ì™€ ë¬¸ì„œê°€ ë¬¸ë§¥ ê´€ê³„ê°€ ë†’ë‹¤ë©´ Semantic Search ë¹„ì¤‘ì„ í¬ê²Œ ì£¼ì–´ì•¼ í•˜ê³  ì „ë¬¸ì ì¸ ë‹¨ì–´ê°€ ìì£¼ ë“±ì¥í•˜ë©´ Lexical Search ë¹„ì¤‘ì„ í¬ê²Œ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<p>Vector SearchëŠ” ë‹¤ì–‘í•œ ë„ë©”ì¸ì— ì ìš©í•  ìˆ˜ ìˆë„ë¡ ì˜µì…˜ì„ ì œê³µí•˜ê³  ìˆìœ¼ë©° Rerankerë¥¼ ì¶”ê°€ë¡œ ì‚¬ìš©í•˜ì—¬ ê²€ìƒ‰ ìˆœìœ„ë¥¼ ì¬ì •ë ¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>
:ET