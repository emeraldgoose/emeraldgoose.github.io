I"̽<h2 id="reranker">Reranker</h2>
<p>문서 검색 과정에서 문서를 임베딩 벡터로 변환하는 과정과 검색 시간 단축을 위해 Approximate Nearest Neighbor search(ANNs)와 같이 근사 기법으로 인해 정보 손실이 발생합니다. 
이로 인해 필요한 문서가 누락될 가능성이 있으며, 이를 보완하기 위해 가져오는 문서의 개수 k를 조정할 수 있습니다. 그러나 문서의 순위가 낮아질 수 있으며, LLM이 해당 문서를 참조하지 않거나 LLM 토큰 비용이 증가하는 비효율적인 상황이 발생하게 됩니다. 
이를 해결하기 위해 Reranker를 도입하여 Retriever가 가져온 문서와 사용자 질문 간의 관련성을 측정하여 보다 연관성이 높은 문서의 순위를 조정하는 방법을 활용할 수 있습니다.</p>

<h2 id="opensearch-machine-learning">Opensearch Machine Learning</h2>
<p>RAG 시스템에 Reranker를 추가하려면 AWS Sagemaker와 같은 클라우드 서비스를 이용해 모델을 배포하거나 Cohere.ai와 같은 상용 서비스를 사용하는 방법이 있지만 비용이 추가됩니다. 
Opensearch는 클러스터에 직접 아티팩트를 배포하고 사용할 수 있는 기능을 지원하고 있습니다. 
만약 Opensearch 클러스터를 운영하고 있다면 대안으로 클러스터에 직접 아티팩트를 배포할 수 있고 REST API를 통해 모델을 사용할 수 있습니다. 또한, 파이프라인에 포함시킬 수도 있습니다.</p>

<h3 id="settings">Settings</h3>
<p>프로덕션 환경에서의 Opensearch의 ML 작업은 ML 노드에서 실행하는 것을 추천합니다. 
프로덕션 환경이라면 아래 쿼리에서 <code class="language-plaintext highlighter-rouge">plugins.ml_commons.only_run_on_ml_node: true</code>로 설정합니다. 그렇지 않다면 아무 노드에서나 ml 작업을 할 수 있도록 <code class="language-plaintext highlighter-rouge">false</code>로 설정합니다. 
<code class="language-plaintext highlighter-rouge">native_memory_threshold</code> 옵션은 ML작업을 하는데 메모리 사용률 한계를 설정할 수 있습니다. 100이면 아무런 제한도 하지 않는 것이고 90이라면 90%까지 허용하며 넘어가는 경우 에러를 일으키게 됩니다. 클러스터 자원에 따라 자유롭게 조정합니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_cluster/settings</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"persistent"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"plugins.ml_commons.only_run_on_ml_node"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"plugins.ml_commons.model_access_control_enabled"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"plugins.ml_commons.native_memory_threshold"</span><span class="p">:</span><span class="w"> </span><span class="s2">"99"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="register-a-model-group">Register a model group</h3>
<p>ML 모델을 배포하기 전에 모델 그룹을 먼저 등록해야 합니다. 모델 그룹의 역할은 모델 버전을 관리하고 접근 제어에 활용됩니다. 
모델 그룹을 등록하려면 다음 요청을 보내야 합니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/_plugins/_ml/model_groups/_register</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"local_model_group"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A model group for local models"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>요청이 올바르게 전달되었다면 다음의 응답을 받게 됩니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"model_group_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"wlcnb4kBJ1eYAeTMHlV6"</span><span class="p">,</span><span class="w">
 </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CREATED"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="register-a-model">Register a model</h3>
<p>모델을 등록하는 단계입니다. 
Opensearch에서 제공하는 pretrained model 또는 Custom model를 등록할 수 있습니다. 
Custom model인 경우, torchscript 또는 ONNX로 변환되어 있어야 합니다. 
저는 Opensearch에서 제공하는 Reranking 모델인 <code class="language-plaintext highlighter-rouge">cross-encoders/ms-marco-MiniLM-L-12-v2</code>를 배포하겠습니다.</p>

<p>아래 요청에서 <code class="language-plaintext highlighter-rouge">model_group_id는</code> 위에서 등록된 <code class="language-plaintext highlighter-rouge">model_group_id</code>와 같아야 합니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/_plugins/_ml/models/_register</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cross-encoders/ms-marco-MiniLM-L-12-v2"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.2"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The model can be used for Information Retrieval: Given a query, encode the query will all possible passages (e.g. retrieved with ElasticSearch). Then sort the passages in a decreasing order."</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"model_group_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"wlcnb4kBJ1eYAeTMHlV6"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"model_format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TORCH_SCRIPT"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"function_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TEXT_SIMILARITY"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"model_task_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TEXT_SIMILARITY"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"model_content_hash_value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"628183b3d249dd45b82626972828125f7ad98c3b11c0ef1f2261c575600102d6"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"model_config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"model_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bert"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"embedding_dimension"</span><span class="p">:</span><span class="w"> </span><span class="mi">384</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"framework_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"huggingface_transformers"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"all_config"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">_name_or_path</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">cross-encoder/ms-marco-MiniLM-L-6-v2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">architectures</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\n</span><span class="s2">    </span><span class="se">\"</span><span class="s2">BertForSequenceClassification</span><span class="se">\"\n</span><span class="s2">  ],</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">attention_probs_dropout_prob</span><span class="se">\"</span><span class="s2">: 0.1,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">classifier_dropout</span><span class="se">\"</span><span class="s2">: null,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">gradient_checkpointing</span><span class="se">\"</span><span class="s2">: false,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">hidden_act</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">gelu</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">hidden_dropout_prob</span><span class="se">\"</span><span class="s2">: 0.1,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">hidden_size</span><span class="se">\"</span><span class="s2">: 384,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">id2label</span><span class="se">\"</span><span class="s2">: {</span><span class="se">\n</span><span class="s2">    </span><span class="se">\"</span><span class="s2">0</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">LABEL_0</span><span class="se">\"\n</span><span class="s2">  },</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">initializer_range</span><span class="se">\"</span><span class="s2">: 0.02,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">intermediate_size</span><span class="se">\"</span><span class="s2">: 1536,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">label2id</span><span class="se">\"</span><span class="s2">: {</span><span class="se">\n</span><span class="s2">    </span><span class="se">\"</span><span class="s2">LABEL_0</span><span class="se">\"</span><span class="s2">: 0</span><span class="se">\n</span><span class="s2">  },</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">layer_norm_eps</span><span class="se">\"</span><span class="s2">: 1e-12,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">max_position_embeddings</span><span class="se">\"</span><span class="s2">: 512,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">model_type</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">bert</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">num_attention_heads</span><span class="se">\"</span><span class="s2">: 12,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">num_hidden_layers</span><span class="se">\"</span><span class="s2">: 6,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">pad_token_id</span><span class="se">\"</span><span class="s2">: 0,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">position_embedding_type</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">absolute</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">sbert_ce_default_activation_function</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">torch.nn.modules.linear.Identity</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">transformers_version</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">4.22.1</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">type_vocab_size</span><span class="se">\"</span><span class="s2">: 2,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">use_cache</span><span class="se">\"</span><span class="s2">: true,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">vocab_size</span><span class="se">\"</span><span class="s2">: 30522</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n</span><span class="s2">"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"created_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1676073973126</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://artifacts.opensearch.org/models/ml-models/huggingface/cross-encoders/ms-marco-MiniLM-L-12-v2/1.0.2/torch_script/cross-encoders_ms-marco-MiniLM-L-12-v2-1.0.2-torch_script.zip"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>요청이 올바르게 전달되었으면 아래와 같은 응답을 받게 됩니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"task_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cVeMb4kBJ1eYAeTMFFgj"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CREATED"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>task_id를 이용해 태스크 상태를 조회할 수 있습니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /_plugins/_ml/tasks/cVeMb4kBJ1eYAeTMFFgj
</code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cleMb4kBJ1eYAeTMFFg4"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"task_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"REGISTER_MODEL"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TEXT_SIMILARITY"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COMPLETED"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"worker_node"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"XPcXLV7RQoi5m8NI_jEOVQ"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1689793598499</span><span class="p">,</span><span class="w">
  </span><span class="nl">"last_update_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1689793598530</span><span class="p">,</span><span class="w">
  </span><span class="nl">"is_async"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>조회 결과로 <code class="language-plaintext highlighter-rouge">model_id</code>가 없고 state가 <code class="language-plaintext highlighter-rouge">CREATED</code> 상태라면 아직 아티팩트를 다운로드 받고 있는 것이므로 기다려야 합니다. 
state가 <code class="language-plaintext highlighter-rouge">FAILED</code>라면 <code class="language-plaintext highlighter-rouge">error</code>가 응답에 포함됩니다. 
완료되었다면 <code class="language-plaintext highlighter-rouge">model_id</code>를 따로 메모합니다.</p>

<h3 id="deploy-a-model">Deploy a model</h3>
<p>모델 인덱스로부터 읽어와 메모리에 모델을 적재하는 단계입니다. 
모델을 메모리에 올리기 위해 다음의 요청을 실행합니다. 
/models 다음에는 위 단계에서의 등록된 <code class="language-plaintext highlighter-rouge">model_id</code>를 넣어줍니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /_plugins/_ml/models/{model_id}/_deploy
</code></pre></div></div>
<p>이전처럼 응답으로부터 task_id를 받을 수 있는데 마찬가지로 태스크를 조회할 수 있습니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"task_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vVePb4kBJ1eYAeTM7ljG"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CREATED"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /_plugins/_ml/tasks/vVePb4kBJ1eYAeTM7ljG
</code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cleMb4kBJ1eYAeTMFFg4"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"task_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DEPLOY_MODEL"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TEXT_EMBEDDING"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COMPLETED"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"worker_node"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"n-72khvBTBi3bnIIR8FTTw"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1689793851077</span><span class="p">,</span><span class="w">
  </span><span class="nl">"last_update_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1689793851101</span><span class="p">,</span><span class="w">
  </span><span class="nl">"is_async"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>배포 도중이라면 state가 <code class="language-plaintext highlighter-rouge">RUNNING</code>일 것이고 완료되었다면 위와 같이 <code class="language-plaintext highlighter-rouge">COMPLETED</code>로 표시됩니다.</p>

<p>모델 배포가 완료되었다면 Opensearch Dashboard에서 모델 리스트를 확인할 수 있습니다. <strong>Opensearch plugins &gt; Machine Learning</strong> 탭에서 다음의 사진처럼 모델 목록을 확인할 수 있습니다.</p>

<figure>
    <img src="https://opensearch.org/docs/latest/images/ml/ml-dashboard/deployed-models.png" alt="01" style="max-width: 100%; height: auto;" />
    <figcaption>Opensearch Dashboard Machine Learning (refs: https://opensearch.org/docs/latest/ml-commons-plugin/ml-dashboard/)</figcaption>
</figure>

<p>배포가 완료되었다면 Status에 Responding이라고 표시됩니다.</p>

<h3 id="reranker-predict">Reranker Predict</h3>
<p>모델을 사용할 때는 아래의 요청을 보내야 합니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">_plugins/_ml/models/&lt;model_id&gt;/_predict</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"query_text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"today is sunny"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"text_docs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"how are you"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"today is sunny"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"today is july fifth"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"it is winter"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>이 요청의 응답으로 다음과 같이 오게 됩니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"inference_results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"output"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"similarity"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"data_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FLOAT32"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"shape"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mf">-6.077798</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"byte_buffer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"array"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Un3CwA=="</span><span class="p">,</span><span class="w">
            </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LITTLE_ENDIAN"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"output"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"similarity"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"data_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FLOAT32"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"shape"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mf">10.223609</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"byte_buffer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"array"</span><span class="p">:</span><span class="w"> </span><span class="s2">"55MjQQ=="</span><span class="p">,</span><span class="w">
            </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LITTLE_ENDIAN"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"output"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"similarity"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"data_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FLOAT32"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"shape"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mf">-1.3987057</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"byte_buffer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"array"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ygizvw=="</span><span class="p">,</span><span class="w">
            </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LITTLE_ENDIAN"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"output"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"similarity"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"data_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FLOAT32"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"shape"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mf">-4.5923924</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"byte_buffer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"array"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4fSSwA=="</span><span class="p">,</span><span class="w">
            </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LITTLE_ENDIAN"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>만약 <code class="language-plaintext highlighter-rouge">opensearchpy</code>라이브러리를 이용하고 있다면 아래의 코드로 구현할 수 있습니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">opensearchpy</span> <span class="kn">import</span> <span class="n">OpenSearch</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Opensearch</span><span class="p">(</span>
    <span class="n">hosts</span><span class="o">=</span><span class="p">[{</span><span class="s">'host'</span><span class="p">:</span><span class="s">'localhost'</span><span class="p">,</span><span class="s">'port'</span><span class="p">:</span><span class="mi">9200</span><span class="p">}],</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"query_text"</span><span class="p">:</span> <span class="s">"today is sunny"</span><span class="p">,</span>
    <span class="s">"text_docs"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">"how are you"</span><span class="p">,</span>
        <span class="s">"today is sunny"</span><span class="p">,</span>
        <span class="s">"today is july fifth"</span><span class="p">,</span>
        <span class="s">"it is winter"</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">perform_request</span><span class="p">(</span>
    <span class="n">method</span><span class="o">=</span><span class="s">'POST'</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s">'/_plugins/_ml/models/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s">/_predict'</span><span class="p">,</span>
    <span class="n">body</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>실제로 모델을 돌려보면서 payload의 구성이 궁금해서 opensearch-project github를 찾아봤습니다. 
predict 요청을 보내면 Request를 처리하는데 MLInput 클래스에 사용자 입력들이 들어가게 됩니다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// opensearch-project/ml-commons/blob/main/common/src/main/java/org/opensearch/ml/common/input/MLInput.java</span>

<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MLInput</span> <span class="kd">implements</span> <span class="nc">Input</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ALGORITHM_FIELD</span> <span class="o">=</span> <span class="s">"algorithm"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ML_PARAMETERS_FIELD</span> <span class="o">=</span> <span class="s">"parameters"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">INPUT_INDEX_FIELD</span> <span class="o">=</span> <span class="s">"input_index"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">INPUT_QUERY_FIELD</span> <span class="o">=</span> <span class="s">"input_query"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">INPUT_DATA_FIELD</span> <span class="o">=</span> <span class="s">"input_data"</span><span class="o">;</span>

    <span class="c1">// For trained model</span>
    <span class="c1">// Return bytes in model output</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RETURN_BYTES_FIELD</span> <span class="o">=</span> <span class="s">"return_bytes"</span><span class="o">;</span>
    <span class="c1">// Return bytes in model output. This can be used together with return_bytes.</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RETURN_NUMBER_FIELD</span> <span class="o">=</span> <span class="s">"return_number"</span><span class="o">;</span>
    <span class="c1">// Filter target response with name in model output</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TARGET_RESPONSE_FIELD</span> <span class="o">=</span> <span class="s">"target_response"</span><span class="o">;</span>
    <span class="c1">// Filter target response with position in model output</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TARGET_RESPONSE_POSITIONS_FIELD</span> <span class="o">=</span> <span class="s">"target_response_positions"</span><span class="o">;</span>
    <span class="c1">// Input text sentences for text embedding model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TEXT_DOCS_FIELD</span> <span class="o">=</span> <span class="s">"text_docs"</span><span class="o">;</span>
    <span class="c1">// Input query text to compare against for text similarity model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUERY_TEXT_FIELD</span> <span class="o">=</span> <span class="s">"query_text"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PARAMETERS_FIELD</span> <span class="o">=</span> <span class="s">"parameters"</span><span class="o">;</span>

    <span class="c1">// Input question in question answering model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUESTION_FIELD</span> <span class="o">=</span> <span class="s">"question"</span><span class="o">;</span>

    <span class="c1">// Input context in question answering model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CONTEXT_FIELD</span> <span class="o">=</span> <span class="s">"context"</span><span class="o">;</span>

    <span class="c1">// Algorithm name</span>
    <span class="kd">protected</span> <span class="nc">FunctionName</span> <span class="n">algorithm</span><span class="o">;</span>
    <span class="c1">// ML algorithm parameters</span>
    <span class="kd">protected</span> <span class="nc">MLAlgoParams</span> <span class="n">parameters</span><span class="o">;</span>
    <span class="c1">// Input data to train model, run trained model to predict or run ML algorithms(no-model-based) directly.</span>
    <span class="kd">protected</span> <span class="nc">MLInputDataset</span> <span class="n">inputDataset</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</code></pre></div></div>
<p>만약에 다른 모델을 사용할 때 필요한 field를 위에 있는 field 이름을 요청에 포함하면 됩니다.</p>

<h3 id="한국어-문서로-테스트">한국어 문서로 테스트</h3>
<p>한국어 문서를 이용해 테스트를 진행했습니다. 경제 관련 문서들이 저장되어 있고 아래 쿼리를 이용해 결과를 확인했습니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">Lexical</span><span class="w"> </span><span class="err">Search</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"must"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024 하반기 은행 가계대출 변화량을 설명해봐"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"minimum_should_match"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0%"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"operator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"or"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">Lexical</span><span class="w"> </span><span class="err">Search</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">Rerank</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"must"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024 하반기 은행 가계대출 변화량을 설명해봐"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"minimum_should_match"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0%"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"operator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"or"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"ext"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rerank"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query_context"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"query_text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024 하반기 은행 가계대출 변화량을 설명해봐"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Rerank를 쿼리로 사용하려면 pipeline 정의가 필요합니다. 저는 아래 요청을 통해 파이프라인을 정의했습니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/_search/pipeline/rerank_pipeline</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"response_processors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"rerank"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"ml_opensearch"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"model_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{model_id}"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"context"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"document_fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"{passage_text_field}"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>그 결과로 아래 이미지와 같이 Lexical search만 사용한 결과와 Rerank 모델을 같이 사용한 결과가 다름을 알 수 있습니다. 
왼쪽은 Lexical search만 사용한 결과이고 오른쪽은 Lexical search + Rerank를 사용한 결과입니다.
아래 이미지처럼 왼쪽의 4위에 위치한 문서가 Reranker로 인해 1위로 올라오는 것처럼 순위를 재조정한 결과를 볼 수 있습니다.</p>

<figure class="half">
  <a href="https://lh3.googleusercontent.com/d/1j5YfrSJw9SLLRQlorbGL3optQR9gJg_D" onclick="return false;" data-lightbox="gallery">
    <img src="https://lh3.googleusercontent.com/d/1j5YfrSJw9SLLRQlorbGL3optQR9gJg_D" alt="02" style="max-width: 100%; height: auto;" />
  </a>
  <a href="https://lh3.googleusercontent.com/d/1SrB8HE_f5oo60dNTwXPBH1Yskyu3I9O4" onclick="return false;" data-lightbox="gallery">
    <img src="https://lh3.googleusercontent.com/d/1SrB8HE_f5oo60dNTwXPBH1Yskyu3I9O4" alt="02" style="max-width: 100%; height: auto;" />
  </a>
  <figcaption>사실 ms-marco-minilm-l-12-v2 모델은 영어만 지원하는데 어떻게 원하는 문서의 순위가 올라갔는지는 잘 모르겠습니다</figcaption>
</figure>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://aws.amazon.com/ko/blogs/tech/korean-reranker-rag/">한국어 Reranker를 활용한 검색 증강 생성(RAG) 성능 올리기</a></li>
  <li><a href="https://github.com/aws-samples/aws-ai-ml-workshop-kr/tree/master/genai/aws-gen-ai-kr/20_applications/02_qa_chatbot">Retrieval-Augmented Generation (RAG) for Large Language Models on AWS</a></li>
  <li><a href="https://opensearch.org/docs/latest/ml-commons-plugin/">Opensearch docs - Machine learning</a></li>
</ul>
:ET