I"íb<blockquote>
  <p>ë¶€ìº  ë•Œ ì—ëŸ¬ë¡œ ì‚¬ìš©ëª»í•œ airflowë¥¼ ì´ì œì„œì•¼ ì²´í—˜í•´ë³¸ ê²ƒì„ ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤. (ë¬´ì§€ì„± ì£¼ì˜)</p>
</blockquote>

<h2 id="airflow-ì‹œì‘">airflow ì‹œì‘</h2>
<p>ë°ì´í„° ì—”ì§€ë‹ˆì–´ë§ ë„êµ¬ì¸ airflowë¥¼ ë¡œì»¬ì— ì„¤ì¹˜í•œ í›„ ëª‡ê°€ì§€ë¥¼ ì‚´í´ë³´ì•˜ëŠ”ë° airflowëŠ” ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ í•¨ìˆ˜ ë‹¨ìœ„ë‚˜ ìŠ¤í¬ë¦½íŠ¸ ë‹¨ìœ„ë¡œ ì‹¤í–‰ì‹œì¼œì£¼ëŠ” ë„êµ¬ë¼ëŠ” ê²ƒì„ ê¹¨ë‹«ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.<br />
ê·¸ë ‡ë‹¤ë©´ ë°ì´í„°ë¥¼ ìƒì„±í•´ì„œ ìŠ¤ì¼€ì¤„ë§ì„ ëŒë¦¬ì!ë¼ëŠ” ìƒê°ì´ ë“¤ì–´ ì¬ë°Œì–´ë³´ì—¬ì„œ ë°”ë¡œ ì‹¤í–‰ì— ì˜®ê²¼ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì–´ë–¤ ë°ì´í„°ë¥¼ ìƒì„±í•´ì•¼ í•˜ë‚˜?ë¼ëŠ” ìƒê°ì— ê¸°ì—…ì´ë¼ë©´ ë¡œê·¸ë“¤ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì €ë„ ê°„ë‹¨í•œ ë¡œê·¸ë¥¼ ìƒì„±í•´ì„œ dbì— ë„£ëŠ” ê²ƒ ê¹Œì§€ í•´ë³¼ ìƒê°ì´ì—ˆìŠµë‹ˆë‹¤.</p>

<h3 id="ë°ì´í„°-í˜•íƒœ">ë°ì´í„° í˜•íƒœ</h3>
<p>ì‹¤ì œ ë¡œê·¸ë“¤ì„ ë³´ë©´ ë§ì€ ì–‘ì˜ ì •ë³´ê°€ ë“¤ì–´ìˆì§€ë§Œ ê°„ë‹¨í•˜ê²Œ ìƒì„±í•  ìƒê°ì´ë¯€ë¡œ (íƒ€ì„ìŠ¤íƒ¬í”„, level, ë©”ì‹œì§€, id, ì˜¤ë¥˜ check)ë¡œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">{"timestamp": 1641699997.0480268, "level": "ERROR", "id": 23, "message": "An unexpected error occurred.", "check": 0}</code></p>

<p>checkí•­ëª©ì€ 10%ì˜ í™•ë¥ ë¡œ ì˜¤ë¥˜ì¸ê²½ìš° checkì— 1ì´ ë“¤ì–´ê°€ë„ë¡ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” ì¢€ ë” ë³µì¡í•œ ë°ì´í„° ê²€ì¦ì„ í•˜ê² ì§€ë§Œ ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ì—ëŸ¬ì¸ì§€ ì•„ë‹Œì§€ í™•ì¸í•˜ëŠ” ì •ë„ë§Œ í™•ì¸í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>

<h2 id="ë°ì´í„°-ìƒì„±">ë°ì´í„° ìƒì„±</h2>
<p>ê°ì¢… ì„œë²„ì—ì„œ ìƒì„±ëœ ë¡œê·¸ë“¤ì€ í•œ ê³³ì— ëª¨ì•„ì§€ê±°ë‚˜ ì–´ëŠì •ë„ ë¶„ì‚°ëœ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì „ë‹¬ë˜ëŠ”ë° ì—¬ê¸°ëŠ” ë©”ì‹œì§€ í(Message Queue, MQ)ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë“¤ì´ ë©”ì‹œì§€ íë¡œ ë“¤ì–´ê°€ ì—ì–´í”Œë¡œìš° workerë“¤ì´ íì—ì„œ í•˜ë‚˜ì”© ë¹¼ì™€ì„œ ì—ëŸ¬ ì²´í¬í•œ í›„ dbì— ë„£ì–´ì£¼ëŠ” ê²ƒì„ ìƒê°í–ˆìŠµë‹ˆë‹¤.<br />
ë©”ì‹œì§€ íëŠ” RabbitMQ, Redis ë“±ì´ ìˆëŠ”ë° ì–´ë””ì„œ ë“¤ì–´ë³¸ Redisë¥¼ ì‚¬ìš©í•´ì„œ íë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤. <a href="https://blog.naver.com/wideeyed/221370229153">ë§í¬</a>ì—ì„œ ì½”ë“œë“¤ì„ ê°€ì ¸ì™€ ì½”ë“œë“¤ì„ ë‹¤ì‹œ ì¬êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># producer.py
</span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">redisqueue</span> <span class="kn">import</span> <span class="n">RedisQueue</span>
<span class="kn">from</span> <span class="nn">constant</span> <span class="kn">import</span> <span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">REDIS_PORT</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">RedisQueue</span><span class="p">(</span><span class="s">'my-queue'</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="s">'INFO'</span><span class="p">,</span> <span class="s">'WARNING'</span><span class="p">,</span> <span class="s">'ERROR'</span><span class="p">]</span>
<span class="n">message</span> <span class="o">=</span> <span class="p">[</span><span class="s">'All passed.'</span><span class="p">,</span> <span class="s">'Incorrect access'</span><span class="p">,</span> <span class="s">'An unexpected error occurred.'</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="c1"># message put
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">cur_time</span> <span class="o">=</span> <span class="s">'{"timestamp":'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="s">'}'</span>
        <span class="n">element</span>  <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cur_time</span><span class="p">)</span>

        <span class="c1"># Add Your Own Data
</span>        <span class="n">ridx</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rndn</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">element</span><span class="p">[</span><span class="s">'level'</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span>
        <span class="n">element</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">element</span><span class="p">[</span><span class="s">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span>
        <span class="n">element</span><span class="p">[</span><span class="s">'check'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">rndn</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="n">element_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">element_str</span><span class="p">)</span>
        <span class="n">q</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">element_str</span><span class="p">)</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
</code></pre></div></div>
<p>ë¨¼ì €, <code class="language-plaintext highlighter-rouge">producer.py</code>ëŠ” ë¡œê·¸ë¥¼ ìƒì„±í•˜ëŠ” íŒŒì¼ì…ë‹ˆë‹¤. ëœë¤ìœ¼ë¡œ [â€˜INFOâ€™, â€˜WARNINGâ€™, â€˜ERRORâ€™]ë¥¼ ì„ íƒí•˜ê²Œ í•˜ê³  ê·¸ì— ë§ëŠ” ë©”ì‹œì§€ë„ í¬í•¨ì‹œí‚¤ë„ë¡ í–ˆìŠµë‹ˆë‹¤. ì—ëŸ¬ëŠ” ìœ„ì—ì„œ ë§í•œëŒ€ë¡œ 10%ì˜ í™•ë¥ ë¡œ ì¼ì–´ë‚˜ê³  json í¬ë§· í˜•íƒœë¡œ íì— ë“¤ì–´ê°€ê³  1ì´ˆë§ˆë‹¤ ìƒì„±í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>

<h2 id="redis-ì„¸íŒ…">Redis ì„¸íŒ…</h2>
<p>Redisë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ Redisê°€ ëŒì•„ê°€ëŠ” ì„œë²„ë¥¼ ëŒë ¤ì•¼ í•˜ëŠ”ë° ì°¸ê³ í•œ ë¸”ë¡œê·¸ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ë„ì»¤ë¥¼ ì´ìš©í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤. ì´í›„ì— airflowê¹Œì§€ ë„ì»¤ë¡œ ëŒë¦´ ìƒê°ì´ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. (ì‚¬ì‹¤ ë§¥ë¶ ìš©ëŸ‰ì´ ì–¼ë§ˆ ì•ˆë‚¨ì•˜ìŠµë‹ˆë‹¤. ì¡°ë§Œê°„ í¬ë§·í•´ì•¼â€¦)
ë„ì»¤ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™€ì•¼ í•˜ëŠ”ë° ì €ëŠ” ë¸”ë¡œê·¸ì™€ ë˜‘ê°™ì´ redis:latest ìœ„ì—ì„œ ì‘ì—…í–ˆìŠµë‹ˆë‹¤. dockerfileì„ ë§Œë“¤ì§€ëŠ” ì•Šê³  ì»¨í…Œì´ë„ˆ ìœ„ì—ì„œ ì„¤ì¹˜í–ˆìŠµë‹ˆë‹¤.</p>

<p>ë¨¼ì €, redis-serverë¼ëŠ” ì´ë¦„ì˜ ì»¨í…Œì´ë„ˆì—ì„œ 6379ë²ˆ í¬íŠ¸ë¥¼ ì—´ì–´ì„œ redis ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.
<code class="language-plaintext highlighter-rouge">docker run --name redis-server -p 6379:6379 -it redis:latest /bin/bash</code></p>

<p>redis ì„œë²„ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ host ì£¼ì†Œì™€ í¬íŠ¸ë²ˆí˜¸ë¥¼ ì•Œì•„ì•¼ í•˜ëŠ”ë° ì´ë¥¼ ìœ„í•´ ifconfigë¥¼ ì„¤ì¹˜í•  ê²ƒì…ë‹ˆë‹¤.<br />
<code class="language-plaintext highlighter-rouge">apt-get update &amp;&amp; apt-get install net-tools &amp;&amp; ifconfig</code>
ê·¸ëŸ¬ë©´ eth0ì— 172.17.0.xì˜ ì£¼ì†Œê°€ ë³´ì´ëŠ”ë° ì´ê²ƒì„ ê¸°ë¡í•´ë†“ìœ¼ë©´ ë©ë‹ˆë‹¤.</p>

<ul>
  <li>ë‚˜ì¤‘ì— ì•Œì•˜ëŠ”ë° vscì—ì„œ ë„ì»¤ ìµìŠ¤í…ì…˜ì„ ì„¤ì¹˜í•œ í›„ bridgeì—ì„œ ê²€ì‚¬ë¥¼ ëˆ„ë¥´ë©´ ì—´ëŸ¬ìˆëŠ” ë„ì»¤ë“¤ì˜ ì£¼ì†Œë“¤ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">redis-server</code>ì‹¤í–‰í•˜ê²Œ ë˜ë©´ redis ì„œë²„ê°€ ì‹¤í–‰ë˜ë©´ì„œ ì„¸íŒ…ì€ ëë‚˜ê²Œ ë©ë‹ˆë‹¤.</p>

<h3 id="redis-client-ì„¸íŒ…">Redis-client ì„¸íŒ…</h3>
<p>ì´ ì»¨í…Œì´ë„ˆëŠ” <code class="language-plaintext highlighter-rouge">producer.py</code>ë¥¼ ì‹¤í–‰ì‹œì¼œ ë¡œê·¸ë¥¼ ìƒì„±í•´ íì— ë©”ì‹œì§€ë¥¼ ë„£ëŠ” ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤. python ì´ë¯¸ì§€ ìœ„ì—ì„œ redisë¥¼ ì„¤ì¹˜í•˜ë©´ ëë‚©ë‹ˆë‹¤. ì§ì ‘ ì‹¤í–‰ì‹œì¼œë„ ë˜ê³  watch ëª…ë ¹ì–´ë¡œ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ì‹œì¼œë„ ë©ë‹ˆë‹¤.</p>

<h2 id="airflow-ì„¸íŒ…">Airflow ì„¸íŒ…</h2>
<p>airflowëŠ” ì´ì „ì— ì„¸íŒ…í•œ ê²½í—˜ì´ ìˆì–´ì„œ ë¹„êµì  ì‰½ê²Œ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì´ë²ˆì—ëŠ” python ì´ë¯¸ì§€ ìœ„ì—ì„œ ì‘ì—…í–ˆìŠµë‹ˆë‹¤.<br />
<code class="language-plaintext highlighter-rouge">docker run --name airflow-server -p 8080:8080 -it python:3.7.0 /bin/bash</code><br />
ì €ëŠ” <code class="language-plaintext highlighter-rouge">-v</code>ì˜µì…˜ì„ í†µí•´ì„œ file sharingì„ í™œì„±í™”í–ˆìŠµë‹ˆë‹¤. ì´ ì˜µì…˜ì„ ì„ íƒí•˜ë©´ ë¡œì»¬ì— ìˆëŠ” í´ë”ì—ì„œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ íŒŒì¼ì„ ì‰½ê²Œ ì˜®ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. vscë¡œ ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ <code class="language-plaintext highlighter-rouge">cp</code>ëª…ë ¹ì–´ë¡œ ì—…ë°ì´íŠ¸ê¹Œì§€ í¸í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ë¨¼ì €, airflowëŠ” airflow webserverì™€ airflow schedulerë¥¼ ë™ì‹œì— ì‹¤í–‰ì‹œì¼œì•¼ í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ screenì„ ì´ìš©í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.
<code class="language-plaintext highlighter-rouge">apt-get update &amp;&amp; apt-get install screen</code></p>

<p><code class="language-plaintext highlighter-rouge">AIRFLOW_HOME</code>ì„ ë¹„ë¡¯í•´ DB ì´ˆê¸°í™”, Admin ê³„ì •ì„ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤. ì´ì œ screenìœ¼ë¡œ ì„œë²„ì™€ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ëŒë ¤ì¤ë‹ˆë‹¤. ìŠ¤í¬ë¦°ì—ì„œ ë¹ ì ¸ë‚˜ì˜¤ëŠ” í‚¤ëŠ” <code class="language-plaintext highlighter-rouge">ctrl+a+d</code>ì…ë‹ˆë‹¤.<br />
<code class="language-plaintext highlighter-rouge">screen -S airflow-scheduler</code><br />
<code class="language-plaintext highlighter-rouge">airflow scheduler</code><br />
<code class="language-plaintext highlighter-rouge">screen -S airflow-server</code><br />
<code class="language-plaintext highlighter-rouge">airflow webserver -p 8080</code></p>

<h2 id="dagì‘ì„±">Dagì‘ì„±</h2>
<p>airflowê°€ ëŒì•„ê°€ëŠ” ì»¨í…Œì´ë„ˆì—ì„œ <code class="language-plaintext highlighter-rouge">AIRFLOW_HOME</code> ìœ„ì¹˜ì—ì„œ <code class="language-plaintext highlighter-rouge">mkdir dags</code>ë¡œ dagë¥¼ ë„£ì–´ì¤„ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.<br />
dagëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•©ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># func.py
</span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">sqlite3.dbapi2</span> <span class="kn">import</span> <span class="n">Error</span>
<span class="kn">from</span> <span class="nn">redisqueue</span> <span class="kn">import</span> <span class="n">RedisQueue</span>
<span class="kn">from</span> <span class="nn">constant</span> <span class="kn">import</span> <span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">REDIS_PORT</span>

<span class="k">def</span> <span class="nf">consumer</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">RedisQueue</span><span class="p">(</span><span class="s">'my-queue'</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">isBlocking</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">msg_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_json</span><span class="p">[</span><span class="s">'check'</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'sqltie.db'</span><span class="p">)</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
                    <span class="n">_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">msg_json</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">]))</span> \
                        <span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M:%S'</span><span class="p">)</span>
                    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="s">"INSERT INTO table </span><span class="se">\
</span><span class="s">                        (time, level, id) VALUES (?,?,?)"</span><span class="p">,</span>
                        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_date</span><span class="p">),</span><span class="n">msg_json</span><span class="p">[</span><span class="s">'level'</span><span class="p">],</span><span class="n">msg_json</span><span class="p">[</span><span class="s">'id'</span><span class="p">]))</span>
            <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">con</span><span class="p">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>          
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<p>ìœ„ì˜ ì½”ë“œì—ì„œ <code class="language-plaintext highlighter-rouge">isBlocking=True</code>ë¡œ ë‘ë©´ íê°€ ë¹„ì–´ìˆì„ ë•Œ ë¬´í•œì • ëŒ€ê¸°í•œë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤. Falseë¡œ ë‘ì–´ì„œ íê°€ ë¹„ì–´ìˆìœ¼ë©´ íƒœìŠ¤í¬ë¥¼ ëë‚´ë„ë¡ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mydags.py
</span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>

<span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="nn">airflow.utils.dates</span> <span class="kn">import</span> <span class="n">days_ago</span>
<span class="kn">from</span> <span class="nn">airflow.operators.bash</span> <span class="kn">import</span> <span class="n">BashOperator</span>
<span class="kn">from</span> <span class="nn">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>

<span class="kn">from</span> <span class="nn">func</span> <span class="kn">import</span> <span class="n">consumer</span>

<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span>
    <span class="n">dag_id</span><span class="o">=</span><span class="s">'data_collector'</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s">'My dag'</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">days_ago</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">,</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="s">"0 0/5 * * *"</span><span class="p">,</span> <span class="c1"># 5ë¶„ê°„ê²©
</span>    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s">'my_dags'</span><span class="p">],</span>
    <span class="n">concurrency</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s">'start_schedule'</span><span class="p">,</span>
        <span class="n">bash_command</span><span class="o">=</span><span class="s">'echo START DATA COLLECTOR'</span><span class="p">,</span>
        <span class="n">owner</span><span class="o">=</span><span class="s">'gooose'</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">retry_delay</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s">'collector_0'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">consumer</span><span class="p">,</span>
        <span class="n">depends_on_past</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">owner</span><span class="o">=</span><span class="s">'goooose'</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">retry_delay</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">t3</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s">'collector_1'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">consumer</span><span class="p">,</span>
        <span class="n">depends_on_past</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">owner</span><span class="o">=</span><span class="s">'goooose'</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">retry_delay</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">t4</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s">'collector_2'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">consumer</span><span class="p">,</span>
        <span class="n">depends_on_past</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">owner</span><span class="o">=</span><span class="s">'goose'</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">retry_delay</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">t5</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s">'end_schedule'</span><span class="p">,</span>
        <span class="n">bash_command</span><span class="o">=</span><span class="s">'echo END DATA COLLECTOR'</span><span class="p">,</span>
        <span class="n">owner</span><span class="o">=</span><span class="s">'gooose'</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">retry_delay</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># íƒœìŠ¤í¬ ìˆœì„œ ì •ì˜
</span>    <span class="n">t1</span><span class="o">&gt;&gt;</span><span class="p">[</span><span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">t4</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="n">t5</span>
</code></pre></div></div>

<h2 id="ëª°ëë˜-airflowcfg">ëª°ëë˜ airflow.cfg</h2>
<p>ì²˜ìŒ ìƒê°ì€ consumerì—­í• ì„ ë§¡ì€ t2, t3, t4ì—ì„œ íì—ì„œ í•˜ë‚˜ì”© ë¡œê·¸ë¥¼ ë¹¼ë‚¸ í›„ ì—ëŸ¬ ê²€ì¦ í›„ dbì— ë„£ëŠ” ê²ƒì„ ìƒê°í–ˆìŠµë‹ˆë‹¤.</p>

<p>ê·¸ëŸ¬ë‚˜, collector_0ë§Œ ì‹¤í–‰ë˜ê³  ë‚˜ë¨¸ì§€ collectorëŠ” íì— ëŒ€ê¸°í•˜ë‹¤ê°€ ì‹¤í–‰ì´ ëë‚¬ìŠµë‹ˆë‹¤.<br />
airflowì˜ ë³‘ë ¬ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì— ëŒ€í•´ ì°¾ì•„ë³´ë‹ˆ celeryë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

<p>airflow ì„¤ì •íŒŒì¼ì¸ <code class="language-plaintext highlighter-rouge">airflow.cfg</code>ë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ í•­ëª©ì´ ë³´ì…ë‹ˆë‹¤.<br />
<code class="language-plaintext highlighter-rouge">executor = SequentialExecutor</code><br />
airflowì˜ ì´ˆê¸° ì„¸íŒ…ì€ SequentialExecutorì´ì—ˆê³  collector_0ë§Œ ì‹¤í–‰ë˜ëŠ” ì´ìœ ë„ ê°™ì€ ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.</p>

<p>ê·¸ë ‡ë‹¤ë©´ celeryë§Œ ì‚¬ìš©í•˜ë©´ ë˜ëŠ”ê²ƒì´ ì•„ë‹Œê°€?í•˜ëŠ” ì˜ë¬¸ì´ ìƒê¸¸ ìˆ˜ ìˆëŠ”ë° ì—¬ê¸°ë¶€í„° ì¢€ ì–´ë ¤ì› ìŠµë‹ˆë‹¤.<br />
celeryê°€ ì§€ì›í•˜ëŠ” dbëŠ” postgresql, mysql ì •ë„ì´ê³  ì„¸íŒ…í•˜ë ¤ë©´ ìƒˆë¡œ ì»¨í…Œì´ë„ˆë¥¼ ì˜¬ë ¤ì•¼ í•œë‹¤ëŠ” íŒë‹¨ì„ í–ˆìŠµë‹ˆë‹¤.</p>

<h2 id="í˜„ì¬-ìœ„ì¹˜">í˜„ì¬ ìœ„ì¹˜</h2>
<p>mysqlì„ ì„ íƒí•˜ê³  ì»¨í…Œì´ë„ˆì— ì˜¬ë ¸ëŠ”ë° <code class="language-plaintext highlighter-rouge">Authentication plugin 'caching_sha2_password' cannot be loaded: dlopen(/usr/local/mysql/lib/plugin/caching_sha2_password.so, 2): image not found</code>ì´ëŸ° ì—ëŸ¬ë¡œ ë”ì´ìƒ ì§„í–‰ë˜ì§€ ëª»í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

<p>í•´ê²°ë°©ë²•ì¸ <code class="language-plaintext highlighter-rouge">ALTER USER root@localhost IDENTIFIED WITH mysql_natvie_password by 'password'</code>ê¹Œì§€ ì‹œë„í–ˆì§€ë§Œ í•´ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>

<p>ë‹¤ë¥¸ DBì¸ postgresqlë¡œ ë°”ê¾¼ ë’¤ì— ë‹¤ì‹œ ì‹œë„í•´ë³´ê³  ì„±ê³µí•˜ë©´ ë‹¤ìŒ í¬ìŠ¤íŠ¸ì— í›„ê¸°ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
:ET