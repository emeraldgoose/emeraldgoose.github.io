I"t³<h1 id="ksqldb">ksqlDB</h1>
<p>ksqlDBëŠ” Kafka Streamsì— ê¸°ë°˜í•˜ëŠ” SQL ì—”ì§„ì…ë‹ˆë‹¤. ksqlDBëŠ” Kafka topicì— ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ” ì¿¼ë¦¬ ê³„ì¸µì„ ì œê³µí•©ë‹ˆë‹¤. Kafka Streamsì™€ ë‹¬ë¦¬ ksqlDBëŠ” SQLë¡œ ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•˜ê±°ë‚˜ Materialized Viewë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="ì™œ-ksqldb">ì™œ ksqlDB?</h2>
<p>ë‹¤ìŒê³¼ ê°™ì´ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ íŒŒì´í”„ë¼ì¸ì„ ê°€ì •í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Source Database -&gt; CDC(Debezium-connector) -&gt; Kafka Cluster -&gt; Kafka-sink-connector -&gt; Sink Database
</code></pre></div></div>

<p>ë§Œì•½, ì‹¤ì‹œê°„ ì²˜ë¦¬ê°€ í•„ìš”í•œ ë°ì´í„°ê°€ ê°œì¸ì •ë³´ë¼ë©´ Kafka Clusterì—ì„œ ê°œì¸ì‹ë³„ ì •ë³´ë¥¼ ë§ˆìŠ¤í‚¹ ì‘ì—…ì„ í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë° í”„ë¡œì„¸ìŠ¤ê°€ ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ë˜ëŠ” kafka connectorë¥¼ ì§ì ‘ ê°œë°œí•˜ì—¬ ì¤‘ê°„ì— ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•´ì•¼ í• ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.</p>

<p>í•˜ì§€ë§Œ, ksqlDBëŠ” ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° íŒŒì´í”„ë¼ì¸ì„ ì‘ì„±í•  ìˆ˜ ìˆê³  Kafkaë¥¼ ì €ì¥ì†Œë¡œ í™œìš©í•˜ê²Œ ë©ë‹ˆë‹¤. ì—¬ëŸ¬ê°œì˜ ìŠ¤íŠ¸ë¦¼ê³¼ í…Œì´ë¸”ì„ sqlë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ ë²ˆê±°ë¡œìš´ ê³¼ì •ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨ìˆœíˆ ìŠ¤íŠ¸ë¦¼ì´ë‚˜ í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ SQLì²˜ëŸ¼ ìŠ¤íŠ¸ë¦¼-ìŠ¤íŠ¸ë¦¼, ìŠ¤íŠ¸ë¦¼-í…Œì´ë¸”, í…Œì´ë¸”-í…Œì´ë¸”ì„ ì¡°ì¸í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="persistent-push-pull-query">Persistent, Push, Pull query</h2>
<ol>
  <li>
    <p>Persistent Query
Persistent queryëŠ” ì´ë²¤íŠ¸ í–‰ì„ ë¬´ê¸°í•œìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ì„œë²„ì¸¡ ì¿¼ë¦¬ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">CREATE STREAM AS SELECT</code>ë‚˜ <code class="language-plaintext highlighter-rouge">CREATE TABLE AS SELECT</code>ê°€ ì´ì— í•´ë‹¹í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Push Query
Push queryëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€ê²½ëœëŠ” ê²°ê³¼ë¥¼ êµ¬ë…í•˜ëŠ” ì¿¼ë¦¬ì…ë‹ˆë‹¤. push queryë¥¼ ì‚¬ìš©í•˜ë©´ ìŠ¤íŠ¸ë¦¼ì´ë‚˜ í…Œì´ë¸”ì˜ ê²°ê³¼ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì¿¼ë¦¬ëŠ” ë¹„ë™ê¸° ì‘ì—…ì— ì í•©í•œ ì¿¼ë¦¬ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Pull Query
Pull queryëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ í˜„ì¬ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ê²Œ í•˜ëŠ” ì¿¼ë¦¬ì…ë‹ˆë‹¤. ìƒˆ ì´ë²¤íŠ¸ê°€ ë„ì°©í•˜ë©´ pull queryë¥¼ í†µí•´ Materialized Viewë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¿¼ë¦¬ëŠ” ìš”ì²­/ì‘ë‹µ ì‘ì—…ì— ì í•©í•œ ì¿¼ë¦¬ì…ë‹ˆë‹¤.</p>
  </li>
</ol>

<h2 id="íŒŒì´í”„ë¼ì¸">íŒŒì´í”„ë¼ì¸</h2>
<blockquote>
  <p>íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•  ë•ŒëŠ” Docker Desktopì—ì„œ ì œê³µí•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì‚¬ìš©í–ˆê³  ëª¨ë‹ˆí„°ë§ íˆ´ì€ k9sì™€ Docker Desktopì„ ì´ìš©í–ˆìŠµë‹ˆë‹¤.</p>
</blockquote>

<blockquote>
  <p>ë¡œì»¬ ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì´ìš©í•˜ë¯€ë¡œ í•˜ë‚˜ì˜ ë…¸ë“œë§Œ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤. ê·¸ë˜ì„œ ê°ê°ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë§ê²Œ ë°°í¬í–ˆìŠµë‹ˆë‹¤.</p>
</blockquote>

<h3 id="ë°ì´í„°-ìƒì„±">ë°ì´í„° ìƒì„±</h3>
<p>Source ë°ì´í„°ë² ì´ìŠ¤ì¸ Postgresqlì— ê°€ìƒì˜ ì€í–‰ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì—¬ ì ì¬í•œë‹¤ê³  ê°€ì •í•˜ê² ìŠµë‹ˆë‹¤.</p>

<p>account, bank_transaction, transaction_log í…Œì´ë¸”ì„ ë§Œë“¤ê³  sqlalchemyë¥¼ ì´ìš©í•´ source dbì— ë°ì´í„°ë¥¼ ì ì¬í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ëŠ” í…Œì´ë¸”ì˜ ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•œ ê²ƒì…ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># entities.py
</span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">TIMESTAMP</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'account'</span>

    <span class="n">account_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">account_holder_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># hash
</span>    <span class="n">account_balance</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Transaction</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">"bank_transaction"</span>
    
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Account</span><span class="p">.</span><span class="n">account_id</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># deposit, withdraw
</span>

<span class="k">class</span> <span class="nc">Transaction_log</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'transaction_log'</span>
    
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Transaction</span><span class="p">.</span><span class="nb">id</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># Success, Failed
</span></code></pre></div></div>

<p>ëœë¤í•˜ê²Œ ê³„ì¢Œë¥¼ ìƒì„±í•˜ê±°ë‚˜ ê±°ë˜ë¥¼ ì‹œë„í•˜ê²Œ ë˜ê³  ê±°ë˜ ì‹œ ê¸ˆì•¡ë„ ëœë¤í•˜ê²Œ ê²°ì •ë©ë‹ˆë‹¤. ë§Œì•½ ì¶œê¸ˆì‹œ ê³„ì¢Œ ì”ì•¡ì´ ë¶€ì¡±í•œ ê²½ìš° bank_transaction í…Œì´ë¸”ì— ê¸°ë¡ë˜ì§€ ì•Šì§€ë§Œ ë¡œê·¸ëŠ” ë‚¨ê²Œ í–ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ transaction_log í…Œì´ë¸”ì— ëª¨ë“  ê±°ë˜ ì‹œë„ì— ëŒ€í•´ ì„±ê³µ í˜¹ì€ ì‹¤íŒ¨ë¥¼ ê¸°ë¡í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<h3 id="postgres-ë°°í¬">Postgres ë°°í¬</h3>
<p>Postgresqlì„ k8sì— ë°°í¬í•˜ê¸° ìœ„í•´ deployment.yaml, configmap.yaml, service.yamlì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># postgresql/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    postgresql: postgresql
  name: postgresql
spec:
  replicas: 1
  selector:
    matchLabels:
      postgresql: postgresql
  template:
    metadata:
      labels:
        postgresql: postgresql
    spec:
      containers:
        - name: postgresql
          image: bitnami/postgresql:latest
          env:
            - name: POSTGRESQL_PASSWORD
              value: postgres
          volumeMounts:
            - name: postgres-config-volume
              mountPath: /bitnami/postgresql/conf/postgresql.conf
              subPath: postgresql.conf
          ports:
            - containerPort: 5432 # original port 5432
      hostname: postgresql
      volumes:
        - name: postgres-config-volume
          configMap:
            name: postgres-config
</code></pre></div></div>
<p>configmapì€ postgresqlì´ initdbë¥¼ ì‹¤í–‰í•  ë•Œ ì„¤ì •ê°’ì„ ë³€ê²½í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.</p>

<p>listen_addressëŠ” ê¸°ë³¸ê°’ì´ 127.0.0.1ì´ë¯€ë¡œ ë‹¤ë¥¸ íŒŒë“œì—ì„œ ì ‘ê·¼í•˜ê¸° ìœ„í•´ ëª¨ë‘ í—ˆìš©í•˜ëŠ” 0.0.0.0ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤. wal_level(Write Ahead Log)ëŠ” Debeziumì—ì„œ ìº¡ì³ë¥¼ ìœ„í•´ logical ì„¤ì •ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ë³€ê²½í–ˆìŠµë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># postgresql/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
data:
  postgresql.conf: |
    wal_level = logical
    listen_addresses = '0.0.0.0'
</code></pre></div></div>

<p>service.yamlì€ ë‚´ë¶€ ë„ë©”ì¸ì„ ì´ìš©í•˜ë¯€ë¡œ í¬íŠ¸ë§Œ ì—°ê²°í•´ì¤ë‹ˆë‹¤. í´ëŸ¬ìŠ¤í„° ë‚´ íŒŒë“œì™€ ì—°ê²°ëœ ì„œë¹„ìŠ¤ë¼ë¦¬ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ <code class="language-plaintext highlighter-rouge">{pod.spec.hostname}.{namespace}.svc.cluster.local</code>ì´ë¼ëŠ” ë„ë©”ì¸ì´ ìë™ ë¶€ì—¬ë˜ê³  íŒŒë“œ ë‚´ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì € ë„ë©”ì¸ì„ ì‚¬ìš©í•˜ë ¤ë©´ hostnameì„ deployment.yamlì— ë„£ì–´ì¤˜ì•¼ í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># postgresql/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    postgresql: postgresql
  name: postgresql
spec:
  type: ClusterIP
  ports:
    - name: "5432"
      port: 5432
      targetPort: 5432
  selector:
    postgresql: postgresql
</code></pre></div></div>

<p>ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ postgresqlì„ ë°°í¬í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns postgres
kubectl apply -f postgres/ -n postgres
</code></pre></div></div>

<p>postgresqlì´ ë°°í¬ë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ postgres ë°ì´í„°ë² ì´ìŠ¤ê°€ ìƒì„±ë©ë‹ˆë‹¤. ë‹¤ìŒ Kafkaë¡œë¶€í„° ë°ì´í„°ë¥¼ ë°›ì„ sink ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í™•ì¸í•´ì„œ pod ì´ë¦„ì„ ì¡°íšŒí•œ í›„ íŒŒë“œì— ì ‘ì†í•´ sink ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get po -n postgres
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it &lt;postgresql-pod-name&gt; -n postgres -- createdb -U postgres sink
</code></pre></div></div>
<p>ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ë¬¼ì–´ë³´ëŠ”ë° deployment.yamlì— POSTGRESQL_PASSWORDì— ì„¤ì •í•œ ê°’ì„ ì…ë ¥í•©ë‹ˆë‹¤.</p>

<p>ë§Œì•½ dbê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¡œ í™•ì¸ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it &lt;postgresql-pod-name&gt; -n postgres -- psql -U postgres -c "\list"
</code></pre></div></div>

<h3 id="kafka-ë°°í¬">Kafka ë°°í¬</h3>
<p>KafkaëŠ” kafka, kafka-connect, kafka-ui, ksqldb-server, schema-registry, zookeeperë¥¼ ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<p>ì €ëŠ” deployment, serviceë¥¼ ëª¨ë‘ ì‘ì„±í•˜ì§€ëŠ” ì•Šì•˜ê³  docker-compose.ymlë¡œ ë¨¼ì € ì‘ì„± í›„ì— komposeë¥¼ ì‚¬ìš©í•´ì„œ deploymentì™€ serviceë¡œ ë³€í™˜ í›„ í™˜ê²½ë³€ìˆ˜ë“¤ë§Œ ìˆ˜ì •í•´ì„œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ëª¨ë“  yamlì„ ì˜¬ë¦¬ëŠ” ê²ƒì€ ë„ˆë¬´ ê¸¸ì–´ì§€ë¯€ë¡œ í™˜ê²½ë³€ìˆ˜ë“¤ë§Œ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/broker-deployment.yaml
KAFKA_LISTENERS=INTERNAL://:9092,EXTERNAL://:29092
KAFKA_ADVERTISED_LISTENERS=INTERNAL://broker:9092,EXTERNAL://localhost:29092
KAFKA_BROKER_ID=1
KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/ksqldb-server-deployment.yaml
KSQL_BOOTSTRAP_SERVERS=broker:9092
KSQL_KSQL_LOGGING_PROCESSING_STREAM_AUTO_CREATE=true
KSQL_KSQL_LOGGING_PROCESSING_TOPIC_AUTO_CREATE=true
KSQL_LISTENERS=http://0.0.0.0:28088
KSQL_KSQL_SCHEMA_REGISTRY_URL=http://schema-registry:8081
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/schema-registry-deployment.yaml
SCHEMA_REGISTRY_HOST_NAME=schema-registry.kafka.svc.cluster.local
SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS=broker:9092
SCHEMA_REGISTRY_LISTENERS=http://0.0.0.0:8081
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/zookeeper-deployment.yaml
ZOOKEEPER_CLIENT_PORT=2181
ZOOKEEPER_TICK_TIME=2000
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/kafka-connect-deployment.yaml
CONNECT_BOOTSTRAP_SERVERS=broker:9092
CONNECT_GROUP_ID=1
CONNECT_CONFIG_STORAGE_TOPIC=kafka-configs
CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR=1
CONNECT_OFFSET_STORAGE_TOPIC=kafka-offsets
CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR=1
CONNECT_STATUS_STORAGE_TOPIC=kafka-status
CONNECT_STATUS_STORAGE_REPLICATION_FACTOR=1
CONNECT_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
CONNECT_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
CONNECT_REST_ADVERTISED_HOST_NAME=kafka-connect.kafka.svc.cluster.local
CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL=http://schema-registry:8081
</code></pre></div></div>
<p>ì¹´í”„ì¹´ ì»¤ë„¥í„°ë¥¼ ë°°í¬í•  ë•ŒëŠ” ë”°ë¡œ Dockerfileì„ ì‘ì„±í•˜ê³  ë¹Œë“œí•œ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì¹´í”„ì¹´ ì»¤ë„¥í„°ì— debezium ì»¤ë„¥í„°ì™€ jdbc sink ì»¤ë„¥í„°ë¥¼ ì„¤ì¹˜í•´ì•¼ ì •ìƒì ìœ¼ë¡œ ì»¤ë„¥í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
ì¹´í”„ì¹´ ì»¤ë„¥í„°ëŠ” confluent hubë¥¼ ì´ìš©í•´ ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ Dcokerfileì„ ì‘ì„±í•´ì•¼ í•˜ëŠ” ì´ìœ ëŠ” confluent-hubë¡œ ì„¤ì¹˜í•œ ì»¤ë„¥í„°ëŠ” ëª©ë¡ìœ¼ë¡œ ë°”ë¡œ ì¡íˆì§€ ì•Šê³  ì¬ì‹œì‘í•´ì•¼ ëª©ë¡ìœ¼ë¡œ ì¡íˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>

<p>ì‹¤ì œë¡œ confluentinc/cp-kafka-connect ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰ì‹œì¼œ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì§í›„ <code class="language-plaintext highlighter-rouge">curl -X GET localhost:8083/connector-plugins</code> ëª…ë ¹ì–´ë¡œ í”ŒëŸ¬ê·¸ì¸ ëª©ë¡ì„ ë³´ê²Œ ë˜ë©´ ì„¤ì¹˜í•œ í”ŒëŸ¬ê·¸ì¸ë“¤ì´ ëª©ë¡ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ ëª©ë¡ì— ì—†ë‹¤ë©´ ë‹¹ì—°íˆ ì»¤ë„¥í„° ì„¤ì • ì‹œ í•´ë‹¹ ì»¤ë„¥í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ê¸° ë•Œë¬¸ì— ë°°í¬ ì „ì— í”ŒëŸ¬ê·¸ì¸ì„ ë°›ê³  ì»¤ë„¥í„°ë¥¼ ì‹œì‘í•˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka-connector/Dockerfile
FROM confluentinc/cp-kafka-connect-base:latest

RUN confluent-hub install --no-prompt confluentinc/kafka-connect-jdbc:10.7.11 &amp;&amp; \
    confluent-hub install --no-prompt debezium/debezium-connector-postgresql:2.5.4
</code></pre></div></div>

<p>ëŒ€ì‹œë³´ë“œ ë°°í¬ë¥¼ ìœ„í•´ <code class="language-plaintext highlighter-rouge">provectuslabs/kafka-ui</code> ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ëŒ€ì•ˆìœ¼ë¡œ confluent/control-centerë„ ìˆìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œëŠ” localhost:8080ìœ¼ë¡œ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ service.yamlì—ì„œ typeì„ LoadBalancer í˜¹ì€ NodePortë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/kafka-ui-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-ui
spec:
  selector:
    matchLabels:
      app: kafka-ui
  replicas: 1
  template:
    metadata:
      labels:
        app: kafka-ui
    spec:
      containers:
      - name: kafka-ui
        image: provectuslabs/kafka-ui:latest
        ports:
          - containerPort: 8080
        env:
          - name: KAFKA_CLUSTERS_0_NAME
            value: broker
          - name: DYNAMIC_CONFIG_ENABLED
            value: "true"
          - name: KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME
            value: kafka-connect
          - name: KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS
            value: "http://kafka-connect:8083"
          - name: KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS
            value: "broker:9092"
          - name: KAFKA_CLUSTERS_0_ZOOKEEPER
            value: "zookeeper:2181"
          - name: KAFKA_CLUSTERS_0_KSQLDBSERVER
            value: "http://ksqldb-server:28088"
          - name: KAFKA_CLUSTERS_0_SCHEMAREGISTRY
            value: "http://schema-registry:8081"
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/kafka-ui-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: kafka-ui
spec:
  type: LoadBalancer
  selector:
    app: kafka-ui
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
</code></pre></div></div>
<p>ëŒ€ì‹œë³´ë“œê°€ ë°°í¬ëœ í›„ localhost:8080ìœ¼ë¡œ ì ‘ì†í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<figure>
    <a href="https://drive.google.com/file/d/1XUDVuAmSgqtcWPh8ST-f1N6bfhU8PGG0/view?usp=sharing"><img src="https://lh3.googleusercontent.com/d/1Qk45_LzDcq7pLVpEG44CeL8XklKijBHf" /></a>
    <figcaption>UI For Apache Kafka</figcaption>
</figure>

<p>Kafka Connectì™€ KSQL DB íƒ­ì€ kafka-connectë‚˜ ksqldb-serverì™€ ì—°ê²°ë˜ì§€ ì•Šìœ¼ë©´ ì‚¬ì´ë“œë°” ëª©ë¡ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë§Œì•½ ì‚¬ì´ë“œë°”ì— ì—†ë‹¤ë©´ kafka-connectì™€ ksqldbì˜ ìƒíƒœë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<p>ì´ì „ ë°°í¬í•œ Postgresqlê³¼ ì—°ê²°í•˜ê¸° ìœ„í•´ Connectorë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "name": "debezium-postgresql-source-connector",
    "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
    "database.hostname": "postgresql.postgres.svc.cluster.local",
    "database.port": "5432",
    "database.user": "postgres",
    "database.password": â€œpostgresâ€,
    "database.dbname": "postgres",
    "tasks.max": "1",
    "slot.name": "debezium_test",
    "plugin.name": "pgoutput",
    "topic.prefix": "integrate",
    "key.converter": "io.confluent.connect.avro.AvroConverter",
    "key.converter.schemas.enable": "true",
    "key.converter.schema.registry.url": "http://schema-registry.kafka.svc.cluster.local:8081"
    "value.converter": "io.confluent.connect.avro.AvroConverter",
    "value.converter.schemas.enable": "true",
    "value.converter.schema.registry.url": "http://schema-registry.kafka.svc.cluster.local:8081",
}
</code></pre></div></div>

<p>kafka-connectê°€ ì ‘ì†í•˜ëŠ” <code class="language-plaintext highlighter-rouge">database.user</code>ì˜ roleì´ superuser, replicationì„ ê°€ì§€ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤. connectorê°€ postgresqlì— ì ‘ì†í•´ì„œ slotì„ ìƒì„±í•´ì•¼ í•˜ëŠ”ë° ì´ ê¶Œí•œì´ superuserì™€ replicationì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë§Œì•½ usernameì´ postgresê°€ ì•„ë‹ˆë¼ë©´ ë‹¤ìŒì˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it &lt;postgres-pod&gt; -n postgres -- psql -U postgres -c "alter user &lt;username&gt; with superuser replication;"
</code></pre></div></div>

<p>schema-registryë¥¼ ë°°í¬í–ˆê¸° ë•Œë¬¸ì— AvroConverterë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. schema-registryëŠ” ë°ì´í„° ìŠ¤í‚¤ë§ˆë¥¼ ì €ì¥í•˜ê³  ë¶ˆëŸ¬ì˜¤ëŠ” ê³µê°„ìœ¼ë¡œ ì‚¬ìš©ìê°€ ìŠ¤í‚¤ë§ˆë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ì•Œì•„ì„œ ìŠ¤í‚¤ë§ˆë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ë’¤ì— ë‚˜ì˜¬ ksqldbë¥¼ ì‚¬ìš©í•  ë•Œë„ ìŠ¤í‚¤ë§ˆ ì…ë ¥ì„ í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ì¥ì ë„ ìˆìŠµë‹ˆë‹¤. connectorê°€ ì—°ê²°ë˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì»¤ë„¥í„° ëª©ë¡ë“¤ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<figure>
    <a href="https://drive.google.com/file/d/1yNMwz2tnhVfvBVyfvV_h0rg4p2i8YG0K/view?usp=sharing"><img src="https://lh3.googleusercontent.com/d/1yNMwz2tnhVfvBVyfvV_h0rg4p2i8YG0K" /></a>
    <figcaption>Connectors</figcaption>
</figure>

<p><strong>ksqlDB ì„¤ì •</strong>
ëŒ€ì‹œë³´ë“œì—ì„œ ksqlDB íƒ­ìœ¼ë¡œ ë“¤ì–´ê°€ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<figure>
    <a href="https://drive.google.com/file/d/1zyoubY48lF0Yzb7cmJDE5vf5zuhrXNC3/view?usp=sharing"><img src="https://lh3.googleusercontent.com/d/1zyoubY48lF0Yzb7cmJDE5vf5zuhrXNC3" /></a>
    <figcaption>ksqlDB</figcaption>
</figure>

<p>ì´ë¯¸ ìŠ¤íŠ¸ë¦¼ê³¼ í…Œì´ë¸”ì„ ì •ì˜í–ˆê¸° ë•Œë¬¸ì— ëª©ë¡ì— ë³´ì´ê³  ìˆê³  ì´ˆê¸° ìƒíƒœëŠ” ìŠ¤íŠ¸ë¦¼ì— í•œê°œë§Œ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì˜¤ë¥¸ìª½ ìƒë‹¨ì— <code class="language-plaintext highlighter-rouge">Execute KSQL Request</code>ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê³µê°„ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì‚¬ì§„ì€ bank_transaction_baseë¼ëŠ” ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•˜ê³  ì‹¤í–‰í•œ ëª¨ìŠµì…ë‹ˆë‹¤.</p>

<figure>
    <a href="https://drive.google.com/file/d/1e9xQBs4njpdKk4Pio6nukwE2xZYugYsR/view?usp=sharing"><img src="https://lh3.googleusercontent.com/d/1e9xQBs4njpdKk4Pio6nukwE2xZYugYsR" /></a>
</figure>

<p>source-connectorë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë©´ topicì— ë©”ì‹œì§€ê°€ ìŒ“ì´ê²Œ ë˜ëŠ”ë° ksqlDBì—ì„œëŠ” ì´ ë©”ì‹œì§€ë¥¼ ë°”ë¡œ ì‚¬ìš©í•˜ì§€ ëª»í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ streamì„ ë¨¼ì € ìƒì„±í•˜ê³  ê·¸ ìŠ¤íŠ¸ë¦¼ì„ ì‚¬ìš©í•˜ì—¬ ì–´ë– í•œ ì²˜ë¦¬ ë¡œì§ì´ ë°˜ì˜ëœ ìŠ¤íŠ¸ë¦¼ í˜¹ì€ í…Œì´ë¸”ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="n">stream</span> <span class="n">account</span> <span class="k">with</span> <span class="p">(</span><span class="n">kafka_topic</span><span class="o">=</span><span class="err">â€˜</span><span class="n">integrate</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="n">account</span><span class="err">â€™</span><span class="p">,</span> <span class="n">value_format</span><span class="o">=</span><span class="err">â€˜</span><span class="n">avro</span><span class="err">â€™</span><span class="p">);</span>
</code></pre></div></div>

<p>AvroConvertë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë¯€ë¡œ formatì„ avroë¡œ ì„¤ì •í•˜ë©´ ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ AvroConvertë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ìŠ¤í‚¤ë§ˆë¥¼ ì§€ì •í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.</p>

<p>ìŠ¤í‚¤ë§ˆë¥¼ ì§€ì •í•´ì•¼ í•˜ëŠ” ê²½ìš° ì£¼ì˜í•´ì•¼ í•  ì ì€ source dbì˜ ìŠ¤í‚¤ë§ˆê°€ ì•„ë‹Œ connectorê°€ ìƒì„±í•˜ëŠ” êµ¬ì¡°ë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤. kafka topic ë©”ì‹œì§€ í•˜ë‚˜ê°€ ë‹¤ìŒê³¼ ê°™ë‹¤ë©´ ì‘ì„±í•´ì•¼ í•  sql ì˜ˆì‹œë¥¼ ë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"after"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"account_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"566740694069"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"account_holder_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"8202b6c341fe41f74b0749678fa87f9d56d89f9b83f48277a91a0a61a01cd183"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"account_balance"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.5.4.Final"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"connector"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgresql"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integrate"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ts_ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">1725335089064</span><span class="p">,</span><span class="w">
        </span><span class="nl">"snapshot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"db"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"sequence"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[</span><span class="se">\"</span><span class="s2">26901096</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">26901200</span><span class="se">\"</span><span class="s2">]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"public"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"table"</span><span class="p">:</span><span class="w"> </span><span class="s2">"transaction_log"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"txId"</span><span class="p">:</span><span class="w"> </span><span class="mi">748</span><span class="p">,</span><span class="w">
        </span><span class="nl">"lsn"</span><span class="p">:</span><span class="w"> </span><span class="mi">26901200</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"op"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ts_ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">1725335089547</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="n">stream</span> <span class="n">account</span> <span class="p">(</span>
    <span class="k">after</span> <span class="n">struct</span><span class="o">&lt;</span><span class="n">account_id</span> <span class="nb">varchar</span><span class="p">,</span> <span class="n">account</span><span class="o">-</span><span class="n">holder</span><span class="o">-</span><span class="n">name</span> <span class="nb">varchar</span><span class="p">,</span> <span class="n">account</span><span class="o">-</span><span class="n">balance</span> <span class="nb">bigint</span><span class="o">&gt;</span><span class="p">,</span> 
    <span class="n">ts_ms</span> <span class="nb">bigint</span>
<span class="p">)</span> <span class="k">with</span> <span class="p">(</span>
    <span class="n">kafka_topic</span><span class="o">=</span><span class="err">â€˜</span><span class="n">integrate</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="n">account</span><span class="err">â€™</span><span class="p">,</span> 
    <span class="n">value_format</span><span class="o">=</span><span class="err">â€˜</span><span class="n">json</span><span class="err">â€™</span>
<span class="p">);</span>
</code></pre></div></div>
<p>ë©”ì‹œì§€ êµ¬ì¡°ì™€ ìŠ¤í‚¤ë§ˆ êµ¬ì¡°ê°€ ë§ì§€ ì•Šë‹¤ë©´ push query ì‹¤í–‰ ì‹œ ë°ì´í„°ëŠ” nullë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>

<p>ì €ëŠ” bank_transaction ë°ì´í„°ë¥¼ ì‚¬ìš©í•´ì„œ count_type_by_account, success_ratio_by_account, transaction_volume_per_minuteì´ë¼ëŠ” í…Œì´ë¸”ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">count_type_by_account</span> <span class="k">as</span>
    <span class="k">select</span> 
        <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span><span class="p">,</span> 
        <span class="k">count</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="k">type</span><span class="o">=</span><span class="s1">'deposit'</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">deposit_count</span><span class="p">,</span> 
        <span class="k">count</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="k">type</span><span class="o">=</span><span class="s1">'withdraw'</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">withdraw_count</span>
    <span class="k">from</span> <span class="n">bank_transaction_base</span> <span class="n">bt</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span>
    <span class="n">emit</span> <span class="n">changes</span><span class="p">;</span>
</code></pre></div></div>
<p>ì´ ì¿¼ë¦¬ì²˜ëŸ¼ account_idë¡œ group byí•˜ë ¤ë©´ ë°˜ë“œì‹œ select ì ˆì— account_idê°€ ë“±ì¥í•´ì•¼ í•©ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">emit changes</code>ëŠ” ì°¸ì¡°í•˜ëŠ” ìŠ¤íŠ¸ë¦¼ì— ë³€í™”ê°€ ìƒê¸¸ë•Œ ì´ í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ë¡œ pull queryë¥¼ push queryë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">success_ratio_by_account</span> <span class="k">as</span>
  <span class="k">select</span>
    <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span> <span class="k">as</span> <span class="n">account_id</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">tl</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">event</span><span class="o">=</span><span class="s1">'Success'</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">success_count</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">tot</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">tl</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="s1">'Success'</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="nb">double</span><span class="p">)</span> <span class="o">/</span> <span class="k">cast</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="nb">double</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">success_rate</span>
  <span class="k">from</span> <span class="n">bank_transaction_base</span> <span class="n">bt</span>
  <span class="k">left</span> <span class="k">join</span> <span class="n">transaction_log_base</span> <span class="n">tl</span> <span class="n">within</span> <span class="mi">10</span> <span class="n">minutes</span> <span class="k">on</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">tl</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">transaction_id</span>
  <span class="k">group</span> <span class="k">by</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span>
  <span class="n">emit</span> <span class="n">changes</span><span class="p">;</span>
</code></pre></div></div>
<p>ì´ ì¿¼ë¦¬ì—ì„œ ìŠ¤íŠ¸ë¦¼ì¸ bank_transaction_baseì™€ transaction_log_baseë¥¼ ì¡°ì¸í•˜ì—¬ 10ë¶„ ê°„ê²©ìœ¼ë¡œ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">transaction_volume_per_minute</span> <span class="k">as</span>
    <span class="k">select</span>
        <span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span> <span class="k">as</span> <span class="n">account_id</span><span class="p">,</span>
        <span class="k">sum</span><span class="p">(</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_amount</span><span class="p">,</span>
        <span class="n">windowstart</span> <span class="k">as</span> <span class="n">window_start</span><span class="p">,</span>
        <span class="n">windowend</span> <span class="k">as</span> <span class="n">window_end</span><span class="p">,</span>
        <span class="n">from_unixtime</span><span class="p">(</span><span class="n">windowstart</span><span class="p">)</span> <span class="k">as</span> <span class="n">time_start</span><span class="p">,</span>
        <span class="n">from_unixtime</span><span class="p">(</span><span class="n">windowend</span><span class="p">)</span> <span class="k">as</span> <span class="n">time_end</span>
    <span class="k">from</span> <span class="n">bank_transaction_base</span>
    <span class="k">window</span> <span class="n">tumbling</span><span class="p">(</span><span class="k">size</span> <span class="mi">1</span> <span class="k">minute</span><span class="p">)</span>
    <span class="k">group</span> <span class="k">by</span> <span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span>
    <span class="n">emit</span> <span class="n">changes</span><span class="p">;</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">window tumbling(size 1 minute)</code>ì€ 1ë¶„ê°„ê²©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì¦‰, account_idë§ˆë‹¤ 1ë¶„ê°„ amount ì´í•©ì„ ê³„ì‚°í•˜ëŠ” ì¿¼ë¦¬ì…ë‹ˆë‹¤. íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ê³„ì† ê¸°ë¡ë˜ë¯€ë¡œ ì´ëŸ° íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ksqlDBì˜ ì¥ì ì…ë‹ˆë‹¤.</p>

<p>í…Œì´ë¸”ê³¼ ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•˜ë©´ topicì— ìë™ ë“±ë¡ë˜ê³  ì²˜ë¦¬ëœ ë°ì´í„°ê°€ ë©”ì‹œì§€ë¡œ ìŒ“ì´ê²Œ ë©ë‹ˆë‹¤.</p>

<figure>
    <a href="https://drive.google.com/file/d/1XKq0Pe5ikGZw3GBXiNRseJaWf9NbcoLD/view?usp=sharing"><img src="https://lh3.googleusercontent.com/d/1XKq0Pe5ikGZw3GBXiNRseJaWf9NbcoLD" /></a>
    <figcaption>topics</figcaption>
</figure>

<p>ê·¸ë¦¬ê³  schema-registryì—ë„ ìŠ¤í‚¤ë§ˆê°€ ë“±ë¡ë©ë‹ˆë‹¤.</p>

<figure>
    <a href="https://drive.google.com/file/d/1QQa_1B0vc-zz7WMiiwcYc-iL5h-JNsTl/view?usp=sharing"><img src="https://lh3.googleusercontent.com/d/1QQa_1B0vc-zz7WMiiwcYc-iL5h-JNsTl" /></a>
    <figcaption>schema-registry</figcaption>
</figure>

<p>ë‹¤ì‹œ kafka-connectë¡œ ëŒì•„ì™€ì„œ Sink ì»¤ë„¥í„° ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤. ì €ëŠ” count_type_by_account, success_ratio_by_account, transaction_volume_per_minute topicì„ sink dbì— ì ì¬í–ˆìŠµë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "name": "postgresql-sink-connector-topic-success-ratio-by-account",
    "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
    "connection.url": "jdbc:postgresql://postgresql.postgres.svc.cluster.local:5432/sink",
    "connection.user": "postgres",
    "connection.password": "postgres",
    "topics": "SUCCESS_RATIO_BY_ACCOUNT",
    "tasks.max": "1",
    "insert.mode": "upsert",
    "auto.evolve": "true",
    "auto.create": "true",
    "pk.mode":"record_key",
    "pk.field":"account_id",
    "key.converter": "io.confluent.connect.avro.AvroConverter",
    "key.converter.schemas.enable": "true",
    "key.converter.schema.registry.url": "http://schema-registry.kafka.svc.cluster.local:8081"
    "value.converter": "io.confluent.connect.avro.AvroConverter",
    "value.converter.schemas.enable": "true",
    "value.converter.schema.registry.url": "http://schema-registry.kafka.svc.cluster.local:8081",
}
</code></pre></div></div>

<h3 id="superset-ë°°í¬">Superset ë°°í¬</h3>
<p>Supersetì€ ë”°ë¡œ yamlë¡œ ì‘ì„±í•˜ì§€ ì•Šê³  helmì„ ì´ìš©í•˜ì—¬ ë°°í¬í–ˆìŠµë‹ˆë‹¤. helm í†µí•´ superset, redis, postgresql, superset-workerê°€ ë°°í¬ë©ë‹ˆë‹¤.</p>

<p>ë¨¼ì € superset ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns superset
</code></pre></div></div>

<p>ë‹¤ìŒ helm repoë¥¼ ì¶”ê°€í•˜ê³  ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add superset http://apache.github.io/superset/
helm repo update
</code></pre></div></div>

<p>superset ìµœê·¼ ì´ìŠˆ ì¤‘ì— default secret key ë¬¸ì œê°€ ìˆì–´ values.yaml íŒŒì¼ì— secret keyë¥¼ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. secret keyëŠ” openssl ëª…ë ¹ì–´ë¡œ ì‹¤í–‰ëœ ê°’ì„ ë„£ì–´ì¤ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl rand -base64 42
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># superset/values.yaml
extraSecretEnv:
  SUPERSET_SECRET_KEY: {SECRET_KEY}
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm install superset superset/superset -f superset/values.yaml -n superset
</code></pre></div></div>
<p>ë˜ëŠ” â€“set ëª…ë ¹ì–´ë¡œ values.yaml íŒŒì¼ì„ overwriteí•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm install superset superset/superset -n superset --set extraSecretEnv.SUPERSET_SECRET_KEY=$(openssl rand -base64 42)
</code></pre></div></div>

<p>ë‹¤ìŒ supersetì— ì ‘ì†í•˜ê¸° ìœ„í•´ í¬íŠ¸í¬ì›Œë“œë¥¼ ì„¤ì •í•˜ê³  localhost:8088ë¡œ ì ‘ì†í•©ë‹ˆë‹¤. ê¸°ë³¸ idì™€ passwowrdëŠ” supersetì…ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward superset -n superset 8088:8088
</code></pre></div></div>

<p>ì ‘ì† í›„ databaseë¥¼ ë¨¼ì € ì—°ê²°í•´ì¤ë‹ˆë‹¤. ì˜¤ë¥¸ìª½ ìƒë‹¨ <code class="language-plaintext highlighter-rouge">+</code>ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì—°ê²°í•˜ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">Settings</code>ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ ê´€ë¦¬ íƒ­ì„ ëˆŒëŸ¬ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<figure>
    <a href="https://drive.google.com/file/d/1MNCZA5gVFc4Ok1hiQ8_M9UuS_PvAZStN/view?usp=sharing"><img src="https://lh3.googleusercontent.com/d/1MNCZA5gVFc4Ok1hiQ8_M9UuS_PvAZStN" /></a>
    <figcaption>superset, connect a database</figcaption>
</figure>

<p>PostgreSQLì„ ëˆŒëŸ¬ ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥í•˜ê³  <code class="language-plaintext highlighter-rouge">Connect</code>ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>host: postgresql.postgres.svc.cluster.local
port: 5432
database: postgres
username: postgres
password: postgres
display name: PostgreSQL-source
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>host: postgresql.postgres.svc.cluster.local
port: 5432
database: sink
username: postgres
password: postgres
display name: PostgreSQL-sink
</code></pre></div></div>

<p>ë‹¤ìŒ ì¶”ê°€ ì„¤ì •ìœ¼ë¡œ SQL Lab íƒ­ì—ì„œ Allow DMLì„ ì²´í¬í•˜ì—¬ <code class="language-plaintext highlighter-rouge">Finish</code> ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.</p>

<p>SQL Labì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì¿¼ë¦¬ë¥¼ ë‚ ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¤ë¥¸ìª½ì— ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<figure>
    <a href="https://drive.google.com/file/d/1gctLb0021N_7nV9OWO4uJCeZbGrYAMHG/view?usp=sharing"><img src="https://lh3.googleusercontent.com/d/1gctLb0021N_7nV9OWO4uJCeZbGrYAMHG" /></a>
    <figcaption>superset, sql lab</figcaption>
</figure>

<p>ìœ„ ì‚¬ì§„ì—ì„œëŠ” COUNT_TYPE_BY_ACCOUNT í…Œì´ë¸”ì„ ì´ìš©í•´ ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤. ì´ê²ƒì„ ì˜¤ë¥¸ìª½ ì¤‘ê°„ì— SAVE ë²„íŠ¼ ì˜† í™•ì¥ í‘œì‹œë¥¼ ëˆŒëŸ¬ Datasetsìœ¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ëŠ” CREATE CHART ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°”ë¡œ ì°¨íŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>

<p>ëª‡ ê°€ì§€ ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ ê°„ë‹¨í•˜ê²Œ ëŒ€ì‹œë³´ë“œë¥¼ êµ¬ì„±í•´ë´¤ìŠµë‹ˆë‹¤.</p>
<figure>
    <a href="https://drive.google.com/file/d/1L22GmE9SBNjaJ-q0-aGHrQeNUZm7dEsc/view?usp=sharing"><img src="https://1drv.ms/i/s!AoC6BbMk0S9Qm0U95QrnHpAev6Xi?embed=1&amp;width=2558&amp;height=1209" /></a>
    <figcaption>superset, dashboard transaction</figcaption>
</figure>

<figure>
    <a href="https://drive.google.com/file/d/1l-CHHk2PcepbZGiCYemRgzEAkBSn3uVn/view?usp=sharing"><img src="https://1drv.ms/i/s!AoC6BbMk0S9Qm0ZjPZ3xzWCi0V2X?embed=1&amp;width=2552&amp;height=1214" />
    <figcaption>superset, dashboard transaction-event</figcaption>
&lt;/figure&gt;

ê° ì°¨íŠ¸ ìš°ì¸¡ ìƒë‹¨ ...ì„ ëˆ„ë¥´ê²Œ ë˜ë©´ refresh intervalì„ ì„¤ì •í•˜ê±°ë‚˜ ì°¨íŠ¸ë¥¼ ê³µìœ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

## ë§ˆë¬´ë¦¬
ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  kafka-ksqlDBë¥¼ ê±°ì³ supersetìœ¼ë¡œ ì‹œê°í™”ê¹Œì§€ ì´ì–´ì§€ë„ë¡ í•´ë´¤ìŠµë‹ˆë‹¤. ksqlDBì´ window ê´€ë ¨ ë‚´ìš©ì´ ì¬ë°ŒëŠ”ê²Œ ë§ì•˜ì§€ë§Œ ê¹Šê²Œ íŒŒì§€ ëª»í•œ ì ì´ ì•„ì‰¬ì› ìŠµë‹ˆë‹¤. ì‹¤ì œë¡œ í•´ë³¸ ëŠë‚Œìœ¼ë¡œëŠ” kafka ì´í›„ ë°°ì¹˜ íŒŒì´í”„ë¼ì¸ì´ í•„ìš”ì—†ì–´ì§ˆ ìˆ˜ ìˆê² ë‹¤ëŠ” ìƒê°ê³¼ kafkaì—ì„œ supersetìœ¼ë¡œ ë°”ë¡œ ì—°ê²°ê°€ëŠ¥í•œ ì†”ë£¨ì…˜ì´ ìˆì—ˆìœ¼ë©´ ì¢‹ê² ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.
</a></figure>
:ET