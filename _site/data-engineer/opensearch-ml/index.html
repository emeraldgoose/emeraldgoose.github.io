<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Reranking - Opensearch - gooooooooooose</title>
<meta name="title" content="Reranking - Opensearch">
<meta name="description" content="Reranker 문서 검색 과정에서 문서를 임베딩 벡터로 변환하는 과정과 검색 시간 단축을 위해 Approximate Nearest Neighbor search(ANNs)와 같이 근사시키는 기술로 인해 정보 손실이 발생합니다. 이로 인해 필요한 문서가 누락되는 경우가 발생할 수 있지만 가져오는 문서의 개수 k를 조정하여 해결할 수 있습니다. 하지만, 문서의 순위가 낮아지므로 LLM이 해당 문서를 참조하지 않을 수 있고 LLM 토큰 비용도 증가하기 때문에 비효율적이게 됩니다.  그래서 Reranker를 도입하여 Retriever로부터 가져온 문서와 유저 질문 사이 관련성을 측정하여 순위를 재조정하여 관련이 높은 문서의 순위를 높이는 방법을 사용하게 됩니다.">


  <meta name="author" content="goooose">
  
  <meta property="article:author" content="goooose">
  


<!-- open-graph tags -->
<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="gooooooooooose">
<meta property="og:title" content="Reranking - Opensearch">
<meta property="og:url" content="http://localhost:4000/data-engineer/opensearch-ml/">


  <meta property="og:description" content="Reranker 문서 검색 과정에서 문서를 임베딩 벡터로 변환하는 과정과 검색 시간 단축을 위해 Approximate Nearest Neighbor search(ANNs)와 같이 근사시키는 기술로 인해 정보 손실이 발생합니다. 이로 인해 필요한 문서가 누락되는 경우가 발생할 수 있지만 가져오는 문서의 개수 k를 조정하여 해결할 수 있습니다. 하지만, 문서의 순위가 낮아지므로 LLM이 해당 문서를 참조하지 않을 수 있고 LLM 토큰 비용도 증가하기 때문에 비효율적이게 됩니다.  그래서 Reranker를 도입하여 Retriever로부터 가져온 문서와 유저 질문 사이 관련성을 측정하여 순위를 재조정하여 관련이 높은 문서의 순위를 높이는 방법을 사용하게 됩니다.">







  <meta property="article:published_time" content="2025-02-17T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/data-engineer/opensearch-ml/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "emeraldgoose",
      "url": "http://localhost:4000/"
    
  }
</script>


  <meta name="google-site-verification" content="googleb34ce5276ba6573e" />





  <meta name="naver-site-verification" content="naver93cdc79a5629ab3736d7cf8ff7b51d80">


<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- Lightbox2 -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox-plus-jquery.js" integrity="sha512-oaWLach/xXzklmJDBjHkXngTCAkPch9YFqOSphnw590sy86CVEnAbcpw17QjkUGppGmVJojwqHmGO/7Xxx6HCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox-plus-jquery.min.js" integrity="sha512-U9dKDqsXAE11UA9kZ0XKFyZ2gQCj+3AwZdBMni7yXSvWqLFEj8C1s7wRmWl9iyij8d5zb4wm56j4z/JVEwS77g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#data-engineer" itemprop="item"><span itemprop="name">Data engineer</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Reranking - Opensearch</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="/assets/images/bio-photo.png" alt="goooose" itemprop="image" class="u-photo" width="110px" height="110px">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">goooose</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Interested in ML/DL, Data Engineering.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">South Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:smk6221@naver.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://github.com/emeraldgoose" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/minseong-kim-84428b231/" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://gooooooooooose.tistory.com/" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Problem Solving OJ (KOR)</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Reranking - Opensearch">
    <meta itemprop="description" content="Reranker문서 검색 과정에서 문서를 임베딩 벡터로 변환하는 과정과 검색 시간 단축을 위해 Approximate Nearest Neighbor search(ANNs)와 같이 근사시키는 기술로 인해 정보 손실이 발생합니다. 이로 인해 필요한 문서가 누락되는 경우가 발생할 수 있지만 가져오는 문서의 개수 k를 조정하여 해결할 수 있습니다. 하지만, 문서의 순위가 낮아지므로 LLM이 해당 문서를 참조하지 않을 수 있고 LLM 토큰 비용도 증가하기 때문에 비효율적이게 됩니다. 그래서 Reranker를 도입하여 Retriever로부터 가져온 문서와 유저 질문 사이 관련성을 측정하여 순위를 재조정하여 관련이 높은 문서의 순위를 높이는 방법을 사용하게 됩니다.">
    <meta itemprop="datePublished" content="2025-02-17T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Reranking - Opensearch
</h1>
          
<!--
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  0 minute read
</p>
            devinlife comments :
                싱글 페이지(포스트)에 제목 밑에 Updated 시간 표기
                기존에는 read_time이 표기. read_time -> date 변경
-->
            <p class="page__date"><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated: <time datetime="2025-02-17T00:00:00+09:00">February 17, 2025</time></p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <h2 id="reranker">Reranker</h2>
<p>문서 검색 과정에서 문서를 임베딩 벡터로 변환하는 과정과 검색 시간 단축을 위해 Approximate Nearest Neighbor search(ANNs)와 같이 근사시키는 기술로 인해 정보 손실이 발생합니다. 이로 인해 필요한 문서가 누락되는 경우가 발생할 수 있지만 가져오는 문서의 개수 k를 조정하여 해결할 수 있습니다. 하지만, 문서의 순위가 낮아지므로 LLM이 해당 문서를 참조하지 않을 수 있고 LLM 토큰 비용도 증가하기 때문에 비효율적이게 됩니다. 
그래서 Reranker를 도입하여 Retriever로부터 가져온 문서와 유저 질문 사이 관련성을 측정하여 순위를 재조정하여 관련이 높은 문서의 순위를 높이는 방법을 사용하게 됩니다.</p>

<h2 id="opensearch-machine-learning">Opensearch Machine Learning</h2>
<p>RAG 시스템에 Reranker를 추가하려면 AWS Sagemaker와 같은 클라우드 서비스에 배포하거나 추가적인 자원이 없다면 Cohere.ai와 같은 상용 서비스를 사용해야 합니다. 
만약 Opensearch 클러스터를 운영하고 있다면 대안으로 Opensearch 클러스터에 직접 아티팩트를 배포할 수 있고 REST API를 통해 모델을 사용할 수 있습니다. 또한, 파이프라인에 포함시킬 수도 있습니다.</p>

<h3 id="settings">Settings</h3>
<p>프로덕션 환경에서의 Opensearch의 ML 작업은 ML 노드에서 실행하는 것을 추천합니다. 
프로덕션 환경이라면 아래 쿼리에서 <code class="language-plaintext highlighter-rouge">plugins.ml_commons.only_run_on_ml_node: true</code>로 설정합니다. 그렇지 않다면 아무 노드에서나 ml 작업을 할 수 있도록 <code class="language-plaintext highlighter-rouge">false</code>로 설정합니다. 
<code class="language-plaintext highlighter-rouge">native_memory_threshold</code> 옵션은 ML작업을 하는데 메모리 사용률 한계를 설정할 수 있습니다. 100이면 아무런 제한도 하지 않는 것이고 90이라면 90%까지 허용하며 넘어가는 경우 에러를 일으키게 됩니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_cluster/settings</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"persistent"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"plugins.ml_commons.only_run_on_ml_node"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"plugins.ml_commons.model_access_control_enabled"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"plugins.ml_commons.native_memory_threshold"</span><span class="p">:</span><span class="w"> </span><span class="s2">"99"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="register-a-model-group">Register a model group</h3>
<p>ML 모델을 배포하기 전에 모델 그룹을 먼저 등록해야 합니다. 모델 그룹의 역할은 모델 버전을 관리하는 것입니다. 추가로 접근 제어에도 활용되어 public, private, restricted 세 가지 액세스 모드 중 하나를 선택할 수 있습니다.
모델 그룹을 등록하려면 다음 요청을 보내야 합니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/_plugins/_ml/model_groups/_register</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"local_model_group"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A model group for local models"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>요청이 올바르게 전달되었다면 다음의 응답을 받게 됩니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"model_group_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"wlcnb4kBJ1eYAeTMHlV6"</span><span class="p">,</span><span class="w">
 </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CREATED"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="register-a-model">Register a model</h3>
<p>모델을 등록하는 단계입니다. Opensearch에서 제공하는 pretrained model 또는 Custom model를 등록할 수 있습니다. Custom model인 경우, torchscript로 변환되어 있어야 합니다. Opensearch에서 제공하는 Reranking 모델인 <code class="language-plaintext highlighter-rouge">cross-encoders/ms-marco-MiniLM-L-12-v2</code>를 배포하겠습니다.</p>

<p>아래 요청에서 <code class="language-plaintext highlighter-rouge">model_group_id는</code> 위에서 등록된 <code class="language-plaintext highlighter-rouge">model_group_id</code>와 같아야 합니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/_plugins/_ml/models/_register</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cross-encoders/ms-marco-MiniLM-L-12-v2"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.2"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The model can be used for Information Retrieval: Given a query, encode the query will all possible passages (e.g. retrieved with ElasticSearch). Then sort the passages in a decreasing order."</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"model_group_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"wlcnb4kBJ1eYAeTMHlV6"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"model_format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TORCH_SCRIPT"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"function_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TEXT_SIMILARITY"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"model_task_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TEXT_SIMILARITY"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"model_content_hash_value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"628183b3d249dd45b82626972828125f7ad98c3b11c0ef1f2261c575600102d6"</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"model_config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"model_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bert"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"embedding_dimension"</span><span class="p">:</span><span class="w"> </span><span class="mi">384</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"framework_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"huggingface_transformers"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"all_config"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">_name_or_path</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">cross-encoder/ms-marco-MiniLM-L-6-v2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">architectures</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\n</span><span class="s2">    </span><span class="se">\"</span><span class="s2">BertForSequenceClassification</span><span class="se">\"\n</span><span class="s2">  ],</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">attention_probs_dropout_prob</span><span class="se">\"</span><span class="s2">: 0.1,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">classifier_dropout</span><span class="se">\"</span><span class="s2">: null,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">gradient_checkpointing</span><span class="se">\"</span><span class="s2">: false,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">hidden_act</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">gelu</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">hidden_dropout_prob</span><span class="se">\"</span><span class="s2">: 0.1,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">hidden_size</span><span class="se">\"</span><span class="s2">: 384,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">id2label</span><span class="se">\"</span><span class="s2">: {</span><span class="se">\n</span><span class="s2">    </span><span class="se">\"</span><span class="s2">0</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">LABEL_0</span><span class="se">\"\n</span><span class="s2">  },</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">initializer_range</span><span class="se">\"</span><span class="s2">: 0.02,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">intermediate_size</span><span class="se">\"</span><span class="s2">: 1536,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">label2id</span><span class="se">\"</span><span class="s2">: {</span><span class="se">\n</span><span class="s2">    </span><span class="se">\"</span><span class="s2">LABEL_0</span><span class="se">\"</span><span class="s2">: 0</span><span class="se">\n</span><span class="s2">  },</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">layer_norm_eps</span><span class="se">\"</span><span class="s2">: 1e-12,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">max_position_embeddings</span><span class="se">\"</span><span class="s2">: 512,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">model_type</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">bert</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">num_attention_heads</span><span class="se">\"</span><span class="s2">: 12,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">num_hidden_layers</span><span class="se">\"</span><span class="s2">: 6,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">pad_token_id</span><span class="se">\"</span><span class="s2">: 0,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">position_embedding_type</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">absolute</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">sbert_ce_default_activation_function</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">torch.nn.modules.linear.Identity</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">transformers_version</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">4.22.1</span><span class="se">\"</span><span class="s2">,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">type_vocab_size</span><span class="se">\"</span><span class="s2">: 2,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">use_cache</span><span class="se">\"</span><span class="s2">: true,</span><span class="se">\n</span><span class="s2">  </span><span class="se">\"</span><span class="s2">vocab_size</span><span class="se">\"</span><span class="s2">: 30522</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n</span><span class="s2">"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"created_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1676073973126</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://artifacts.opensearch.org/models/ml-models/huggingface/cross-encoders/ms-marco-MiniLM-L-12-v2/1.0.2/torch_script/cross-encoders_ms-marco-MiniLM-L-12-v2-1.0.2-torch_script.zip"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>요청이 올바르게 전달되었으면 아래와 같은 응답을 받게 됩니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"task_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cVeMb4kBJ1eYAeTMFFgj"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CREATED"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>task_id를 이용해 태스크 상태를 조회할 수 있습니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /_plugins/_ml/tasks/cVeMb4kBJ1eYAeTMFFgj
</code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cleMb4kBJ1eYAeTMFFg4"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"task_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"REGISTER_MODEL"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TEXT_SIMILARITY"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COMPLETED"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"worker_node"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"XPcXLV7RQoi5m8NI_jEOVQ"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1689793598499</span><span class="p">,</span><span class="w">
  </span><span class="nl">"last_update_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1689793598530</span><span class="p">,</span><span class="w">
  </span><span class="nl">"is_async"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>조회 결과로 <code class="language-plaintext highlighter-rouge">model_id</code>가 없고 state가 <code class="language-plaintext highlighter-rouge">CREATED</code> 상태라면 아직 아티팩트를 다운로드 받고 있는 것이므로 기다려야 합니다. state가 <code class="language-plaintext highlighter-rouge">FAILED</code>라면 <code class="language-plaintext highlighter-rouge">error</code>가 응답에 포함됩니다. 여기서 <code class="language-plaintext highlighter-rouge">model_id</code>를 따로 메모합니다.</p>

<h3 id="deploy-a-model">Deploy a model</h3>
<p>모델 인덱스로부터 읽어와 메모리에 모델을 적재하는 단계입니다. 모델을 메모리에 올리기 위해 다음의 요청을 실행합니다. /models 다음에는 위 단계에서의 <code class="language-plaintext highlighter-rouge">model_id</code>를 넣어줍니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /_plugins/_ml/models/cleMb4kBJ1eYAeTMFFg4/_deploy
</code></pre></div></div>
<p>이전처럼 응답으로부터 task_id를 받을 수 있는데 마찬가지로 태스크를 조회할 수 있습니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"task_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vVePb4kBJ1eYAeTM7ljG"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CREATED"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /_plugins/_ml/tasks/vVePb4kBJ1eYAeTM7ljG
</code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"model_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cleMb4kBJ1eYAeTMFFg4"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"task_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DEPLOY_MODEL"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TEXT_EMBEDDING"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COMPLETED"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"worker_node"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"n-72khvBTBi3bnIIR8FTTw"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1689793851077</span><span class="p">,</span><span class="w">
  </span><span class="nl">"last_update_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1689793851101</span><span class="p">,</span><span class="w">
  </span><span class="nl">"is_async"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>배포 도중이라면 state가 <code class="language-plaintext highlighter-rouge">RUNNING</code>일 것이고 완료되었다면 위와 같이 <code class="language-plaintext highlighter-rouge">COMPLETED</code>로 표시됩니다.</p>

<p>모델 배포가 완료되었다면 Opensearch Dashboard에서 모델 리스트를 확인할 수 있습니다. Opensearch plugins &gt; Machine Learning 탭에서 다음의 사진처럼 모델 목록을 확인할 수 있습니다.</p>

<figure>
    <img src="https://opensearch.org/docs/latest/images/ml/ml-dashboard/deployed-models.png" alt="01" style="max-width: 100%; height: auto;" />
    <figcaption>Opensearch Dashboard Machine Learning (refs: https://opensearch.org/docs/latest/ml-commons-plugin/ml-dashboard/)</figcaption>
</figure>

<p>배포가 완료되었다면 Status에 Responding이라고 표시됩니다.</p>

<h3 id="reranker-predict">Reranker Predict</h3>
<p>모델을 사용할 때는 아래의 요청을 보내야 합니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">_plugins/_ml/models/&lt;model_id&gt;/_predict</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"query_text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"today is sunny"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"text_docs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"how are you"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"today is sunny"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"today is july fifth"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"it is winter"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>이 요청의 응답으로 다음과 같이 오게 됩니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"inference_results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"output"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"similarity"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"data_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FLOAT32"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"shape"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mf">-6.077798</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"byte_buffer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"array"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Un3CwA=="</span><span class="p">,</span><span class="w">
            </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LITTLE_ENDIAN"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"output"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"similarity"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"data_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FLOAT32"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"shape"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mf">10.223609</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"byte_buffer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"array"</span><span class="p">:</span><span class="w"> </span><span class="s2">"55MjQQ=="</span><span class="p">,</span><span class="w">
            </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LITTLE_ENDIAN"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"output"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"similarity"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"data_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FLOAT32"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"shape"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mf">-1.3987057</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"byte_buffer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"array"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ygizvw=="</span><span class="p">,</span><span class="w">
            </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LITTLE_ENDIAN"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"output"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"similarity"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"data_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FLOAT32"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"shape"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mf">-4.5923924</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"byte_buffer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"array"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4fSSwA=="</span><span class="p">,</span><span class="w">
            </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LITTLE_ENDIAN"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>만약 <code class="language-plaintext highlighter-rouge">opensearchpy</code>라이브러리를 이용하고 있다면 아래의 코드로 구현할 수 있습니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">opensearchpy</span> <span class="kn">import</span> <span class="n">OpenSearch</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Opensearch</span><span class="p">(</span>
    <span class="n">hosts</span><span class="o">=</span><span class="p">[{</span><span class="s">'host'</span><span class="p">:</span><span class="s">'localhost'</span><span class="p">,</span><span class="s">'port'</span><span class="p">:</span><span class="mi">9200</span><span class="p">}],</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"query_text"</span><span class="p">:</span> <span class="s">"today is sunny"</span><span class="p">,</span>
    <span class="s">"text_docs"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">"how are you"</span><span class="p">,</span>
        <span class="s">"today is sunny"</span><span class="p">,</span>
        <span class="s">"today is july fifth"</span><span class="p">,</span>
        <span class="s">"it is winter"</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">perform_request</span><span class="p">(</span>
    <span class="n">method</span><span class="o">=</span><span class="s">'POST'</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s">'/_plugins/_ml/models/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s">/_predict'</span><span class="p">,</span>
    <span class="n">body</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>실제로 모델을 돌려보면서 payload의 구성이 궁금해서 opensearch-project github를 찾아봤습니다. 
predict 요청을 보내면 Request를 처리하는데 MLInput 클래스에 사용자 입력들이 들어가게 됩니다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// opensearch-project/ml-commons/blob/main/common/src/main/java/org/opensearch/ml/common/input/MLInput.java</span>

<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MLInput</span> <span class="kd">implements</span> <span class="nc">Input</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ALGORITHM_FIELD</span> <span class="o">=</span> <span class="s">"algorithm"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ML_PARAMETERS_FIELD</span> <span class="o">=</span> <span class="s">"parameters"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">INPUT_INDEX_FIELD</span> <span class="o">=</span> <span class="s">"input_index"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">INPUT_QUERY_FIELD</span> <span class="o">=</span> <span class="s">"input_query"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">INPUT_DATA_FIELD</span> <span class="o">=</span> <span class="s">"input_data"</span><span class="o">;</span>

    <span class="c1">// For trained model</span>
    <span class="c1">// Return bytes in model output</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RETURN_BYTES_FIELD</span> <span class="o">=</span> <span class="s">"return_bytes"</span><span class="o">;</span>
    <span class="c1">// Return bytes in model output. This can be used together with return_bytes.</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RETURN_NUMBER_FIELD</span> <span class="o">=</span> <span class="s">"return_number"</span><span class="o">;</span>
    <span class="c1">// Filter target response with name in model output</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TARGET_RESPONSE_FIELD</span> <span class="o">=</span> <span class="s">"target_response"</span><span class="o">;</span>
    <span class="c1">// Filter target response with position in model output</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TARGET_RESPONSE_POSITIONS_FIELD</span> <span class="o">=</span> <span class="s">"target_response_positions"</span><span class="o">;</span>
    <span class="c1">// Input text sentences for text embedding model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TEXT_DOCS_FIELD</span> <span class="o">=</span> <span class="s">"text_docs"</span><span class="o">;</span>
    <span class="c1">// Input query text to compare against for text similarity model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUERY_TEXT_FIELD</span> <span class="o">=</span> <span class="s">"query_text"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PARAMETERS_FIELD</span> <span class="o">=</span> <span class="s">"parameters"</span><span class="o">;</span>

    <span class="c1">// Input question in question answering model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUESTION_FIELD</span> <span class="o">=</span> <span class="s">"question"</span><span class="o">;</span>

    <span class="c1">// Input context in question answering model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CONTEXT_FIELD</span> <span class="o">=</span> <span class="s">"context"</span><span class="o">;</span>

    <span class="c1">// Algorithm name</span>
    <span class="kd">protected</span> <span class="nc">FunctionName</span> <span class="n">algorithm</span><span class="o">;</span>
    <span class="c1">// ML algorithm parameters</span>
    <span class="kd">protected</span> <span class="nc">MLAlgoParams</span> <span class="n">parameters</span><span class="o">;</span>
    <span class="c1">// Input data to train model, run trained model to predict or run ML algorithms(no-model-based) directly.</span>
    <span class="kd">protected</span> <span class="nc">MLInputDataset</span> <span class="n">inputDataset</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</code></pre></div></div>
<p>만약에 다른 모델을 사용할 때 필요한 field를 위에 있는 field 이름을 요청에 포함하면 됩니다.</p>

<h3 id="한국어-문서로-테스트">한국어 문서로 테스트</h3>
<p>한국어 문서를 이용해 테스트를 진행했습니다. 경제 관련 문서들이 저장되어 있고 아래 쿼리를 이용해 결과를 확인했습니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">Lexical</span><span class="w"> </span><span class="err">Search</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"must"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024 하반기 은행 가계대출 변화량을 설명해봐"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"minimum_should_match"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0%"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"operator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"or"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">Lexical</span><span class="w"> </span><span class="err">Search</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">Rerank</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"must"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024 하반기 은행 가계대출 변화량을 설명해봐"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"minimum_should_match"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0%"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"operator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"or"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"ext"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rerank"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query_context"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"query_text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024 하반기 은행 가계대출 변화량을 설명해봐"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Rerank를 쿼리로 사용하려면 pipeline 정의가 필요합니다. 저는 아래 요청을 통해 파이프라인을 정의했습니다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/_search/pipeline/rerank_pipeline</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"response_processors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"rerank"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"ml_opensearch"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"model_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{model_id}"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"context"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"document_fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"{passage_text_field}"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>그 결과로 아래 이미지와 같이 Lexical search만 사용한 결과와 Rerank 모델을 같이 사용한 결과가 다름을 알 수 있습니다. 
왼쪽은 Lexical search만 사용한 결과이고 오른쪽은 Lexical search + Rerank를 사용한 결과입니다.
아래 이미지처럼 왼쪽의 4위에 위치한 문서가 Reranker로 인해 1위로 올라오는 것처럼 순위를 재조정한 결과를 볼 수 있습니다.</p>

<figure class="half">
  <a href="https://lh3.googleusercontent.com/d/1j5YfrSJw9SLLRQlorbGL3optQR9gJg_D" onclick="return false;" data-lightbox="gallery">
    <img src="https://lh3.googleusercontent.com/d/1j5YfrSJw9SLLRQlorbGL3optQR9gJg_D" alt="02" style="max-width: 100%; height: auto;" />
  </a>
  <a href="https://lh3.googleusercontent.com/d/1SrB8HE_f5oo60dNTwXPBH1Yskyu3I9O4" onclick="return false;" data-lightbox="gallery">
    <img src="https://lh3.googleusercontent.com/d/1SrB8HE_f5oo60dNTwXPBH1Yskyu3I9O4" alt="02" style="max-width: 100%; height: auto;" />
  </a>
  <figcaption>사실 ms-marco-minilm-l-12-v2 모델은 영어만 지원하는데 어떻게 원하는 문서의 순위가 올라갔는지는 잘 모르겠습니다</figcaption>
</figure>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#data-engineering" class="page__taxonomy-item p-category" rel="tag">data-engineering</a><span class="sep">, </span>
    
      <a href="/tags/#opensearch" class="page__taxonomy-item p-category" rel="tag">Opensearch</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#data-engineer" class="page__taxonomy-item p-category" rel="tag">data-engineer</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2025-02-17T00:00:00+09:00">February 17, 2025</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/github/code-review-action/" class="pagination--pager" title="Github Action 코드리뷰 봇 만들기(Gemini-1.5-flash)
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/github/code-review-action/" rel="permalink">Github Action 코드리뷰 봇 만들기(Gemini-1.5-flash)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> October 16 2024</p>
    
    <p class="archive__item-excerpt" itemprop="description">Github Action 설정
Github Action은 사용자가 원하는 트리거에 따라 워크플로우를 실행할 수 있는 CI(Continuous Integration) 도구입니다. 구글의 Gemini-1.5-flash 모델을 사용하여 Pull Request시 코드 변경사항에 대해 LL...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/data-engineer/kafka-pipeline/" rel="permalink">ksqlDB: 실시간 데이터 처리 후 시각화까지
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> September 03 2024</p>
    
    <p class="archive__item-excerpt" itemprop="description">ksqlDB
ksqlDB는 Kafka Streams에 기반하는 SQL 엔진입니다. ksqlDB는 Kafka topic에 이벤트 스트리밍 애플리케이션을 구축할 수 있는 쿼리 계층을 제공합니다. Kafka Streams와 달리 ksqlDB는 SQL로 새로운 스트림을 생성하거나 Mate...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pytorch/transformer-scratch-implementation-2/" rel="permalink">python으로 Transformer 바닥부터 구현하기[2] (Transformer)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> August 01 2024</p>
    
    <p class="archive__item-excerpt" itemprop="description">Objective
앞에서 구현한 LayerNorm, MultiHeadAttention, GELU를 사용하고 이전에 구현해둔 Linear, Dropout, Softmax 클래스를 사용하여 Transformer 클래스를 구현하여 테스트해봅니다.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pytorch/transformer-scratch-implementation-1/" rel="permalink">python으로 Transformer 바닥부터 구현하기[1] (MultiHead-Attention, LayerNorm, GELU)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> July 31 2024</p>
    
    <p class="archive__item-excerpt" itemprop="description">Transformer
트랜스포머(Transformer)는 2017년에 등장한 모델입니다. Attention is all you need 논문은 트랜스포머 모델에 대해 설명하고 있으며 이후 BERT, GPT라는 새로운 모델을 탄생시키는 배경이 됩니다.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 emeraldgoose. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'emeraldgoose/emeraldgoose.github.io');
    script.setAttribute('issue-term', 'pathname');
    
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  




<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
  inlineMath: [['$','$']],
  displayMath: [['$$','$$']],
  processEscapes: true
  },
  "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

  </body>
</html>
