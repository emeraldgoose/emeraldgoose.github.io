<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>ksqlDB: 실시간 데이터 처리 후 시각화까지 - gooooooooooose</title>
<meta name="title" content="ksqlDB: 실시간 데이터 처리 후 시각화까지">
<meta name="description" content="ksqlDB ksqlDB는 Kafka Streams에 기반하는 SQL 엔진입니다. ksqlDB는 Kafka topic에 이벤트 스트리밍 애플리케이션을 구축할 수 있는 쿼리 계층을 제공합니다. Kafka Streams와 달리 ksqlDB는 SQL로 새로운 스트림을 생성하거나 Materialized View를 생성할 수 있습니다.">


  <meta name="author" content="goooose">
  
  <meta property="article:author" content="goooose">
  


<!-- open-graph tags -->
<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="gooooooooooose">
<meta property="og:title" content="ksqlDB: 실시간 데이터 처리 후 시각화까지">
<meta property="og:url" content="http://localhost:4000/data-engineer/kafka-pipeline/">


  <meta property="og:description" content="ksqlDB ksqlDB는 Kafka Streams에 기반하는 SQL 엔진입니다. ksqlDB는 Kafka topic에 이벤트 스트리밍 애플리케이션을 구축할 수 있는 쿼리 계층을 제공합니다. Kafka Streams와 달리 ksqlDB는 SQL로 새로운 스트림을 생성하거나 Materialized View를 생성할 수 있습니다.">







  <meta property="article:published_time" content="2024-09-03T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/data-engineer/kafka-pipeline/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "emeraldgoose",
      "url": "http://localhost:4000/"
    
  }
</script>


  <meta name="google-site-verification" content="googleb34ce5276ba6573e" />





  <meta name="naver-site-verification" content="naver93cdc79a5629ab3736d7cf8ff7b51d80">


<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- Lightbox2 -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox-plus-jquery.js" integrity="sha512-oaWLach/xXzklmJDBjHkXngTCAkPch9YFqOSphnw590sy86CVEnAbcpw17QjkUGppGmVJojwqHmGO/7Xxx6HCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox-plus-jquery.min.js" integrity="sha512-U9dKDqsXAE11UA9kZ0XKFyZ2gQCj+3AwZdBMni7yXSvWqLFEj8C1s7wRmWl9iyij8d5zb4wm56j4z/JVEwS77g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#data-engineer" itemprop="item"><span itemprop="name">Data engineer</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">ksqlDB: 실시간 데이터 처리 후 시각화까지</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="/assets/images/bio-photo.png" alt="goooose" itemprop="image" class="u-photo" width="110px" height="110px">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">goooose</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Interested in ML/DL, Data Engineering.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">South Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:smk6221@naver.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://github.com/emeraldgoose" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/minseong-kim-84428b231/" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://gooooooooooose.tistory.com/" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Problem Solving OJ (KOR)</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="ksqlDB: 실시간 데이터 처리 후 시각화까지">
    <meta itemprop="description" content="ksqlDBksqlDB는 Kafka Streams에 기반하는 SQL 엔진입니다. ksqlDB는 Kafka topic에 이벤트 스트리밍 애플리케이션을 구축할 수 있는 쿼리 계층을 제공합니다. Kafka Streams와 달리 ksqlDB는 SQL로 새로운 스트림을 생성하거나 Materialized View를 생성할 수 있습니다.">
    <meta itemprop="datePublished" content="2024-09-03T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">ksqlDB: 실시간 데이터 처리 후 시각화까지
</h1>
          
<!--
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  0 minute read
</p>
            devinlife comments :
                싱글 페이지(포스트)에 제목 밑에 Updated 시간 표기
                기존에는 read_time이 표기. read_time -> date 변경
-->
            <p class="page__date"><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated: <time datetime="2024-09-03T00:00:00+09:00">September 03, 2024</time></p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <h1 id="ksqldb">ksqlDB</h1>
<p>ksqlDB는 Kafka Streams에 기반하는 SQL 엔진입니다. ksqlDB는 Kafka topic에 이벤트 스트리밍 애플리케이션을 구축할 수 있는 쿼리 계층을 제공합니다. Kafka Streams와 달리 ksqlDB는 SQL로 새로운 스트림을 생성하거나 Materialized View를 생성할 수 있습니다.</p>

<h2 id="왜-ksqldb">왜 ksqlDB?</h2>
<p>다음과 같이 실시간 데이터를 처리하기 위한 파이프라인을 가정해볼 수 있습니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Source Database -&gt; CDC(Debezium-connector) -&gt; Kafka Cluster -&gt; Kafka-sink-connector -&gt; Sink Database
</code></pre></div></div>

<p>만약, 실시간 처리가 필요한 데이터가 개인정보라면 Kafka Cluster에서 개인식별 정보를 마스킹 작업을 하는 스트리밍 프로세스가 추가되어야 합니다. 또는 kafka connector를 직접 개발하여 중간에 데이터를 처리하는 로직을 추가해야 할지도 모릅니다.</p>

<p>하지만, ksqlDB는 스트리밍 데이터 파이프라인을 작성할 수 있고 Kafka를 저장소로 활용하게 됩니다. 여러개의 스트림과 테이블을 sql로 관리할 수 있어 번거로운 과정을 줄일 수 있습니다. 단순히 스트림이나 테이블을 생성하는 것이 아닌 SQL처럼 스트림-스트림, 스트림-테이블, 테이블-테이블을 조인할 수도 있습니다.</p>

<h2 id="persistent-push-pull-query">Persistent, Push, Pull query</h2>
<ol>
  <li>
    <p>Persistent Query:<br />
Persistent query는 이벤트 행을 무기한으로 처리하는 서버측 쿼리입니다. <code class="language-plaintext highlighter-rouge">CREATE STREAM AS SELECT</code>나 <code class="language-plaintext highlighter-rouge">CREATE TABLE AS SELECT</code>가 이에 해당합니다.</p>
  </li>
  <li>
    <p>Push Query:<br />
Push query는 클라이언트가 실시간으로 변경된는 결과를 구독하는 쿼리입니다. push query를 사용하면 스트림이나 테이블의 결과를 실시간으로 받아볼 수 있습니다. 이러한 쿼리는 비동기 작업에 적합한 쿼리입니다.</p>
  </li>
  <li>
    <p>Pull Query:<br />
Pull query는 클라이언트가 현재 결과를 가져오게 하는 쿼리입니다. 새 이벤트가 도착하면 pull query를 통해 Materialized View를 업데이트합니다. 이러한 쿼리는 요청/응답 작업에 적합한 쿼리입니다.</p>
  </li>
</ol>

<h2 id="파이프라인">파이프라인</h2>
<blockquote>
  <p>파이프라인을 구축할 때는 Docker Desktop에서 제공하는 쿠버네티스를 사용했고 모니터링 툴은 k9s와 Docker Desktop을 이용했습니다.</p>
</blockquote>

<blockquote>
  <p>로컬 쿠버네티스를 이용하므로 하나의 노드만 사용하게 됩니다. 그래서 각각의 네임스페이스를 생성하고 네임스페이스에 맞게 배포했습니다.</p>
</blockquote>
<figure>
  <a href="https://github.com/user-attachments/assets/8f4dacc6-dd6b-449a-8bd0-1c2b1c755c64" onclick="return false;" data-lightbox="gallery">
    <img src="https://github.com/user-attachments/assets/8f4dacc6-dd6b-449a-8bd0-1c2b1c755c64" alt="01" style="max-width: 100%; height: auto;" />
  </a>
  <figcaption>pipeline</figcaption>
</figure>

<h3 id="데이터-생성">데이터 생성</h3>
<p>Source 데이터베이스인 Postgresql에 가상의 은행 데이터를 생성하여 적재했습니다.</p>

<p>account, bank_transaction, transaction_log 테이블을 만들고 sqlalchemy를 이용해 source db에 데이터를 적재했습니다. 아래는 테이블의 스키마를 정의한 것입니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># entities.py
</span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">TIMESTAMP</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'account'</span>

    <span class="n">account_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">account_holder_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># hash
</span>    <span class="n">account_balance</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Transaction</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">"bank_transaction"</span>
    
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Account</span><span class="p">.</span><span class="n">account_id</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># deposit, withdraw
</span>

<span class="k">class</span> <span class="nc">Transaction_log</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'transaction_log'</span>
    
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Transaction</span><span class="p">.</span><span class="nb">id</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># Success, Failed
</span></code></pre></div></div>

<p>랜덤하게 계좌를 생성하거나 거래를 시도하게 되고 거래 시 금액도 랜덤하게 결정됩니다. 만약 출금시 계좌 잔액이 부족한 경우 bank_transaction 테이블에 기록되지 않지만 로그는 남게 했습니다. 그래서 transaction_log 테이블에 모든 거래 시도에 대해 성공 혹은 실패를 기록하게 됩니다.</p>

<h3 id="postgres-배포">Postgres 배포</h3>
<p>가장 먼저 생성된 데이터를 적재할 source 데이터베이스를 배포합니다. 가장 많이 사용해본 Postgresql을 k8s에 배포하기 위해 deployment.yaml, configmap.yaml, service.yaml을 작성했습니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># postgresql/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    postgresql: postgresql
  name: postgresql
spec:
  replicas: 1
  selector:
    matchLabels:
      postgresql: postgresql
  template:
    metadata:
      labels:
        postgresql: postgresql
    spec:
      containers:
        - name: postgresql
          image: bitnami/postgresql:latest
          env:
            - name: POSTGRESQL_PASSWORD
              value: postgres
          volumeMounts:
            - name: postgres-config-volume
              mountPath: /bitnami/postgresql/conf/postgresql.conf
              subPath: postgresql.conf
          ports:
            - containerPort: 5432 # original port 5432
      hostname: postgresql
      volumes:
        - name: postgres-config-volume
          configMap:
            name: postgres-config
</code></pre></div></div>
<p>configmap은 postgresql이 initdb를 실행할 때 설정값을 변경하기 위해 필요합니다.</p>

<p>listen_address는 기본값이 127.0.0.1이므로 다른 파드에서 접근하기 위해 모두 허용하는 0.0.0.0으로 변경해야 합니다. wal_level(Write Ahead Log)는 Debezium에서 캡쳐를 위해 logical 설정이 필요하기 때문에 변경했습니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># postgresql/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
data:
  postgresql.conf: |
    wal_level = logical
    listen_addresses = '0.0.0.0'
</code></pre></div></div>

<p>service.yaml은 내부 도메인을 이용하므로 포트만 연결해줍니다. 클러스터 내 파드와 연결된 서비스끼리 통신할 수 있도록 <code class="language-plaintext highlighter-rouge">{pod.spec.hostname}.{namespace}.svc.cluster.local</code>이라는 도메인이 자동 부여되고 파드 내에서만 사용할 수 있습니다. 저 도메인을 사용하려면 hostname을 deployment.yaml에 넣어줘야 합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># postgresql/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    postgresql: postgresql
  name: postgresql
spec:
  type: ClusterIP
  ports:
    - name: "5432"
      port: 5432
      targetPort: 5432
  selector:
    postgresql: postgresql
</code></pre></div></div>

<p>아래 명령어를 입력하여 postgresql을 배포합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns postgres
kubectl apply -f postgres/ -n postgres
</code></pre></div></div>

<p>postgresql이 배포되면 기본적으로 postgres 데이터베이스가 생성됩니다. 다음 Kafka로부터 데이터를 받을 sink 데이터베이스를 생성하기 위해 아래 명령어를 확인해서 pod 이름을 조회한 후 파드에 접속해 sink 데이터베이스를 생성합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get po -n postgres
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it &lt;postgresql-pod-name&gt; -n postgres -- createdb -U postgres sink
</code></pre></div></div>
<p>명령어를 실행하면 패스워드를 물어보는데 deployment.yaml에 POSTGRESQL_PASSWORD에 설정한 값을 입력합니다.</p>

<p>만약 db가 생성되었는지 확인하고 싶다면 아래 명령어로 확인가능합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it &lt;postgresql-pod-name&gt; -n postgres -- psql -U postgres -c "\list"
</code></pre></div></div>

<p>배포가 완료되면 다음의 명령을 통해 postgres 데이터베이스에 데이터를 적재합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns app
kubectl apply -f producer/deployment.yaml -n app
</code></pre></div></div>

<h3 id="kafka-배포">Kafka 배포</h3>
<p>실시간으로 생성되는 데이터를 캡쳐해서 Sink 데이터베이스로 적재하기 위해 Kafka나 Flink와 같은 스트리밍 플랫폼이 필요합니다. ksqlDB를 사용하는 것이 목적이므로 Kafka를 배포합니다. Kafka는 kafka, kafka-connect, kafka-ui, ksqldb-server, schema-registry, zookeeper를 배포해야 합니다.</p>

<p>저는 deployment, service를 모두 작성하지는 않았고 docker-compose.yml로 먼저 작성 후에 kompose를 사용해서 deployment와 service로 변환 후 환경변수들만 수정해서 사용했습니다. 모든 yaml을 올리는 것은 너무 길어지므로 환경변수들만 작성하겠습니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/broker-deployment.yaml
KAFKA_LISTENERS=INTERNAL://:9092,EXTERNAL://:29092
KAFKA_ADVERTISED_LISTENERS=INTERNAL://broker:9092,EXTERNAL://localhost:29092
KAFKA_BROKER_ID=1
KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/ksqldb-server-deployment.yaml
KSQL_BOOTSTRAP_SERVERS=broker:9092
KSQL_KSQL_LOGGING_PROCESSING_STREAM_AUTO_CREATE=true
KSQL_KSQL_LOGGING_PROCESSING_TOPIC_AUTO_CREATE=true
KSQL_LISTENERS=http://0.0.0.0:28088
KSQL_KSQL_SCHEMA_REGISTRY_URL=http://schema-registry:8081
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/schema-registry-deployment.yaml
SCHEMA_REGISTRY_HOST_NAME=schema-registry.kafka.svc.cluster.local
SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS=broker:9092
SCHEMA_REGISTRY_LISTENERS=http://0.0.0.0:8081
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/zookeeper-deployment.yaml
ZOOKEEPER_CLIENT_PORT=2181
ZOOKEEPER_TICK_TIME=2000
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/kafka-connect-deployment.yaml
CONNECT_BOOTSTRAP_SERVERS=broker:9092
CONNECT_GROUP_ID=1
CONNECT_CONFIG_STORAGE_TOPIC=kafka-configs
CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR=1
CONNECT_OFFSET_STORAGE_TOPIC=kafka-offsets
CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR=1
CONNECT_STATUS_STORAGE_TOPIC=kafka-status
CONNECT_STATUS_STORAGE_REPLICATION_FACTOR=1
CONNECT_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
CONNECT_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
CONNECT_REST_ADVERTISED_HOST_NAME=kafka-connect.kafka.svc.cluster.local
CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL=http://schema-registry:8081
</code></pre></div></div>
<p>postgresql과 연결하기 위해 source connector로 debezium connector를 사용하고 sink connector로 jdbc sink connector를 사용할 것입니다. 카프카 커넥터는 confluent hub를 이용해 설치를 진행합니다. 카프카 커넥터를 배포할 때는 따로 Dockerfile을 작성하고 빌드한 이미지를 사용해야 합니다. Dcokerfile을 작성해야 하는 이유는 confluent-hub로 설치한 커넥터는 목록으로 바로 잡히지 않고 재시작해야 목록으로 잡히기 때문입니다.</p>

<p>실제로 confluentinc/cp-kafka-connect 이미지를 실행시켜 플러그인 설치 직후 <code class="language-plaintext highlighter-rouge">curl -X GET localhost:8083/connector-plugins</code> 명령어로 플러그인 목록을 보게 되면 설치한 플러그인들이 목록으로 나타나지 않습니다. 이 목록에 없다면 당연히 커넥터 설정 시 해당 커넥터를 사용하지 못하기 때문에 배포 전에 플러그인을 받고 커넥터를 시작하는 이미지를 만들어야 합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka-connector/Dockerfile
FROM confluentinc/cp-kafka-connect-base:latest

RUN confluent-hub install --no-prompt confluentinc/kafka-connect-jdbc:10.7.11 &amp;&amp; \
    confluent-hub install --no-prompt debezium/debezium-connector-postgresql:2.5.4
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build --no-cache -t kafka-connector:latest kafka/kafka-connector/
</code></pre></div></div>
<h3 id="kakfa-대시보드-배포">Kakfa 대시보드 배포</h3>
<p>대시보드 배포를 위해 <code class="language-plaintext highlighter-rouge">provectuslabs/kafka-ui</code> 이미지를 사용했습니다. broker 모니터링, kafka-connect, ksqldb 탭을 제공하는 대시보드라서 선택했습니다. 대안으로 confluent/control-center도 있지만 Production 환경에서 라이센스 문제가 있는 것으로 알고 있습니다. 대시보드는 localhost:8080으로 접속할 수 있도록 service.yaml에서 type을 LoadBalancer 혹은 NodePort로 변경해야 합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/kafka-ui-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-ui
spec:
  selector:
    matchLabels:
      app: kafka-ui
  replicas: 1
  template:
    metadata:
      labels:
        app: kafka-ui
    spec:
      containers:
      - name: kafka-ui
        image: provectuslabs/kafka-ui:latest
        ports:
          - containerPort: 8080
        env:
          - name: KAFKA_CLUSTERS_0_NAME
            value: broker
          - name: DYNAMIC_CONFIG_ENABLED
            value: "true"
          - name: KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME
            value: kafka-connect
          - name: KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS
            value: "http://kafka-connect:8083"
          - name: KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS
            value: "broker:9092"
          - name: KAFKA_CLUSTERS_0_ZOOKEEPER
            value: "zookeeper:2181"
          - name: KAFKA_CLUSTERS_0_KSQLDBSERVER
            value: "http://ksqldb-server:28088"
          - name: KAFKA_CLUSTERS_0_SCHEMAREGISTRY
            value: "http://schema-registry:8081"
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kafka/kafka-ui-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: kafka-ui
spec:
  type: LoadBalancer
  selector:
    app: kafka-ui
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f kafka/kafka-ui-deployment.yaml,kafka/kafka-ui-service.yaml -n kafka
</code></pre></div></div>
<p>대시보드가 배포된 후 localhost:8080으로 접속하면 아래와 같은 화면을 볼 수 있습니다.</p>

<figure>
    <a href="https://1drv.ms/i/s!AoC6BbMk0S9Qmzx_0fT-PPlqG5Wm?embed=1&amp;width=2544&amp;height=1195" onclick="return false;" data-lightbox="gallery">
      <img src="https://1drv.ms/i/s!AoC6BbMk0S9Qmzx_0fT-PPlqG5Wm?embed=1&amp;width=2544&amp;height=1195" alt="02" style="max-width: 100%; height: auto;" />
    </a>
    <figcaption>UI For Apache Kafka</figcaption>
</figure>

<p>Kafka Connect와 KSQL DB 탭은 kafka-connect나 ksqldb-server와 연결되지 않으면 사이드바 목록에 나타나지 않습니다. 만약 사이드바에 없다면 kafka-connect와 ksqldb의 상태를 확인해야 합니다.</p>

<p>이전 배포한 Postgresql과 연결하기 위해 Connector를 생성합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "name": "debezium-postgresql-source-connector",
    "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
    "database.hostname": "postgresql.postgres.svc.cluster.local",
    "database.port": "5432",
    "database.user": "postgres",
    "database.password": “postgres”,
    "database.dbname": "postgres",
    "tasks.max": "1",
    "slot.name": "debezium_test",
    "plugin.name": "pgoutput",
    "topic.prefix": "integrate",
    "key.converter": "io.confluent.connect.avro.AvroConverter",
    "key.converter.schemas.enable": "true",
    "key.converter.schema.registry.url": "http://schema-registry.kafka.svc.cluster.local:8081"
    "value.converter": "io.confluent.connect.avro.AvroConverter",
    "value.converter.schemas.enable": "true",
    "value.converter.schema.registry.url": "http://schema-registry.kafka.svc.cluster.local:8081",
}
</code></pre></div></div>

<p>kafka-connect가 접속하는 <code class="language-plaintext highlighter-rouge">database.user</code>의 role이 superuser, replication을 가지고 있어야 합니다. connector가 postgresql에 접속해서 slot을 생성해야 하는데 이 권한이 superuser와 replication이기 때문입니다. 만약 username이 postgres가 아니라면 다음의 명령어를 사용해 권한을 부여합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it &lt;postgres-pod&gt; -n postgres -- psql -U postgres -c "alter user &lt;username&gt; with superuser replication;"
</code></pre></div></div>

<p>schema-registry를 배포했기 때문에 AvroConverter를 사용할 수 있습니다. schema-registry는 데이터 스키마를 저장하고 불러오는 공간으로 사용자가 스키마를 입력하지 않아도 알아서 스키마를 관리합니다. 뒤에 나올 ksqldb를 사용할 때도 스키마 입력을 하지 않아도 되는 장점도 있습니다. connector가 연결되면 아래와 같이 커넥터 목록들을 볼 수 있습니다.</p>

<figure>
    <a href="https://1drv.ms/i/s!AoC6BbMk0S9QmzpLv8yOSVwta8q4?embed=1&amp;width=2345&amp;height=687" onclick="return false;" data-lightbox="gallery">
      <img src="https://1drv.ms/i/s!AoC6BbMk0S9QmzpLv8yOSVwta8q4?embed=1&amp;width=2345&amp;height=687" alt="03" style="max-width: 100%; height: auto;" />
    </a>
    <figcaption>Connectors</figcaption>
</figure>

<p><strong>ksqlDB 설정</strong>
대시보드에서 ksqlDB 탭으로 들어가면 다음과 같은 화면을 볼 수 있습니다.</p>

<figure>
    <a href="https://1drv.ms/i/s!AoC6BbMk0S9QmzlLlxoK6QOdJKjj?embed=1&amp;width=2342&amp;height=409" onclick="return false;" data-lightbox="gallery">
      <img src="https://1drv.ms/i/s!AoC6BbMk0S9QmzlLlxoK6QOdJKjj?embed=1&amp;width=2342&amp;height=409" alt="04" style="max-width: 100%; height: auto;" />
    </a>
    <figcaption>ksqlDB</figcaption>
</figure>

<p>이미 스트림과 테이블을 정의했기 때문에 목록에 보이고 있고 초기 상태는 스트림에 한개만 정의되어 있습니다.</p>

<p>오른쪽 상단에 <code class="language-plaintext highlighter-rouge">Execute KSQL Request</code>버튼을 누르면 쿼리를 실행할 수 있는 공간을 볼 수 있습니다. 아래 사진은 bank_transaction_base라는 스트림을 생성하고 실행한 모습입니다.</p>

<figure>
  <a href="https://1drv.ms/i/s!AoC6BbMk0S9Qmz0O6ZFyrCda0Gob?embed=1&amp;width=2343&amp;height=1175" onclick="return false;" data-lightbox="gallery">
    <img src="https://1drv.ms/i/s!AoC6BbMk0S9Qmz0O6ZFyrCda0Gob?embed=1&amp;width=2343&amp;height=1175" alt="05" style="max-width: 100%; height: auto;" />
  </a>
</figure>

<p>source-connector로 데이터를 가져오면 topic에 메시지가 쌓이게 되는데 ksqlDB에서는 이 메시지를 바로 사용하지 못합니다. 그래서 stream을 먼저 생성하고 그 스트림을 사용하여 어떠한 처리 로직이 반영된 스트림 혹은 테이블을 만들 수 있습니다.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="n">stream</span> <span class="n">account</span> <span class="k">with</span> <span class="p">(</span><span class="n">kafka_topic</span><span class="o">=</span><span class="err">‘</span><span class="n">integrate</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="n">account</span><span class="err">’</span><span class="p">,</span> <span class="n">value_format</span><span class="o">=</span><span class="err">‘</span><span class="n">avro</span><span class="err">’</span><span class="p">);</span>
</code></pre></div></div>

<p>AvroConvert를 사용하고 있으므로 format을 avro로 설정하면 스트림을 생성할 수 있습니다. 만약 AvroConvert를 사용하지 않는다면 스키마를 지정해줘야 합니다.</p>

<p>스키마를 지정해야 하는 경우 주의해야 할 점은 source db의 스키마가 아닌 connector가 생성하는 구조로 스키마를 지정해야 합니다. kafka topic 메시지 하나가 다음과 같다면 작성해야 할 sql 예시를 들어보겠습니다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"after"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"account_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"566740694069"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"account_holder_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"8202b6c341fe41f74b0749678fa87f9d56d89f9b83f48277a91a0a61a01cd183"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"account_balance"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.5.4.Final"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"connector"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgresql"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integrate"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ts_ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">1725335089064</span><span class="p">,</span><span class="w">
        </span><span class="nl">"snapshot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"db"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"sequence"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[</span><span class="se">\"</span><span class="s2">26901096</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">26901200</span><span class="se">\"</span><span class="s2">]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"public"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"table"</span><span class="p">:</span><span class="w"> </span><span class="s2">"account"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"txId"</span><span class="p">:</span><span class="w"> </span><span class="mi">748</span><span class="p">,</span><span class="w">
        </span><span class="nl">"lsn"</span><span class="p">:</span><span class="w"> </span><span class="mi">26901200</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"op"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ts_ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">1725335089547</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="n">stream</span> <span class="n">account</span> <span class="p">(</span>
    <span class="k">after</span> <span class="n">struct</span><span class="o">&lt;</span><span class="n">account_id</span> <span class="nb">varchar</span><span class="p">,</span> <span class="n">account</span><span class="o">-</span><span class="n">holder</span><span class="o">-</span><span class="n">name</span> <span class="nb">varchar</span><span class="p">,</span> <span class="n">account</span><span class="o">-</span><span class="n">balance</span> <span class="nb">bigint</span><span class="o">&gt;</span><span class="p">,</span> 
    <span class="n">ts_ms</span> <span class="nb">bigint</span>
<span class="p">)</span> <span class="k">with</span> <span class="p">(</span>
    <span class="n">kafka_topic</span><span class="o">=</span><span class="err">‘</span><span class="n">integrate</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="n">account</span><span class="err">’</span><span class="p">,</span> 
    <span class="n">value_format</span><span class="o">=</span><span class="err">‘</span><span class="n">json</span><span class="err">’</span>
<span class="p">);</span>
</code></pre></div></div>
<p>메시지 구조와 스키마 구조가 맞지 않다면 push query 실행 시 데이터는 null로 채워집니다.</p>

<p>저는 bank_transaction 데이터를 사용해서 count_type_by_account, success_ratio_by_account, transaction_volume_per_minute이라는 테이블을 생성했습니다.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">count_type_by_account</span> <span class="k">as</span>
    <span class="k">select</span> 
        <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span><span class="p">,</span> 
        <span class="k">count</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="k">type</span><span class="o">=</span><span class="s1">'deposit'</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">deposit_count</span><span class="p">,</span> 
        <span class="k">count</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="k">type</span><span class="o">=</span><span class="s1">'withdraw'</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">withdraw_count</span>
    <span class="k">from</span> <span class="n">bank_transaction_base</span> <span class="n">bt</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span>
    <span class="n">emit</span> <span class="n">changes</span><span class="p">;</span>
</code></pre></div></div>
<p>이 쿼리처럼 account_id로 group by하려면 반드시 select 절에 account_id가 등장해야 합니다. <code class="language-plaintext highlighter-rouge">emit changes</code>는 참조하는 스트림에 변화가 생길때 이 테이블을 업데이트합니다.</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">success_ratio_by_account</span> <span class="k">as</span>
  <span class="k">select</span>
    <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span> <span class="k">as</span> <span class="n">account_id</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">tl</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">event</span><span class="o">=</span><span class="s1">'Success'</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">success_count</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">tot</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">tl</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="s1">'Success'</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="nb">double</span><span class="p">)</span> <span class="o">/</span> <span class="k">cast</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="nb">double</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">success_rate</span>
  <span class="k">from</span> <span class="n">bank_transaction_base</span> <span class="n">bt</span>
  <span class="k">left</span> <span class="k">join</span> <span class="n">transaction_log_base</span> <span class="n">tl</span> <span class="n">within</span> <span class="mi">10</span> <span class="n">minutes</span> <span class="k">on</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">tl</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">transaction_id</span>
  <span class="k">group</span> <span class="k">by</span> <span class="n">bt</span><span class="p">.</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span>
  <span class="n">emit</span> <span class="n">changes</span><span class="p">;</span>
</code></pre></div></div>
<p>이 쿼리에서 스트림인 bank_transaction_base와 transaction_log_base를 조인하여 현재 시점을 기준으로 10분 이내로 들어온 메시지들을 사용하여 테이블을 업데이트합니다.</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">transaction_volume_per_minute</span> <span class="k">as</span>
    <span class="k">select</span>
        <span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span> <span class="k">as</span> <span class="n">account_id</span><span class="p">,</span>
        <span class="k">sum</span><span class="p">(</span><span class="k">after</span><span class="o">-&gt;</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_amount</span><span class="p">,</span>
        <span class="n">windowstart</span> <span class="k">as</span> <span class="n">window_start</span><span class="p">,</span>
        <span class="n">windowend</span> <span class="k">as</span> <span class="n">window_end</span><span class="p">,</span>
        <span class="n">from_unixtime</span><span class="p">(</span><span class="n">windowstart</span><span class="p">)</span> <span class="k">as</span> <span class="n">time_start</span><span class="p">,</span>
        <span class="n">from_unixtime</span><span class="p">(</span><span class="n">windowend</span><span class="p">)</span> <span class="k">as</span> <span class="n">time_end</span>
    <span class="k">from</span> <span class="n">bank_transaction_base</span>
    <span class="k">window</span> <span class="n">tumbling</span><span class="p">(</span><span class="k">size</span> <span class="mi">1</span> <span class="k">minute</span><span class="p">)</span>
    <span class="k">group</span> <span class="k">by</span> <span class="k">after</span><span class="o">-&gt;</span><span class="n">account_id</span>
    <span class="n">emit</span> <span class="n">changes</span><span class="p">;</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">window tumbling(size 1 minute)</code>은 1분간격을 의미합니다. 즉, account_id마다 1분간 amount 총합을 계산하는 쿼리입니다.</p>

<p>테이블과 스트림을 생성하면 topic에 자동 등록되고 메시지로 쌓이게 됩니다.</p>

<figure>
    <a href="https://1drv.ms/i/s!AoC6BbMk0S9QmzcQq59oeLhF9RJl?embed=1&amp;width=2339&amp;height=1005  " onclick="return false;" data-lightbox="gallery">
      <img src="https://1drv.ms/i/s!AoC6BbMk0S9QmzcQq59oeLhF9RJl?embed=1&amp;width=2339&amp;height=1005" alt="06" style="max-width: 100%; height: auto;" />
    </a>
    <figcaption>topics</figcaption>
</figure>

<p>그리고 schema-registry에도 스키마가 등록됩니다.</p>

<figure>
    <a href="https://1drv.ms/i/s!AoC6BbMk0S9Qmzh4uvzmuM_QLZMt?embed=1&amp;width=2340&amp;height=1123" onclick="return false;" data-lightbox="gallery">
      <img src="https://1drv.ms/i/s!AoC6BbMk0S9Qmzh4uvzmuM_QLZMt?embed=1&amp;width=2340&amp;height=1123" alt="07" style="max-width: 100%; height: auto;" />
    </a>
    <figcaption>schema-registry</figcaption>
</figure>

<p>다시 kafka-connect로 돌아와서 Sink 커넥터 설정을 진행합니다. 저는 count_type_by_account, success_ratio_by_account, transaction_volume_per_minute topic을 sink db에 적재했습니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "name": "postgresql-sink-connector-topic-success-ratio-by-account",
    "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
    "connection.url": "jdbc:postgresql://postgresql.postgres.svc.cluster.local:5432/sink",
    "connection.user": "postgres",
    "connection.password": "postgres",
    "topics": "SUCCESS_RATIO_BY_ACCOUNT",
    "tasks.max": "1",
    "insert.mode": "upsert",
    "auto.evolve": "true",
    "auto.create": "true",
    "pk.mode":"record_key",
    "pk.field":"account_id",
    "key.converter": "io.confluent.connect.avro.AvroConverter",
    "key.converter.schemas.enable": "true",
    "key.converter.schema.registry.url": "http://schema-registry.kafka.svc.cluster.local:8081"
    "value.converter": "io.confluent.connect.avro.AvroConverter",
    "value.converter.schemas.enable": "true",
    "value.converter.schema.registry.url": "http://schema-registry.kafka.svc.cluster.local:8081",
}
</code></pre></div></div>

<h3 id="superset-배포">Superset 배포</h3>
<p>시각화 도구로 Superset을 선택했습니다. Superset은 따로 yaml로 작성하지 않고 helm을 이용하여 배포했습니다. helm 통해 superset, redis, postgresql, superset-worker가 배포됩니다.</p>

<p>먼저 superset 네임스페이스를 생성합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns superset
</code></pre></div></div>

<p>다음 helm repo를 추가하고 업데이트합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add superset http://apache.github.io/superset/
helm repo update
</code></pre></div></div>

<p>superset 최근 이슈 중에 default secret key 문제가 있어 values.yaml 파일에 secret key를 등록해야 합니다. secret key는 openssl 명령어로 실행된 값을 넣어줍니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl rand -base64 42
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># superset/values.yaml
extraSecretEnv:
  SUPERSET_SECRET_KEY: {SECRET_KEY}
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm install superset superset/superset -f superset/values.yaml -n superset
</code></pre></div></div>
<p>또는 –set 명령어로 values.yaml 파일을 overwrite합니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm install superset superset/superset -n superset --set extraSecretEnv.SUPERSET_SECRET_KEY=$(openssl rand -base64 42)
</code></pre></div></div>

<p>다음 superset에 접속하기 위해 포트포워드를 설정하고 localhost:8088로 접속합니다. 기본 id와 passwowrd는 superset입니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward superset -n superset 8088:8088
</code></pre></div></div>

<p>접속 후 database를 먼저 연결해줍니다. 오른쪽 상단 <code class="language-plaintext highlighter-rouge">+</code>에서 데이터베이스를 연결하거나 <code class="language-plaintext highlighter-rouge">Settings</code>에서 데이터베이스 커넥션 관리 탭을 눌러 관리할 수 있습니다.</p>

<figure>
    <a href="https://1drv.ms/i/s!AoC6BbMk0S9Qm0IU71HSJmWMKCVj?embed=1&amp;width=2553&amp;height=1219" onclick="return false;" data-lightbox="gallery">
      <img src="https://1drv.ms/i/s!AoC6BbMk0S9Qm0IU71HSJmWMKCVj?embed=1&amp;width=2553&amp;height=1219" alt="08" style="max-width: 100%; height: auto;" />
    </a>
    <figcaption>superset, connect a database</figcaption>
</figure>

<p>PostgreSQL을 눌러 다음과 같이 입력하고 <code class="language-plaintext highlighter-rouge">Connect</code>버튼을 누릅니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>host: postgresql.postgres.svc.cluster.local
port: 5432
database: postgres
username: postgres
password: postgres
display name: PostgreSQL-source
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>host: postgresql.postgres.svc.cluster.local
port: 5432
database: sink
username: postgres
password: postgres
display name: PostgreSQL-sink
</code></pre></div></div>

<p>다음 추가 설정으로 SQL Lab 탭에서 Allow DML을 체크하여 <code class="language-plaintext highlighter-rouge">Finish</code> 버튼을 누릅니다.</p>

<p>SQL Lab에서는 데이터베이스에 쿼리를 날릴 수 있습니다. 오른쪽에 데이터베이스를 선택하면 해당 데이터베이스에 직접 쿼리를 날려 결과를 볼 수 있습니다.</p>
<figure>
    <a href="https://1drv.ms/i/s!AoC6BbMk0S9Qm0RWMGZmtZXGd9z4?embed=1&amp;width=2543&amp;height=1212" onclick="return false;" data-lightbox="gallery">
      <img src="https://1drv.ms/i/s!AoC6BbMk0S9Qm0RWMGZmtZXGd9z4?embed=1&amp;width=2543&amp;height=1212" alt="09" style="max-width: 100%; height: auto;" />
    </a>
    <figcaption>superset, sql lab</figcaption>
</figure>

<p>위 사진에서는 COUNT_TYPE_BY_ACCOUNT 테이블을 이용해 새로운 데이터로 조회했습니다. 이것을 오른쪽 중간에 SAVE 버튼 옆 확장 표시를 눌러 Datasets으로 저장할 수 있습니다. 또는 CREATE CHART 버튼을 눌러 바로 차트를 만들 수도 있습니다.</p>

<p>몇 가지 쿼리를 만들어 간단하게 대시보드를 구성해봤습니다.</p>
<figure>
  <a href="https://1drv.ms/i/s!AoC6BbMk0S9Qm0U95QrnHpAev6Xi?embed=1&amp;width=2558&amp;height=1209" onclick="return false;" data-lightbox="gallery">
    <img src="https://1drv.ms/i/s!AoC6BbMk0S9Qm0U95QrnHpAev6Xi?embed=1&amp;width=2558&amp;height=1209" alt="10" style="max-width: 100%; height: auto;" />
  </a>
  <figcaption>superset, dashboard transaction</figcaption>
</figure>

<figure>
  <a href="https://1drv.ms/i/s!AoC6BbMk0S9Qm0ZjPZ3xzWCi0V2X?embed=1&amp;width=2552&amp;height=1214" onclick="return false;" data-lightbox="gallery">
    <img src="https://1drv.ms/i/s!AoC6BbMk0S9Qm0ZjPZ3xzWCi0V2X?embed=1&amp;width=2552&amp;height=1214" alt="11" style="max-width: 100%; height: auto;" />
  </a>
  <figcaption>superset, dashboard transaction-event</figcaption>
</figure>

<p>각 차트 우측 상단 …을 누르게 되면 refresh interval을 설정하거나 차트를 공유할 수도 있습니다.</p>

<h2 id="마무리">마무리</h2>
<p>실시간으로 데이터를 생성하고 kafka-ksqlDB를 거쳐 superset으로 시각화까지 이어지도록 해봤습니다. ksqlDB에는 window 관련 내용이 재밌는게 많았지만 깊게 파지 못한 점이 아쉬웠습니다. 실제로 해본 느낌으로는 kafka 이후 배치 파이프라인이 필요없어질 수 있겠다는 생각과 kafka에서 superset으로 바로 연결가능한 솔루션이 있었으면 좋겠다는 생각이 들었습니다.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#data-engineering" class="page__taxonomy-item p-category" rel="tag">data-engineering</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#data-engineer" class="page__taxonomy-item p-category" rel="tag">data-engineer</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2024-09-03T00:00:00+09:00">September 3, 2024</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pytorch/transformer-scratch-implementation-2/" class="pagination--pager" title="python으로 Transformer 바닥부터 구현하기[2] (Transformer)
">Previous</a>
    
    
      <a href="/github/code-review-action/" class="pagination--pager" title="Github Action 코드리뷰 봇 만들기(Gemini-1.5-flash)
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/data-engineer/opensearch-ml/" rel="permalink">Reranking - Opensearch
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> February 17 2025</p>
    
    <p class="archive__item-excerpt" itemprop="description">Reranker
문서 검색 과정에서 문서를 임베딩 벡터로 변환하는 과정과 검색 시간 단축을 위해 Approximate Nearest Neighbor search(ANNs)와 같이 근사시키는 기술로 인해 정보 손실이 발생합니다. 이로 인해 필요한 문서가 누락되는 경우가 발생할 수 있...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/github/code-review-action/" rel="permalink">Github Action 코드리뷰 봇 만들기(Gemini-1.5-flash)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> October 16 2024</p>
    
    <p class="archive__item-excerpt" itemprop="description">Github Action 설정
Github Action은 사용자가 원하는 트리거에 따라 워크플로우를 실행할 수 있는 CI(Continuous Integration) 도구입니다. 구글의 Gemini-1.5-flash 모델을 사용하여 Pull Request시 코드 변경사항에 대해 LL...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pytorch/transformer-scratch-implementation-2/" rel="permalink">python으로 Transformer 바닥부터 구현하기[2] (Transformer)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> August 01 2024</p>
    
    <p class="archive__item-excerpt" itemprop="description">Objective
앞에서 구현한 LayerNorm, MultiHeadAttention, GELU를 사용하고 이전에 구현해둔 Linear, Dropout, Softmax 클래스를 사용하여 Transformer 클래스를 구현하여 테스트해봅니다.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pytorch/transformer-scratch-implementation-1/" rel="permalink">python으로 Transformer 바닥부터 구현하기[1] (MultiHead-Attention, LayerNorm, GELU)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> July 31 2024</p>
    
    <p class="archive__item-excerpt" itemprop="description">Transformer
트랜스포머(Transformer)는 2017년에 등장한 모델입니다. Attention is all you need 논문은 트랜스포머 모델에 대해 설명하고 있으며 이후 BERT, GPT라는 새로운 모델을 탄생시키는 배경이 됩니다.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 emeraldgoose. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'emeraldgoose/emeraldgoose.github.io');
    script.setAttribute('issue-term', 'pathname');
    
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  




<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
  inlineMath: [['$','$']],
  displayMath: [['$$','$$']],
  processEscapes: true
  },
  "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

  </body>
</html>
