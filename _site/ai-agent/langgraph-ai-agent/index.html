<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Langgraph: Reflection Agents - gooooooooooose</title>
<meta name="title" content="Langgraph: Reflection Agents">
<meta name="description" content="Langgraph Langgraph는 노드(Node)와 엣지(Edge)를 이용해 워크플로우의 흐름을 정의하여 AI Agent 애플리케이션을 빌드할 수 있는 플랫폼입니다.    노드(Node): 특정 작업을 수행하는 단계를 말합니다. 예를 들어, 텍스트 요약, 검색, 코드 생성 노드 등이 있습니다.   엣지(Edge): 노드 간의 연결을 말하며 데이터 흐름을 정의합니다. 특정 조건에 따라 분기도 가능합니다.   상태(State): 애플리케이션의 현재 상태를 공유하는 데이터 구조입니다.">


  <meta name="author" content="goooose">
  
  <meta property="article:author" content="goooose">
  


<!-- open-graph tags -->
<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="gooooooooooose">
<meta property="og:title" content="Langgraph: Reflection Agents">
<meta property="og:url" content="http://localhost:4000/ai-agent/langgraph-ai-agent/">


  <meta property="og:description" content="Langgraph Langgraph는 노드(Node)와 엣지(Edge)를 이용해 워크플로우의 흐름을 정의하여 AI Agent 애플리케이션을 빌드할 수 있는 플랫폼입니다.    노드(Node): 특정 작업을 수행하는 단계를 말합니다. 예를 들어, 텍스트 요약, 검색, 코드 생성 노드 등이 있습니다.   엣지(Edge): 노드 간의 연결을 말하며 데이터 흐름을 정의합니다. 특정 조건에 따라 분기도 가능합니다.   상태(State): 애플리케이션의 현재 상태를 공유하는 데이터 구조입니다.">







  <meta property="article:published_time" content="2025-03-14T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/ai-agent/langgraph-ai-agent/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "emeraldgoose",
      "url": "http://localhost:4000/"
    
  }
</script>


  <meta name="google-site-verification" content="googleb34ce5276ba6573e" />





  <meta name="naver-site-verification" content="naver93cdc79a5629ab3736d7cf8ff7b51d80">


<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- Lightbox2 -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox-plus-jquery.js" integrity="sha512-oaWLach/xXzklmJDBjHkXngTCAkPch9YFqOSphnw590sy86CVEnAbcpw17QjkUGppGmVJojwqHmGO/7Xxx6HCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox-plus-jquery.min.js" integrity="sha512-U9dKDqsXAE11UA9kZ0XKFyZ2gQCj+3AwZdBMni7yXSvWqLFEj8C1s7wRmWl9iyij8d5zb4wm56j4z/JVEwS77g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#ai-agent" itemprop="item"><span itemprop="name">Ai agent</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Langgraph: Reflection Agents</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="/assets/images/bio-photo.png" alt="goooose" itemprop="image" class="u-photo" width="110px" height="110px">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">goooose</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Interested in ML/DL, Data Engineering.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">South Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:smk6221@naver.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://github.com/emeraldgoose" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/minseong-kim-84428b231/" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://gooooooooooose.tistory.com/" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Problem Solving OJ (KOR)</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Langgraph: Reflection Agents">
    <meta itemprop="description" content="LanggraphLanggraph는 노드(Node)와 엣지(Edge)를 이용해 워크플로우의 흐름을 정의하여 AI Agent 애플리케이션을 빌드할 수 있는 플랫폼입니다.  노드(Node): 특정 작업을 수행하는 단계를 말합니다. 예를 들어, 텍스트 요약, 검색, 코드 생성 노드 등이 있습니다.  엣지(Edge): 노드 간의 연결을 말하며 데이터 흐름을 정의합니다. 특정 조건에 따라 분기도 가능합니다.  상태(State): 애플리케이션의 현재 상태를 공유하는 데이터 구조입니다.">
    <meta itemprop="datePublished" content="2025-03-14T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Langgraph: Reflection Agents
</h1>
          
<!--
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  0 minute read
</p>
            devinlife comments :
                싱글 페이지(포스트)에 제목 밑에 Updated 시간 표기
                기존에는 read_time이 표기. read_time -> date 변경
-->
            <p class="page__date"><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated: <time datetime="2025-03-14T00:00:00+09:00">March 14, 2025</time></p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <h2 id="langgraph">Langgraph</h2>
<p>Langgraph는 노드(Node)와 엣지(Edge)를 이용해 워크플로우의 흐름을 정의하여 AI Agent 애플리케이션을 빌드할 수 있는 플랫폼입니다.</p>
<ul>
  <li><strong>노드(Node)</strong>: 특정 작업을 수행하는 단계를 말합니다. 예를 들어, 텍스트 요약, 검색, 코드 생성 노드 등이 있습니다.</li>
  <li><strong>엣지(Edge)</strong>: 노드 간의 연결을 말하며 데이터 흐름을 정의합니다. 특정 조건에 따라 분기도 가능합니다.</li>
  <li><strong>상태(State)</strong>: 애플리케이션의 현재 상태를 공유하는 데이터 구조입니다.</li>
</ul>

<h3 id="reflection">Reflection</h3>
<p>Reflection은 Agent의 과거 행동을 반성하고 비판해서 Agent의 품질과 성공율을 향상시킬 수 있는 프롬프팅 전략입니다.</p>

<figure style="text-align:center;">
    <a>
        <img src="https://blog.langchain.dev/content/images/size/w1600/2024/02/reflection.png" alt="01" style="max-width:80%;height:auto;" />
        <figcaption>Simple Reflection Loop</figcaption>
    </a>
</figure>

<p>가장 간단한 Reflection 예시입니다. generator와 reflect가 있고 generator의 답변에 대해 reflect가 비판을 제공하면 generator가 비판을 근거로 삼아 다시 생성하는 루프입니다. 사용자가 지정한 루프 횟수 동안 수행되며 끝난다면 사용자에게 응답을 전달하게 합니다.</p>

<h2 id="example-application">Example Application</h2>
<p>아래는 테크 블로그의 포스트를 불러와 요약하는 Agent를 구성한 것입니다. 이 Agent는 Reflection 전략을 통해 답변을 수정해서 최종 수정본을 사용자에게 전달합니다.</p>

<figure class="half">
    <a href="https://1drv.ms/i/c/502fd124b305ba80/IQTg245N36tMQK6WCT_zec6DAdsPjA2J-VRiNNiiBzw0zzM?width=1024" data-lightbox="gallery" style="text-align:center;">
        <img src="https://1drv.ms/i/c/502fd124b305ba80/IQTg245N36tMQK6WCT_zec6DAdsPjA2J-VRiNNiiBzw0zzM?width=1024" alt="02" style="max-width:50%;height:auto;" />
        <figcaption>plan and execution diagram</figcaption>
    </a>
    <a href="https://1drv.ms/i/c/502fd124b305ba80/IQRYsDzRPA4CSqn6O7Xk5l_rAe4DUDQ9DIHBm5K_MxHxdt8?width=1024" data-lightbox="gallery" style="text-align:center;">
        <img src="https://1drv.ms/i/c/502fd124b305ba80/IQRYsDzRPA4CSqn6O7Xk5l_rAe4DUDQ9DIHBm5K_MxHxdt8?width=1024" alt="03" style="max-width:29.5%;height:auto;" />
        <figcaption>revise diagram</figcaption>
    </a>
</figure>

<h3 id="workflow-plan-and-execution">workflow (plan and execution)</h3>
<p><strong>State</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">List</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">planning_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">document</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">figures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">tables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">drafts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">final_doc</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></div>

<p><strong>get_document_node</strong>: 이 노드에서는 요약하고자 하는 블로그 주소에 접속하여 html을 가져오는 노드입니다. 이렇게 가져온 html은 다음 단계에서 이미지, 표를 추출하고 계획 단계로 넘어갑니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">langchain_community.document_loaders</span> <span class="kn">import</span> <span class="n">AsyncHtmlLoader</span>
<span class="kn">from</span> <span class="nn">langchain_community.document_transformers</span> <span class="kn">import</span> <span class="n">MarkdownifyTransformer</span>

<span class="k">def</span> <span class="nf">get_document_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'url'</span><span class="p">)</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">AsyncHtmlLoader</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">loader</span><span class="p">.</span><span class="n">load</span><span class="p">()</span>
    
    <span class="n">md</span> <span class="o">=</span> <span class="n">MarkdownifyTransformer</span><span class="p">()</span>
    <span class="n">converted_docs</span> <span class="o">=</span> <span class="n">md</span><span class="p">.</span><span class="n">transform_documents</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
    
    <span class="n">title</span> <span class="o">=</span> <span class="n">converted_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">metadata</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">converted_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page_content</span>

    <span class="k">return</span> <span class="n">State</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">document</span><span class="o">=</span><span class="n">document</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>LLM</strong>: Gemini-2.0-flash 모델을 사용했습니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">langchain_google_genai</span> <span class="kn">import</span> <span class="n">ChatGoogleGenerativeAI</span>

<span class="k">def</span> <span class="nf">get_chat</span><span class="p">():</span>
    <span class="n">chat</span> <span class="o">=</span> <span class="n">ChatGoogleGenerativeAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s">'gemini-2.0-flash-001'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chat</span>
</code></pre></div></div>

<p><strong>extract_materials</strong>: 이 단계에서는 html에서 이미지와 표 형식을 추출합니다. 여기서 추출된 자료들은 execution_node에서 사용됩니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">extract_materials</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"##### Extract Materials #####"</span><span class="p">)</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'document'</span><span class="p">)</span>

    <span class="n">materials_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">([(</span><span class="s">'human'</span><span class="p">,</span> <span class="n">extract_materials_instruction</span><span class="p">)])</span>
    <span class="n">chat</span> <span class="o">=</span> <span class="n">get_chat</span><span class="p">()</span>
    
    <span class="n">extracted_materials</span> <span class="o">=</span> <span class="n">materials_prompt</span> <span class="o">|</span> <span class="n">chat</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">extracted_materials</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">"document"</span><span class="p">:</span> <span class="n">document</span><span class="p">})</span>
    <span class="n">materials</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span>

    <span class="n">figure_materials</span> <span class="o">=</span> <span class="n">materials</span><span class="p">[</span><span class="n">materials</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'&lt;figures&gt;'</span><span class="p">)</span><span class="o">+</span><span class="mi">9</span><span class="p">:</span><span class="n">materials</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'&lt;/figures&gt;'</span><span class="p">)].</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n\n</span><span class="s">'</span><span class="p">)</span>
    <span class="n">table_materials</span> <span class="o">=</span> <span class="n">materials</span><span class="p">[</span><span class="n">materials</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'&lt;tables&gt;'</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="p">:</span><span class="n">materials</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'&lt;/tables&gt;'</span><span class="p">)].</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n\n</span><span class="s">'</span><span class="p">)</span>

    <span class="n">figures</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">figure_materials</span><span class="p">:</span>
        <span class="n">figures</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">table_materials</span><span class="p">:</span>
        <span class="n">tables</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="n">State</span><span class="p">(</span><span class="n">figures</span><span class="o">=</span><span class="n">figures</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>plan_node</strong>: 이 단계에서는 html로부터 주요 포인트를 추출하고 요약합니다. 여기서 작성된 계획은 execute_node에서 자세히 서술됩니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plan_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"##### Plan ######"</span><span class="p">)</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'document'</span><span class="p">)</span>
    
    <span class="n">planner_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">([(</span><span class="s">'human'</span><span class="p">,</span> <span class="n">plan_instruction</span><span class="p">)])</span>
    <span class="n">chat</span> <span class="o">=</span> <span class="n">get_chat</span><span class="p">()</span>

    <span class="n">planner</span> <span class="o">=</span> <span class="n">planner_prompt</span> <span class="o">|</span> <span class="n">chat</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">planner</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">"document"</span><span class="p">:</span> <span class="n">document</span><span class="p">})</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\n\n</span><span class="s">'</span><span class="p">,</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="n">planning_steps</span> <span class="o">=</span> <span class="n">plan</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">State</span><span class="p">(</span><span class="n">planning_steps</span><span class="o">=</span><span class="n">planning_steps</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>execute_node</strong>: 이 단계는 이미지, 표 자료를 이용해 plan_node에서 세운 계획마다 초안을 생성합니다. 가독성을 위해 구조화된 형식을 만족할 수 있는 마크다운 문법을 이용해 작성됩니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"##### Write (execute) #####"</span><span class="p">)</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'document'</span><span class="p">)</span>
    <span class="n">planning_steps</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'planning_steps'</span><span class="p">)</span>
    <span class="n">figures</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'figures'</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'tables'</span><span class="p">)</span>

    <span class="n">write_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">([(</span><span class="s">'human'</span><span class="p">,</span> <span class="n">write_instruction</span><span class="p">)])</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">drafts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">planning_steps</span><span class="p">:</span>
        <span class="n">chat</span> <span class="o">=</span> <span class="n">get_chat</span><span class="p">()</span>
        <span class="n">write_chain</span> <span class="o">=</span> <span class="n">write_prompt</span> <span class="o">|</span> <span class="n">chat</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">write_chain</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span>
            <span class="s">"document"</span><span class="p">:</span> <span class="n">document</span><span class="p">,</span>
            <span class="s">"plan"</span><span class="p">:</span> <span class="n">planning_steps</span><span class="p">,</span>
            <span class="s">"text"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
            <span class="s">"STEP"</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
            <span class="s">"figures"</span><span class="p">:</span> <span class="n">figures</span><span class="p">,</span>
            <span class="s">"tables"</span><span class="p">:</span> <span class="n">tables</span>
        <span class="p">})</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span>

        <span class="n">draft</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'&lt;result&gt;'</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>

        <span class="c1"># print(f"--&gt; step:{step}")
</span>        <span class="c1"># print(f"--&gt; {draft}")
</span>
        <span class="n">drafts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">draft</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="n">draft</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n\n</span><span class="s">'</span>
    
    <span class="k">return</span> <span class="n">State</span><span class="p">(</span><span class="n">drafts</span><span class="o">=</span><span class="n">drafts</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>revise_answers</strong>: 이 단계에서 각 초안마다 reflect-revise 과정을 거쳐 얻어진 수정본을 모아 최종본을 만들어 사용자에게 전달합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_reflect_workflow</span><span class="p">():</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ReflectionState</span><span class="p">)</span>

    <span class="n">workflow</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="s">"reflect_node"</span><span class="p">,</span> <span class="n">reflect_node</span><span class="p">)</span>
    <span class="n">workflow</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="s">"revise_draft"</span><span class="p">,</span> <span class="n">revise_draft</span><span class="p">)</span>

    <span class="n">workflow</span><span class="p">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s">"reflect_node"</span><span class="p">)</span>
    <span class="n">workflow</span><span class="p">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
        <span class="s">"revise_draft"</span><span class="p">,</span>
        <span class="n">should_continue</span><span class="p">,</span>
        <span class="p">{</span><span class="s">"end"</span><span class="p">:</span> <span class="n">END</span><span class="p">,</span> <span class="s">"continue"</span><span class="p">:</span> <span class="s">"reflect_node"</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">workflow</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">"reflect_node"</span><span class="p">,</span> <span class="s">"revise_draft"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">workflow</span><span class="p">.</span><span class="nb">compile</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">revise_answers</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"##### revise #####"</span><span class="p">)</span>
    <span class="n">drafts</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"drafts"</span><span class="p">)</span>

    <span class="c1"># 이 부분을 멀티프로세싱으로 구성하면 처리 속도를 높일 수 있습니다.
</span>    <span class="n">reflection_process</span> <span class="o">=</span> <span class="n">get_reflect_workflow</span><span class="p">()</span>
    
    <span class="n">final_doc</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">draft</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">reflection_process</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">"draft"</span><span class="p">:</span><span class="n">draft</span><span class="p">},</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">final_doc</span> <span class="o">+=</span> <span class="n">output</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'revised_draft'</span><span class="p">)</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n\n</span><span class="s">'</span>
    
    <span class="k">return</span> <span class="n">State</span><span class="p">(</span><span class="n">final_doc</span><span class="o">=</span><span class="n">final_doc</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Define workflow</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>

<span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>

<span class="n">workflow</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="s">"get_document_node"</span><span class="p">,</span> <span class="n">get_document_node</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="s">"plan_node"</span><span class="p">,</span><span class="n">plan_node</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="s">"extract_materials"</span><span class="p">,</span> <span class="n">extract_materials</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="s">"execute_node"</span><span class="p">,</span> <span class="n">execute_node</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="s">"revise_answers"</span><span class="p">,</span><span class="n">revise_answers</span><span class="p">)</span>

<span class="n">workflow</span><span class="p">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s">"get_document_node"</span><span class="p">)</span>

<span class="n">workflow</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">"get_document_node"</span><span class="p">,</span><span class="s">"plan_node"</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">"get_document_node"</span><span class="p">,</span><span class="s">"extract_materials"</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">"plan_node"</span><span class="p">,</span><span class="s">"execute_node"</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">"extract_materials"</span><span class="p">,</span><span class="s">"execute_node"</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">"execute_node"</span><span class="p">,</span> <span class="s">"revise_answers"</span><span class="p">)</span>
<span class="n">workflow</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">"revise_answers"</span><span class="p">,</span><span class="n">END</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">workflow</span><span class="p">.</span><span class="nb">compile</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="workflow-reflect">workflow (reflect)</h3>

<p><strong>State</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ReflectionState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">draft</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">reflection</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">search_queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">revised_draft</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">revision_number</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></div>

<p><strong>reflect_node</strong>: execute_node에서 생성된 초안을 비판합니다. 어떤 부분이 포함되지 않았는지, 뭘 추가해야 더 나은 글이 되는지, 불필요한 부분에 대한 비평을 작성합니다. TavilySearch를 이용해 외부에서 정보를 넣어줄 수도 있습니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">langchain_community.tools</span> <span class="kn">import</span> <span class="n">TavilySearchResults</span>

<span class="k">class</span> <span class="nc">Reflection</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">missing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Critique of what is missing"</span><span class="p">)</span>
    <span class="n">advisable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Critique of what is helpful for better writing"</span><span class="p">)</span>
    <span class="n">superfluous</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Critique of what is superfluous"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Research</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="s">"""Provide reflection and then follow up with search queries to improve the writing."""</span>

    <span class="n">reflection</span><span class="p">:</span> <span class="n">Reflection</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Your reflection on the initial writing for summary."</span><span class="p">)</span>
    <span class="n">search_queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"1-3 search queries for researching improvements to address the critique of your current writing."</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">reflect_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ReflectionState</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'##### Reflect #####'</span><span class="p">)</span>
    <span class="n">draft</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'draft'</span><span class="p">)</span>
    <span class="n">on_search</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'configurable'</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="s">'on_search'</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">reflection</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">search_queries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">chat</span> <span class="o">=</span> <span class="n">get_chat</span><span class="p">()</span>
        <span class="n">structured_llm</span> <span class="o">=</span> <span class="n">chat</span><span class="p">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Research</span><span class="p">,</span> <span class="n">include_raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="n">structured_llm</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">draft</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="p">[</span><span class="s">'parsed'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parsed_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">'parsed'</span><span class="p">]</span>
            <span class="n">reflection</span> <span class="o">=</span> <span class="p">[</span><span class="n">parsed_info</span><span class="p">.</span><span class="n">reflection</span><span class="p">.</span><span class="n">missing</span><span class="p">,</span> <span class="n">parsed_info</span><span class="p">.</span><span class="n">reflection</span><span class="p">.</span><span class="n">advisable</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">on_search</span><span class="p">:</span>
                <span class="n">search_queries</span> <span class="o">=</span> <span class="n">parsed_info</span><span class="p">.</span><span class="n">search_queries</span>
            <span class="k">break</span>

    <span class="n">revision_number</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'revision_number'</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'revision_number'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">ReflectionState</span><span class="p">(</span><span class="n">revision_number</span><span class="o">=</span><span class="n">revision_number</span><span class="p">,</span> <span class="n">search_queries</span><span class="o">=</span><span class="n">search_queries</span><span class="p">,</span> <span class="n">reflection</span><span class="o">=</span><span class="n">reflection</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>revise_draft</strong>: reflect_node에서 작성된 비판을 기반으로 초안을 수정합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">revise_draft</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ReflectionState</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"##### Revise Draft #####"</span><span class="p">)</span>
    <span class="n">on_search</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'configurable'</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="s">'on_search'</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">draft</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'draft'</span><span class="p">)</span>
    <span class="n">search_queries</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'search_queries'</span><span class="p">)</span>
    <span class="n">reflection</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'reflection'</span><span class="p">)</span>

    <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">on_search</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">TavilySearchResults</span><span class="p">(</span><span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">search_queries</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">search</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">'content'</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                    <span class="n">content</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content'</span><span class="p">))</span>
    
    <span class="c1"># print("draft: ", draft)
</span>    <span class="c1"># print("reflection: ", reflection)
</span>    <span class="c1"># print("search quries: ", search_queries)
</span>    <span class="c1"># print("search results: ", content)
</span>
    <span class="n">chat</span> <span class="o">=</span> <span class="n">get_chat</span><span class="p">()</span>
    <span class="n">revise_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">([(</span><span class="s">'human'</span><span class="p">,</span><span class="n">revise_instruction</span><span class="p">)])</span>
    <span class="n">reflect</span> <span class="o">=</span> <span class="n">revise_prompt</span> <span class="o">|</span> <span class="n">chat</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">reflect</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span>
        <span class="s">"draft"</span><span class="p">:</span> <span class="n">draft</span><span class="p">,</span>
        <span class="s">"reflection"</span><span class="p">:</span> <span class="n">reflection</span><span class="p">,</span>
        <span class="s">"content"</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">content</span>
    <span class="n">revision_draft</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'&lt;result&gt;'</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">revision_number</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"revision_number"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># print("revision draft: ", revision_draft)
</span>    
    <span class="k">return</span> <span class="n">ReflectionState</span><span class="p">(</span><span class="n">revised_draft</span><span class="o">=</span><span class="n">revision_draft</span><span class="p">,</span> <span class="n">revision_number</span><span class="o">=</span><span class="n">revision_number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>should_continue</strong>: 계속 수정해야 하는지 판단합니다. 여기서는 단순하게 수정 횟수를 기준으로 하여 기준을 넘어가면 END로 향하게 합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">should_continue</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ReflectionState</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"##### should continue #####"</span><span class="p">)</span>
    <span class="n">max_revision</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'configurable'</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="s">"max_revision"</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># print(f"revision: {state.get('revision_number',0)} / {max_revision}")
</span>    
    <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'revision_number'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_revision</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"end"</span>
    <span class="k">return</span> <span class="s">"continue"</span>
</code></pre></div></div>

<h3 id="run">Run</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">final_state</span> <span class="o">=</span> <span class="n">graph</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span>
    <span class="s">"url"</span><span class="p">:</span><span class="s">""</span><span class="p">},</span> 
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s">'max_revision'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'on_search'</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
    <span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'final_draft.md'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_state</span><span class="p">[</span><span class="s">'final_doc'</span><span class="p">])</span>
</code></pre></div></div>

<p>이 Agent를 실제로 동작하게 되면 약 2~3분정도 시간이 걸리게 됩니다. 시간을 단축하려면 reflect workflow를 multiprocessing 라이브러리를 이용해 병렬처리하도록 구성하면 빠르게 시간을 단축시킬 수 있습니다.</p>

<h2 id="단순-요약-번역과-agent-결과의-비교">단순 요약, 번역과 Agent 결과의 비교</h2>
<p>같은 원문을 번역, Gemini로 단순 요약 그리고 Reflection Agent의 요약결과를 비교해보겠습니다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 번역
이러한 키워드들 중에서 마지막 세트만이 사용자 의도를 정확히 일치시킵니다. 
하지만 선호도는 다양한 속성에 따라 달라질 수 있습니다. 
예를 들어, 소비자는 모든 비건 샌드위치를 대체 옵션으로 고려할 수 있지만, 비건이 아닌 닭고기 샌드위치는 거부할 것입니다. 
식이 제한은 단백질 선택과 같은 다른 속성보다 우선하는 경우가 많습니다. 
사용자에게 가장 관련성이 높은 결과만 보여주기 위해 여러 접근 방식을 사용할 수 있습니다. 
DoorDash에서는 유연한 하이브리드 시스템이 우리의 요구를 가장 잘 충족한다고 생각합니다. 
키워드 기반 검색 시스템과 강력한 문서 및 키워드 이해를 결합하여 비건 항목만 검색되도록 하는 것과 같은 규칙을 효과적으로 적용할 수 있습니다. 
여기서는 대규모 언어 모델(LLM)을 사용하여 검색 시스템을 개선하고 소비자에게 더 정확한 검색 결과를 제공한 방법을 자세히 설명하겠습니다.

# 요약
이 중 마지막 결과만 사용자의 의도와 정확히 일치합니다. 
하지만 사용자의 선호도는 속성에 따라 다를 수 있습니다. 
예를 들어, 소비자는 비건 샌드위치를 대체 옵션으로 고려할 수 있지만, 비건이 아닌 치킨 샌드위치는 거부할 수 있습니다. 
식이 제한은 단백질 선택과 같은 다른 속성보다 우선하는 경우가 많습니다.

DoorDash는 유연한 하이브리드 시스템이 요구사항을 충족할 가능성이 가장 높다고 판단했습니다. 
키워드 기반 검색 시스템과 강력한 문서 및 키워드 이해를 결합하여 비건 항목만 검색되도록 하는 규칙을 효과적으로 적용할 수 있습니다. 
본문에서는 DoorDash가 대규모 언어 모델(LLM)을 활용하여 검색 시스템을 개선하고 소비자에게 더욱 정확한 검색 결과를 제공하는 방법을 자세히 설명합니다.

# Reflection Agent
reflection:  [
    'LLM이 문서 및 키워드를 이해하는 데 어떻게 사용되는지에 대한 설명이 부족합니다. \
    LLM의 역할과 작동 방식에 대한 자세한 설명이 필요합니다. \
    또한, 검색 시스템의 성능을 평가하는 데 사용되는 지표에 대한 정보가 없습니다.', 
    
    "더 구체적인 예시를 들어주세요. \
    예를 들어, LLM이 키워드 기반 검색 시스템과 어떻게 결합되어 작동하는지 설명해주세요. \
    또한, '비건' 필터링 규칙 외에 어떤 규칙들이 적용될 수 있는지 예시를 들어주시면 이해도를 높이는 데 도움이 될 것입니다."
]
이 목록에서 사용자 의도와 가장 정확히 일치하는 항목은 마지막 "비건 치킨 샌드위치"뿐입니다. 
사용자 선호도는 속성에 따라 우선순위가 달라질 수 있는데, 예를 들어 식이 제한은 단백질 선택과 같은 다른 속성보다 더 중요하게 여겨집니다. 
따라서, 사용자에게 가장 관련성이 높은 결과만을 표시하는 것은 중요한 과제입니다. 
DoorDash는 유연한 하이브리드 시스템이 이러한 요구 사항을 충족하는 데 가장 적합하다고 판단했습니다.

DoorDash는 키워드 기반 검색 시스템과 강력한 문서 및 키워드 이해 능력을 결합하여 사용자에게 더욱 정확한 검색 결과를 제공하고자 대규모 언어 모델(LLM)을 적극적으로 활용하고 있습니다. 
LLM은 키워드 기반 검색 시스템의 약점을 보완하고, 검색어의 의미를 더 깊이 이해하여 사용자 의도에 부합하는 결과를 제공하는 데 핵심적인 역할을 수행합니다.

구체적으로, LLM은 다음과 같은 방식으로 활용됩니다. 
첫째, LLM은 검색어와 상품 설명을 분석하여 핵심 속성들을 추출합니다. 
예를 들어, "글루텐 프리 피자"라는 검색어에서 "글루텐 프리"라는 식이 제한 속성과 "피자"라는 상품 종류 속성을 추출할 수 있습니다. 
둘째, LLM은 추출된 속성들을 기반으로 필터링 규칙을 적용합니다. 
예를 들어, 위에서 언급한 "비건" 필터링 규칙 외에도 "매운맛" 필터링 규칙, "알레르기 유발 물질 제외" 규칙 등을 적용하여 사용자의 특정 요구 사항을 충족하는 결과를 제공할 수 있습니다. 
셋째, LLM은 상품 설명의 의미를 분석하여 키워드 기반 검색 시스템이 놓칠 수 있는 관련 상품을 찾아냅니다. 
예를 들어, "수제 버거"를 검색했을 때, "장인이 만든 패티를 사용한 프리미엄 버거"와 같이 유사한 의미를 가진 상품도 검색 결과에 포함될 수 있도록 합니다.

DoorDash는 검색 시스템의 성능을 평가하기 위해 다양한 지표를 사용합니다. 
예를 들어, 클릭률(CTR), 검색 결과의 전환율, 사용자 만족도 조사 등을 통해 검색 결과의 관련성과 정확성을 측정합니다. 
또한, AB 테스트를 통해 LLM 기반 시스템의 성능을 기존 시스템과 비교하여 개선 효과를 지속적으로 검증하고 있습니다. 
이러한 노력을 통해 DoorDash는 사용자에게 더욱 만족스러운 검색 경험을 제공하고자 끊임없이 노력하고 있습니다.
</code></pre></div></div>

<p>번역, 요약과 달리 Reflection Agent의 구성 방식이 다른 것을 볼 수 있는데 LLM의 답변에 대해 더 나은 답변을 위한 비판을 제공하여 비판을 근거로한 답변을 재생성하는 방법입니다.</p>

<p>개인적으로 요약 태스크는 외부 검색을 사용하지 않는 것이 나은 결과물을 보여주는 것 같습니다. 왜냐하면 외부 정보가 계속 주입되면 글이 너무 길어지는 경우가 많이 발생했습니다. 
무언가 설명이 필요한 경우(예를 들면, “Langgraph에 대해 설명해줘”)에 검색이라는 도구가 유용하다고 생각합니다.</p>

<h2 id="code">Code</h2>
<ul>
  <li><a href="https://github.com/emeraldgoose/simple-summarize-agent">simple-summarize-agent</a></li>
</ul>

<h2 id="reference">Reference</h2>
<ul>
  <li><a href="https://blog.langchain.dev/reflection-agents/">Reflection Agents</a></li>
  <li><a href="https://github.com/kyopark2014/writing-agent/blob/main/README.md">Writing Agent</a></li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#ai-agent" class="page__taxonomy-item p-category" rel="tag">ai-agent</a><span class="sep">, </span>
    
      <a href="/tags/#langgraph" class="page__taxonomy-item p-category" rel="tag">langgraph</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ai-agent" class="page__taxonomy-item p-category" rel="tag">ai-agent</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2025-03-14T00:00:00+09:00">March 14, 2025</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/data-engineer/simple-rag/" class="pagination--pager" title="RAG: Hybrid search + Reranker
">Previous</a>
    
    
      <a href="/pytorch/softmax-and-crossentropyloss/" class="pagination--pager" title="Python으로 Softmax와 CrossEntropyLoss 바닥부터 구현하기
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ai-agent/vibe-coding-vs-augmented-coding/" rel="permalink">바이브 코딩과 증강 코딩(Vibe Coding &amp; Augmented Coding)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> August 19 2025</p>
    
    <p class="archive__item-excerpt" itemprop="description">Vibe Coding
바이브 코딩은 자연어 프롬프트를 이용해 AI가 코드를 작성하고 사용자는 작동 결과에 관심을 기울이는 형태의 프로그래밍(?) 방식입니다. 만약, 작동 결과가 사용자의 의도와 맞지 않다면, 피드백을 통해 AI가 코드를 수정하는 방식이며 이러한 방식은 프로토타입을 ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/data-engineer/spark-on-kubernetes/" rel="permalink">Spark on Kubernetes
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> July 27 2025</p>
    
    <p class="archive__item-excerpt" itemprop="description">Apache Spark
Spark는 대규모 데이터 처리를 위한 분석 엔진입니다. Java, Scala, Python 등의 언어를 지원하고 정형 데이터를 처리할 수 있는 SparkSQL, 머신러닝을 위한 MLlib, 스트리밍 처리를 위한 Spark Streaming 등을 포함한 많은...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pytorch/unet-and-ddpm-implementation/" rel="permalink">Python으로 Diffusion 바닥부터 구현하기[2] (im2col, UNet, DDPM)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> May 24 2025</p>
    
    <p class="archive__item-excerpt" itemprop="description">Objective
이전 글에서 UNet의 구성요소인 ResidualBlock, AttentionBlock, UpsampleBlock을 구현했습니다.

  Python으로 Diffusion 바닥부터 구현하기[1] (ResidualBlock, AttentionBlock, Upsampl...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pytorch/text-to-image-implementation/" rel="permalink">Python으로 Diffusion 바닥부터 구현하기[1] (ResidualBlock, AttentionBlock, UpsampleBlock)
</a>
      
    </h2>
    


    
      <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> May 20 2025</p>
    
    <p class="archive__item-excerpt" itemprop="description">Text-to-Image
최근 Stable Diffusion이라는 모델이 발전하면서 많은 사람들이 이미지 생성 AI를 사용하고 있습니다. Diffusion 모델은 노이즈를 기존 이미지에 더한 뒤에 노이즈를 예측하고 지워가며 복원하는 학습과정을 거치게 됩니다.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 emeraldgoose. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'emeraldgoose/emeraldgoose.github.io');
    script.setAttribute('issue-term', 'pathname');
    
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  




<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
  inlineMath: [['$','$']],
  displayMath: [['$$','$$']],
  processEscapes: true
  },
  "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

  </body>
</html>
